<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
<!-- 2021-06-24 Thu 14:27 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>High Performance Python</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="ChrisChen" />
<meta name="keywords" content="python, performance" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
	     margin-bottom: .2em; }
  .subtitle { text-align: center;
	      font-size: medium;
	      font-weight: bold;
	      margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
	    padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css">
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
	displayAlign: "left",
	displayIndent: "2em",

	"HTML-CSS": { scale: 100,
			linebreaks: { automatic: "false" },
			webFont: "TeX"
		       },
	SVG: {scale: 100,
	      linebreaks: { automatic: "false" },
	      font: "TeX"},
	NativeMML: {scale: 100},
	TeX: { equationNumbers: {autoNumber: "AMS"},
	       MultLineWidth: "85%",
	       TagSide: "left",
	       TagIndent: ".8em"
	     }
});
</script>
<script type="text/javascript"
	src="https://cdn.bootcdn.net/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">High Performance Python</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org5392558">1. Hardware Resources</a>
<ul>
<li><a href="#org2aa7c0b">1.1. Computing Unit</a></li>
<li><a href="#org173eae7">1.2. Memory Unit</a></li>
<li><a href="#orga557b09">1.3. Communications Layers</a></li>
<li><a href="#org2e52313">1.4. Performance Issues of Python</a></li>
<li><a href="#orge3ba622">1.5. GPU</a></li>
</ul>
</li>
<li><a href="#org2fecdba">2. Profiling</a>
<ul>
<li><a href="#orgf85aa16">2.1. Tools</a></li>
<li><a href="#orgecee3e0">2.2. Practical Points</a></li>
</ul>
</li>
<li><a href="#orgef284c6">3. Lists and Tuples</a>
<ul>
<li><a href="#org144986f">3.1. Lists</a></li>
<li><a href="#org15010ea">3.2. Tuples</a></li>
</ul>
</li>
<li><a href="#orgbf88063">4. Dictionaries and Sets</a>
<ul>
<li><a href="#orgef15e16">4.1. Hashable Type</a></li>
<li><a href="#org296677b">4.2. Key to Array Index</a></li>
<li><a href="#org7b2f393">4.3. Dictionary</a></li>
<li><a href="#org551615d">4.4. Namespace Management</a></li>
</ul>
</li>
<li><a href="#orgc3bf9f0">5. Iterators and Generators</a>
<ul>
<li><a href="#orgcda3df8">5.1. Iterator</a></li>
<li><a href="#org701da4f">5.2. Lazy Generator Evaluation</a></li>
<li><a href="#org40a0400">5.3. Useful Itertools</a></li>
</ul>
</li>
<li><a href="#org83a7d8c">6. Vectorization</a>
<ul>
<li><a href="#org32fdf5a">6.1. <code>array</code> module</a></li>
<li><a href="#org8211241">6.2. <code>numpy</code></a></li>
<li><a href="#orgad9bb64">6.3. <code>numexpr</code></a></li>
<li><a href="#orgd8ff14d">6.4. <code>pandas</code></a></li>
<li><a href="#org47de320">6.5. Summary</a></li>
</ul>
</li>
<li><a href="#org6b640e6">7. Compiling to Bytecode</a>
<ul>
<li><a href="#orgfee8f60">7.1. All Routes</a></li>
<li><a href="#orgf3ab71c">7.2. Cython</a></li>
<li><a href="#orgd4d7e75">7.3. PyPy</a></li>
<li><a href="#org04b2808">7.4. Transonic</a></li>
<li><a href="#org74e7660">7.5. CuPy</a></li>
<li><a href="#org5a9402b">7.6. Foreign Function Interfaces</a></li>
<li><a href="#orgef9374b">7.7. Other Tools</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org5392558" class="outline-2">
<h2 id="org5392558"><span class="section-number-2">1.</span> Hardware Resources</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org2aa7c0b" class="outline-3">
<h3 id="org2aa7c0b"><span class="section-number-3">1.1.</span> Computing Unit</h3>
<div class="outline-text-3" id="text-1-1">
<p>
The main properties of interest in a computing unit are the number of operations
it can do in one cycle and the number of cycles it can do in one second. The first
value is measured by its instructions per cycle(IPC), while the latter value is
measured by its clock speed.
</p>
<ul class="org-ul">
<li><b>SIMD</b>: Single instruction, multiple data. Efficient with high IPC. (CPU vectorization instruction)</li>
<li><b>Hyperthreading</b> presents a virtual second CPU to the host OS, and clever hardware logic tries</li>
</ul>
<p>
to interleave two threads of instructions into the execution units on a single CPU. When successful,
gains of up to 30% over a single thread can be achieved.
</p>
</div>
</div>

<div id="outline-container-org173eae7" class="outline-3">
<h3 id="org173eae7"><span class="section-number-3">1.2.</span> Memory Unit</h3>
<div class="outline-text-3" id="text-1-2">
<p>
When trying to optimize the memory patterns of a program, we are simply optimizing
which data is placed where, how it is laid out (in order to increase the number of
sequential reads), and how many times it is moved among the various locations.
</p>
</div>
</div>

<div id="outline-container-orga557b09" class="outline-3">
<h3 id="orga557b09"><span class="section-number-3">1.3.</span> Communications Layers</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>The <i>frontside</i> bus is the connection between the RAM and the L1/L2 cache</li>
<li>Two main properties of a bus:
<ul class="org-ul">
<li>how much data can be moved in one transfer (bus width)</li>
<li>how many transfers the bus can do per second (bus frequency).</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org2e52313" class="outline-3">
<h3 id="org2e52313"><span class="section-number-3">1.4.</span> Performance Issues of Python</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>Memory Fragmentation: due to garbage-collected</li>
<li>Dynamic Types: Using Cython to mitigate this problem</li>
<li>GIL: Using Cython or foreign functions</li>
</ul>
</div>
</div>
<div id="outline-container-orge3ba622" class="outline-3">
<h3 id="orge3ba622"><span class="section-number-3">1.5.</span> GPU</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>When to use: The task requires mainly linear algebra and matrix manipulations.
<ol class="org-ol">
<li>Ensure that the memory use of the problem will fit within the GPU.</li>
<li>Evaluate whether the algorithm requires a lot of branching conditions.(GPU's memory is limited)</li>
<li>Evaluate how much data needs to be moved between the GPU and the CPU.</li>
</ol></li>
<li>Drawbacks: Communicates through the PCI bus, which is much slower than the frontside bus</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org2fecdba" class="outline-2">
<h2 id="org2fecdba"><span class="section-number-2">2.</span> Profiling</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgf85aa16" class="outline-3">
<h3 id="orgf85aa16"><span class="section-number-3">2.1.</span> Tools</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-org4ba26e3" class="outline-4">
<h4 id="org4ba26e3"><span class="section-number-4">2.1.1.</span> <code>/usr/bin/time</code></h4>
<div class="outline-text-4" id="text-2-1-1">
<ul class="org-ul">
<li>Using <code>--verbose</code> flag to get more details.</li>
<li>Most useful indicator is <code>Major (requiring I/O) page faults</code>, as it indicates cache misses.</li>
</ul>
</div>
</div>
<div id="outline-container-orgcb495e9" class="outline-4">
<h4 id="orgcb495e9"><span class="section-number-4">2.1.2.</span> <code>timefn</code> decorator</h4>
<div class="outline-text-4" id="text-2-1-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">timefn</span><span style="color: #3a81c3;">(</span>fn<span style="color: #3a81c3;">)</span>:
    <span style="color: #ba2f59; font-weight: bold;">@wraps</span><span style="color: #3a81c3;">(</span>fn<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">measure_time</span><span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">t1</span> = time.time<span style="color: #3a81c3;">()</span>
	<span style="color: #715ab1;">result</span> = fn<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>
	<span style="color: #715ab1;">t2</span> = time.time<span style="color: #3a81c3;">()</span>
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>f<span style="color: #2d9574;">"@timefn: {fn.__name__} took {t2 - t1} seconds"</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> result
    <span style="color: #3a81c3; font-weight: bold;">return</span> measure_time
</pre>
</div>
</div>
</div>

<div id="outline-container-org477c8fe" class="outline-4">
<h4 id="org477c8fe"><span class="section-number-4">2.1.3.</span> bulit-in <code>timeit</code> module</h4>
<div class="outline-text-4" id="text-2-1-3">
<ul class="org-ul">
<li><a href="https://docs.python.org/3/library/timeit.html">Documentation</a></li>
<li>The <code>timeit</code> module temporarily disables the garbage collector.</li>
<li>More useful approach: IPython magic <code>%timeit</code></li>
</ul>
</div>
</div>

<div id="outline-container-org8749aaf" class="outline-4">
<h4 id="org8749aaf"><span class="section-number-4">2.1.4.</span> CProfile</h4>
<div class="outline-text-4" id="text-2-1-4">
<div class="org-src-container">
<pre class="src src-sh">python -m cProfile -s cumulative test.py
python -m cProfile -o profile.stats test.py
</pre>
</div>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> pstats
<span style="color: #715ab1;">p</span> = pstats.Stats<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"profile.stats"</span><span style="color: #3a81c3;">)</span>
p.sort_stats<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"cumulative"</span><span style="color: #3a81c3;">)</span>
p.print_stats<span style="color: #3a81c3;">()</span>
p.print_callers<span style="color: #3a81c3;">()</span>
p.print_callees<span style="color: #3a81c3;">()</span>
</pre>
</div>
<ul class="org-ul">
<li><code>snakeviz</code> for visualization</li>
<li>alternative <code>pyinstrument</code>: lower overhead and less trivial information</li>
</ul>
</div>
</div>

<div id="outline-container-org3d248d6" class="outline-4">
<h4 id="org3d248d6"><span class="section-number-4">2.1.5.</span> <code>line_profiler</code></h4>
<div class="outline-text-4" id="text-2-1-5">
<ol class="org-ol">
<li><code>pip install line_profiler</code></li>
<li>Use <code>@profile</code> to mark the chosen function</li>
<li><code>kernprof -l -v test.py</code></li>
<li>See report: <code>python -m line_profiler test.py.lprof</code></li>
</ol>
</div>

<ul class="org-ul">
<li><a id="orgff405b0"></a>Object Interface<br />
<div class="outline-text-5" id="text-orgff405b0">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> line_profiler <span style="color: #3a81c3; font-weight: bold;">import</span> LineProfiler

<span style="color: #715ab1;">lp</span> = LineProfiler<span style="color: #3a81c3;">(</span>some_func<span style="color: #3a81c3;">)</span>
lp.run<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"some_func(args)"</span><span style="color: #3a81c3;">)</span>
lp.print_stats<span style="color: #3a81c3;">()</span>
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgaf4aa6a" class="outline-4">
<h4 id="orgaf4aa6a"><span class="section-number-4">2.1.6.</span> <code>pyinstrument</code></h4>
</div>
<div id="outline-container-orgd0494af" class="outline-4">
<h4 id="orgd0494af"><span class="section-number-4">2.1.7.</span> <code>VizTracer</code></h4>
</div>
<div id="outline-container-org9357c8f" class="outline-4">
<h4 id="org9357c8f"><span class="section-number-4">2.1.8.</span> <code>memory_profiler</code></h4>
<div class="outline-text-4" id="text-2-1-8">
<ol class="org-ol">
<li><code>pip install psutil</code> (recommended)</li>
<li><code>pip install memory_profiler</code></li>
<li>Use <code>@profile</code> to mark the chosen function</li>
<li><code>python -m memory_profiler test.py</code> or <code>mprof run test.py</code></li>
</ol>

<p>
Other Hints:
</p>
<ul class="org-ul">
<li>using <code>with profile.timestamp("scope1")</code> to add label</li>
<li><code>memory_profiler</code> offers an interesting aid to debugging a large process via the <code>--pdb-mmem=XXX</code> flag</li>
</ul>
</div>
</div>

<div id="outline-container-orgbd76a32" class="outline-4">
<h4 id="orgbd76a32"><span class="section-number-4">2.1.9.</span> <code>perf</code></h4>
<div class="outline-text-4" id="text-2-1-9">
<ol class="org-ol">
<li><code>sudo apt install linux-tools-generic</code></li>
<li>Tweeking <code>/proc/sys/kernel/perf_event_paranoid</code> to -1</li>
<li><code>perf stat -e cycles,instructions,cache-references,cache-misses,... python test.py</code></li>
</ol>

<p>
Performance Counter Descriptions:
</p>
<ul class="org-ul">
<li><code>task-clock</code> tells us how many clock cycles our task. (all CPUs)</li>
<li>The difference between <code>instructions</code> and <code>cycles</code> gives us an indication of how well our code is vectorizing and pipelining.</li>
<li><code>cs</code>: context switches</li>
<li><code>migrations</code>: tell us about how the program is halted in order to wait for a kernel operation to finish (such as I/O).</li>
<li><code>migrations</code> happen when the program is halted and resumed on a different CPU than the one it was on before</li>
<li><code>faults</code>: page-fault.</li>
<li><code>cache-references</code> increases whenever we reference data that is in our cache(L1/L2/L3). If we do not already have this data in the cache and need to fetch it from RAM, this counts as a <code>cache-miss</code></li>
<li>A <code>branch</code> is a time in the code where the execution flow changes.</li>
<li><code>branch-misses</code>: the CPU tries to guess which direction the branch will take and preload the relevant instructions.</li>
<li><code>instructions per cycle</code> tells us the total speed boost from pipelining, out-of-order execution, and hyperthreading.</li>
<li>run <code>perf list</code> to get the list of currently supported metrics on your system</li>
</ul>

<p>
Terms:
</p>

<dl class="org-dl">
<dt><b>Pipelining</b></dt><dd>With pipelining, the CPU is able to run the current operation while fetching and preparing the next one. When memory is allocated, the kernel doesn’t do much except give the program a reference to memory.</dd>
<dt><b>Minor Page Fault Interrupt</b></dt><dd>When memory is allocated, the kernel doesn’t do much except give the program a reference to memory. Later, however, when the memory is first used, the operating system throws a minor page fault interrupt, which pauses the program that is being run and properly allocates the memory. This is called a <i>lazy allocation system</i>.</dd>
<dt><b>Major Page Fault</b></dt><dd>which happens when the program requests data from a device (disk, network, etc.) that hasn’t been read yet.</dd>
</dl>
</div>
</div>

<div id="outline-container-org1845549" class="outline-4">
<h4 id="org1845549"><span class="section-number-4">2.1.10.</span> ipython magic <code>%memit</code></h4>
<div class="outline-text-4" id="text-2-1-10">
<ul class="org-ul">
<li><code>%load_ext memory_profiler</code></li>
</ul>
</div>
</div>
<div id="outline-container-org8c0bfe4" class="outline-4">
<h4 id="org8c0bfe4"><span class="section-number-4">2.1.11.</span> ipython <code>%%timeit</code></h4>
<div class="outline-text-4" id="text-2-1-11">
<p>
Allows us to specify code to set up the experiment that doesn't get timed.
</p>
<div class="org-src-container">
<pre class="src src-python">%%timeit <span style="color: #715ab1;">array1</span>, <span style="color: #715ab1;">array2</span> = np.random.random<span style="color: #3a81c3;">(</span><span style="color: #6c3163;">(</span>2, 100, 100<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
<span style="color: #715ab1;">array1</span> = array1 + array2
</pre>
</div>
</div>
</div>

<div id="outline-container-org76da794" class="outline-4">
<h4 id="org76da794"><span class="section-number-4">2.1.12.</span> No-op @profile</h4>
<div class="outline-text-4" id="text-2-1-12">
<p>
Add it to the start of our module while unit testing
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">'line_profiler'</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">dir</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3; font-weight: bold;">and</span> <span style="color: #2d9574;">'profile'</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">dir</span><span style="color: #3a81c3;">()</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">profile</span><span style="color: #3a81c3;">(</span>func<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">return</span> func
</pre>
</div>
</div>
</div>

<div id="outline-container-org83aad13" class="outline-4">
<h4 id="org83aad13"><span class="section-number-4">2.1.13.</span> Introspecting an Existing Process with <code>PySpy</code></h4>
<div class="outline-text-4" id="text-2-1-13">
<ul class="org-ul">
<li><code>pip install py-spy</code></li>
<li><code>sudo py-spy top --pid 2046</code>: top-like view.</li>
<li><code>py-spy record -o profile.svg python test.py</code></li>
</ul>
</div>
</div>

<div id="outline-container-org38d52cd" class="outline-4">
<h4 id="org38d52cd"><span class="section-number-4">2.1.14.</span> Bytecode: <code>dis</code> module</h4>
<div class="outline-text-4" id="text-2-1-14">
<p>
<code>dis.dis(func)</code>
</p>
</div>
</div>
<div id="outline-container-org553cd06" class="outline-4">
<h4 id="org553cd06"><span class="section-number-4">2.1.15.</span> <code>vmperf</code></h4>
<div class="outline-text-4" id="text-2-1-15">
<p>
vmperf is a lightweight sampling profiler supports a web-based user interface.
</p>
<ol class="org-ol">
<li><code>sudo apt install libunwind-dev</code></li>
<li><code>pip install vmprof</code></li>
<li><code>python -m vmprof &lt;your program&gt; &lt;your program args&gt;</code></li>
</ol>
</div>
</div>
<div id="outline-container-orge09dc1a" class="outline-4">
<h4 id="orge09dc1a"><span class="section-number-4">2.1.16.</span> GPU profiling</h4>
<div class="outline-text-4" id="text-2-1-16">
<ul class="org-ul">
<li><code>nvidia-smi</code></li>
<li><code>gpustat</code></li>
</ul>
</div>
</div>

<div id="outline-container-org4060e12" class="outline-4">
<h4 id="org4060e12"><span class="section-number-4">2.1.17.</span> Pytorch profiling</h4>
<div class="outline-text-4" id="text-2-1-17">
<p>
<code>python -m torch.utils.bottleneck test.py</code>
</p>
</div>
</div>

<div id="outline-container-org60677d5" class="outline-4">
<h4 id="org60677d5"><span class="section-number-4">2.1.18.</span> For Web Servers</h4>
<div class="outline-text-4" id="text-2-1-18">
<ul class="org-ul">
<li><code>dowser</code></li>
<li><code>dozer</code></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgecee3e0" class="outline-3">
<h3 id="orgecee3e0"><span class="section-number-3">2.2.</span> Practical Points</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>Disable Turbo Boost in the BIOS.</li>
<li>Disable the operating system’s ability to override the SpeedStep(in BIOS).</li>
<li>Use only AC power (never battery power).</li>
<li>Disable background tools like backups and Dropbox while running experiments.</li>
<li>Run the experiments many times to obtain a stable measurement.</li>
<li>Possibly drop to run level 1 (Unix) so that no other tasks are running.</li>
<li>Reboot and rerun the experiments to double-confirm the results.</li>
<li>Unit testing a complicated section of code that generates a large numerical output may be</li>
</ul>
<p>
difficult. Do not be afraid to output a text file of results to run through <code>diff</code> or to use
a pickled object.
</p>
</div>
</div>
</div>

<div id="outline-container-orgef284c6" class="outline-2">
<h2 id="orgef284c6"><span class="section-number-2">3.</span> Lists and Tuples</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Python array stores data in buckets by reference, opposed to numpy arrays.</li>
</ul>
</div>

<div id="outline-container-org144986f" class="outline-3">
<h3 id="org144986f"><span class="section-number-3">3.1.</span> Lists</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>lists also store how large they are, so of the six allocated blocks, only five are usable.</li>
<li><code>bisect</code> gives easy methods to add elements into a list while maintaining its sorting</li>
<li>List pre-allocation equation in Python 3.7: <code>M = (N &gt;&gt; 3) + (3 if N &lt; 9 else 6)</code></li>
</ul>
</div>

<div id="outline-container-orgb244948" class="outline-4">
<h4 id="orgb244948"><span class="section-number-4">3.1.1.</span> Bulit-in Tim Sort</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
Python lists have a built-in sorting algorithm that uses <b>Tim sort</b>.
O(n) in the best case, <code>O(n log n)</code> in the worst case. It hybridizes
insertion and merge sort algorithms.
</p>
</div>
</div>
</div>

<div id="outline-container-org15010ea" class="outline-3">
<h3 id="org15010ea"><span class="section-number-3">3.2.</span> Tuples</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Python process will have some extra memory overhead for resource caching.
For tuples of sizes 1–20, however, when they are no longer in use, the space isn't
immediately given back to the system, which reduced system calls for memory allocation.
</p>
<div class="org-src-container">
<pre class="src src-text">In [1]: %timeit l = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
62 ns &#177; 0.714 ns per loop (mean &#177; std. dev. of 7 runs, 10000000 loops each)

In [2]: %timeit t = (0, 1, 2, 3, 4, 5, 6, 7, 8, 9)
9.41 ns &#177; 0.113 ns per loop (mean &#177; std. dev. of 7 runs, 100000000 loops each)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbf88063" class="outline-2">
<h2 id="orgbf88063"><span class="section-number-2">4.</span> Dictionaries and Sets</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgef15e16" class="outline-3">
<h3 id="orgef15e16"><span class="section-number-3">4.1.</span> Hashable Type</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>should implement <code>__hash__</code>, <code>__eq__</code>, <code>__cmp_-</code></li>
<li>User-defined classes have default hash and comparison functions using the object's placement in memory.(given by <code>id</code> function)</li>
</ul>
</div>
</div>

<div id="outline-container-org296677b" class="outline-3">
<h3 id="org296677b"><span class="section-number-3">4.2.</span> Key to Array Index</h3>
<div class="outline-text-3" id="text-4-2">
<ol class="org-ol">
<li><b>hashing</b>: turn key into an integer number</li>
<li><b>masking</b>: fits the allocated number of buckets</li>
<li>Using <b>probing</b> to find a new place if collision happens</li>
</ol>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">pseudocode of finding index</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">index_sequence</span><span style="color: #3a81c3;">(</span>key, mask=0b111, PERTURB_SHIFT=5<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">perturb</span> = <span style="color: #3a81c3;">hash</span><span style="color: #3a81c3;">(</span>key<span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">hashing</span>
    <span style="color: #715ab1;">i</span> = perturb &amp; mask  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">masking</span>
    <span style="color: #3a81c3; font-weight: bold;">yield</span> i
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">probing</span>
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
	<span style="color: #715ab1;">perturb</span> &gt;&gt;= PERTURB_SHIFT  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">use high-order bits</span>
	<span style="color: #715ab1;">i</span> = <span style="color: #3a81c3;">(</span>i * 5 + perturb + 1<span style="color: #3a81c3;">)</span> &amp; mask  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">simple linear function and masking again</span>
	<span style="color: #3a81c3; font-weight: bold;">yield</span> i
</pre>
</div>
</div>

<div id="outline-container-orgcfea5ff" class="outline-4">
<h4 id="orgcfea5ff"><span class="section-number-4">4.2.1.</span> Finding a Element</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
If we hit an empty bucket, we can conclude that the data does not exist in the table.
</p>
</div>
</div>

<div id="outline-container-org6834a69" class="outline-4">
<h4 id="org6834a69"><span class="section-number-4">4.2.2.</span> Deleting a Element</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
We will write a special value that signifies that the bucket is empty, but there still
may be values after it to consider when resolving a hash collision. These empty slots can
be written to in the future and are removed when the hash table is resized.
</p>
</div>
</div>

<div id="outline-container-orgee1a520" class="outline-4">
<h4 id="orgee1a520"><span class="section-number-4">4.2.3.</span> Entropy of a Hash Function</h4>
<div class="outline-text-4" id="text-4-2-3">
<p>
\[S = -\sum_i p(i)\cdot\log(p(i))\]
</p>
<ul class="org-ul">
<li>\(p(i)\) is the probability that the hash function gives hash i</li>
<li>It is maximized when every hash value has equal probability of being chosen</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> math
<span style="color: #715ab1;">p1</span> = <span style="color: #3a81c3;">[</span>0.25, 0.25, 0.25, 0.25<span style="color: #3a81c3;">]</span>
-<span style="color: #3a81c3;">sum</span><span style="color: #3a81c3;">(</span>i * math.log<span style="color: #6c3163;">(</span>i<span style="color: #6c3163;">)</span> <span style="color: #3a81c3; font-weight: bold;">for</span> i <span style="color: #3a81c3; font-weight: bold;">in</span> p1<span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1.3862943611198906</span>

<span style="color: #715ab1;">p2</span> = <span style="color: #3a81c3;">[</span>0.1, 0.3, 0.5, 0.1<span style="color: #3a81c3;">]</span>
-<span style="color: #3a81c3;">sum</span><span style="color: #3a81c3;">(</span>i * math.log<span style="color: #6c3163;">(</span>i<span style="color: #6c3163;">)</span> <span style="color: #3a81c3; font-weight: bold;">for</span> i <span style="color: #3a81c3; font-weight: bold;">in</span> p2<span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1.1682824501765625</span>
</pre>
</div>
<ul class="org-ul">
<li>Knowing up front <b>what range of values will be used</b> and <b>how large the dictionary will be</b> helps in making a good selection</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org7b2f393" class="outline-3">
<h3 id="org7b2f393"><span class="section-number-3">4.3.</span> Dictionary</h3>
<div class="outline-text-3" id="text-4-3">
<ul class="org-ul">
<li>Optimization: Python first appends the key/value data into a standard array and</li>
</ul>
<p>
then stores only the index into this array in the hash table. The array also helps
keep the insertion order of items.
</p>
<ul class="org-ul">
<li>How well distributed the data is throughout the hash table is called the <b>load factor</b> and is related to the <b>entropy</b> of the hash function</li>
<li>By default, the smallest size of a dictionary or set is 8, and it will resize by 3x if the dictionary is more than two-thirds full. (possible sizes: 8-&gt;18-&gt;39-&gt;81-&gt;165-&gt;&#x2026;)</li>
</ul>
</div>
</div>

<div id="outline-container-org551615d" class="outline-3">
<h3 id="org551615d"><span class="section-number-3">4.4.</span> Namespace Management</h3>
<div class="outline-text-3" id="text-4-4">
<ul class="org-ul">
<li><b>Namespace Management</b> heavily uses dictionaries to do its lookups.</li>
</ul>

<p>
The steps to look for a variable/function/module
</p>

<ol class="org-ol">
<li>Searching <code>locals()</code>: which has entries for all local variables, and this is the only part of the chain that doesn't require a dictionary lookup</li>
<li>Searching <code>globals()</code></li>
<li>Searching <code>__builtin__</code> objects: <code>__builtin__</code> is technically a module object</li>
</ol>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> math


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">test1</span><span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>:
    <span style="color: #da8b55;">"""</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; %timeit test1(123456)</span>
<span style="color: #da8b55;">    94 &#181;s &#177; 387 ns per loop (mean &#177; std. dev. of 7 runs, 10000 loops each)</span>

<span style="color: #da8b55;">    18 LOAD_GLOBAL              1 (math)</span>
<span style="color: #da8b55;">    20 LOAD_METHOD              2 (sin)</span>
<span style="color: #da8b55;">    22 LOAD_FAST                0 (x)</span>
<span style="color: #da8b55;">    24 CALL_METHOD              1</span>

<span style="color: #da8b55;">    """</span>
    <span style="color: #715ab1;">res</span> = 1
    <span style="color: #3a81c3; font-weight: bold;">for</span> _ <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">range</span><span style="color: #3a81c3;">(</span>1000<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">res</span> += math.sin<span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> res


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">test2</span><span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>:
    <span style="color: #da8b55;">"""</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; %timeit test2(123456)</span>
<span style="color: #da8b55;">    72.5 &#181;s &#177; 2.66 &#181;s per loop (mean &#177; std. dev. of 7 runs, 10000 loops each)</span>

<span style="color: #da8b55;">    22 LOAD_FAST                2 (res)</span>
<span style="color: #da8b55;">    24 LOAD_FAST                1 (sin)</span>
<span style="color: #da8b55;">    26 LOAD_FAST                0 (x)</span>
<span style="color: #da8b55;">    28 CALL_FUNCTION            1</span>

<span style="color: #da8b55;">    """</span>
    <span style="color: #715ab1;">sin</span> = math.sin
    <span style="color: #715ab1;">res</span> = 1
    <span style="color: #3a81c3; font-weight: bold;">for</span> _ <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">range</span><span style="color: #3a81c3;">(</span>1000<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">res</span> += sin<span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> res
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc3bf9f0" class="outline-2">
<h2 id="orgc3bf9f0"><span class="section-number-2">5.</span> Iterators and Generators</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orgcda3df8" class="outline-3">
<h3 id="orgcda3df8"><span class="section-number-3">5.1.</span> Iterator</h3>
<div class="outline-text-3" id="text-5-1">
<ol class="org-ol">
<li>first, get an iterator through <code>iter(iterable)</code></li>
<li>call <code>iterator.next()</code> to get new values until a <code>StopIteration</code> is raised.</li>
</ol>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The Python loop</span>
<span style="color: #3a81c3; font-weight: bold;">for</span> i <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">object</span>:
    do_work<span style="color: #3a81c3;">(</span>i<span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Is equivalent to</span>
<span style="color: #715ab1;">object_iterator</span> = <span style="color: #3a81c3;">iter</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">object</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
    <span style="color: #3a81c3; font-weight: bold;">try</span>:
	<span style="color: #715ab1;">i</span> = <span style="color: #3a81c3;">next</span><span style="color: #3a81c3;">(</span>object_iterator<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">StopIteration</span>:
	<span style="color: #3a81c3; font-weight: bold;">break</span>
    <span style="color: #3a81c3; font-weight: bold;">else</span>:
	do_work<span style="color: #3a81c3;">(</span>i<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org701da4f" class="outline-3">
<h3 id="org701da4f"><span class="section-number-3">5.2.</span> Lazy Generator Evaluation</h3>
<div class="outline-text-3" id="text-5-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> datetime <span style="color: #3a81c3; font-weight: bold;">import</span> datetime
<span style="color: #3a81c3; font-weight: bold;">from</span> itertools <span style="color: #3a81c3; font-weight: bold;">import</span> count, filterfalse, groupby, islice
<span style="color: #3a81c3; font-weight: bold;">from</span> random <span style="color: #3a81c3; font-weight: bold;">import</span> normalvariate, randint
<span style="color: #3a81c3; font-weight: bold;">from</span> typing <span style="color: #3a81c3; font-weight: bold;">import</span> Generator, Iterable, List, Tuple

<span style="color: #3a81c3; font-weight: bold;">from</span> scipy.stats <span style="color: #3a81c3; font-weight: bold;">import</span> normaltest

<span style="color: #715ab1;">_ENTRY_TYPE</span> = Tuple<span style="color: #3a81c3;">[</span>datetime, <span style="color: #3a81c3;">int</span><span style="color: #3a81c3;">]</span>


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">read_fake_data</span><span style="color: #3a81c3;">(</span>filename: <span style="color: #3a81c3;">str</span> = <span style="color: #2d9574;">"fake"</span><span style="color: #3a81c3;">)</span> -&gt; Generator<span style="color: #3a81c3;">[</span>_ENTRY_TYPE, <span style="color: #4e3163;">None</span>, <span style="color: #4e3163;">None</span><span style="color: #3a81c3;">]</span>:
    <span style="color: #3a81c3; font-weight: bold;">for</span> timestamp <span style="color: #3a81c3; font-weight: bold;">in</span> count<span style="color: #3a81c3;">()</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> randint<span style="color: #3a81c3;">(</span>0, 7 * 60 * 60 * 24 - 1<span style="color: #3a81c3;">)</span> == 1:
	    <span style="color: #715ab1;">value</span> = normalvariate<span style="color: #3a81c3;">(</span>0, 1<span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">else</span>:
	    <span style="color: #715ab1;">value</span> = 100
	    <span style="color: #3a81c3; font-weight: bold;">yield</span> datetime.fromtimestamp<span style="color: #3a81c3;">(</span>timestamp<span style="color: #3a81c3;">)</span>, value


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">groupby_day</span><span style="color: #3a81c3;">(</span>iterable: Iterable<span style="color: #6c3163;">[</span>_ENTRY_TYPE<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span> -&gt; Generator<span style="color: #3a81c3;">[</span>List<span style="color: #6c3163;">[</span>_ENTRY_TYPE<span style="color: #6c3163;">]</span>, <span style="color: #4e3163;">None</span>, <span style="color: #4e3163;">None</span><span style="color: #3a81c3;">]</span>:
    <span style="color: #3a81c3; font-weight: bold;">for</span> day, data_group <span style="color: #3a81c3; font-weight: bold;">in</span> groupby<span style="color: #3a81c3;">(</span>iterable, <span style="color: #3a81c3; font-weight: bold;">lambda</span> row: row<span style="color: #6c3163;">[</span>0<span style="color: #6c3163;">]</span>.day<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">yield</span> <span style="color: #3a81c3;">list</span><span style="color: #3a81c3;">(</span>data_group<span style="color: #3a81c3;">)</span>


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">is_normal</span><span style="color: #3a81c3;">(</span>data: List<span style="color: #6c3163;">[</span>_ENTRY_TYPE<span style="color: #6c3163;">]</span>, threshold: <span style="color: #3a81c3;">float</span> = 1e-3<span style="color: #3a81c3;">)</span> -&gt; <span style="color: #3a81c3;">bool</span>:
    <span style="color: #715ab1;">_</span>, <span style="color: #715ab1;">values</span> = <span style="color: #3a81c3;">zip</span><span style="color: #3a81c3;">(</span>*data<span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">k2</span>, <span style="color: #715ab1;">p_value</span> = normaltest<span style="color: #3a81c3;">(</span>values<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> p_value &lt; threshold:
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">False</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">True</span>


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">filter_anomalous_groups</span><span style="color: #3a81c3;">(</span>
    data: Iterable<span style="color: #6c3163;">[</span>_ENTRY_TYPE<span style="color: #6c3163;">]</span>,
<span style="color: #3a81c3;">)</span> -&gt; Generator<span style="color: #3a81c3;">[</span>List<span style="color: #6c3163;">[</span>_ENTRY_TYPE<span style="color: #6c3163;">]</span>, <span style="color: #4e3163;">None</span>, <span style="color: #4e3163;">None</span><span style="color: #3a81c3;">]</span>:
    <span style="color: #3a81c3; font-weight: bold;">yield</span> <span style="color: #3a81c3; font-weight: bold;">from</span> filterfalse<span style="color: #3a81c3;">(</span>is_normal, data<span style="color: #3a81c3;">)</span>


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">filter_anomalous_data</span><span style="color: #3a81c3;">(</span>data: Iterable<span style="color: #6c3163;">[</span>_ENTRY_TYPE<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span> -&gt; Generator<span style="color: #3a81c3;">[</span>List<span style="color: #6c3163;">[</span>_ENTRY_TYPE<span style="color: #6c3163;">]</span>, <span style="color: #4e3163;">None</span>, <span style="color: #4e3163;">None</span><span style="color: #3a81c3;">]</span>:
    <span style="color: #715ab1;">data_group</span> = groupby_day<span style="color: #3a81c3;">(</span>data<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">yield</span> <span style="color: #3a81c3; font-weight: bold;">from</span> filter_anomalous_groups<span style="color: #3a81c3;">(</span>data_group<span style="color: #3a81c3;">)</span>


<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">__name__</span> == <span style="color: #2d9574;">"__main__"</span>:
    <span style="color: #715ab1;">data</span> = read_fake_data<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"fake"</span><span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">anomaly_generator</span> = filter_anomalous_data<span style="color: #3a81c3;">(</span>data<span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">first_five_anomalies</span> = islice<span style="color: #3a81c3;">(</span>anomaly_generator, 5<span style="color: #3a81c3;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">for</span> data_anomaly <span style="color: #3a81c3; font-weight: bold;">in</span> first_five_anomalies:
	<span style="color: #715ab1;">start_date</span> = data_anomaly<span style="color: #3a81c3;">[</span>0<span style="color: #3a81c3;">][</span>0<span style="color: #3a81c3;">]</span>
	<span style="color: #715ab1;">end_date</span> = data_anomaly<span style="color: #3a81c3;">[</span>-1<span style="color: #3a81c3;">][</span>0<span style="color: #3a81c3;">]</span>
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>f<span style="color: #2d9574;">"Anomaly from {start_date} - {end_date}"</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org40a0400" class="outline-3">
<h3 id="org40a0400"><span class="section-number-3">5.3.</span> Useful Itertools</h3>
<div class="outline-text-3" id="text-5-3">
<ul class="org-ul">
<li><code>cycle</code>, <code>repeat</code>, <code>chain</code>, <code>groupby</code>, <code>islice</code></li>
<li><code>compress</code>: like boolean-index in pandas</li>
<li><code>accumulate</code>: reduce though summation</li>
<li><code>takewhile</code>, <code>dropwhile</code>: add a condition that will end a generator.</li>
<li><code>starmap</code>: Used instead of <code>map()</code> when argument parameters are already grouped in tuples from a single iterable</li>
<li><code>tee(iterable, n)</code>: Return n independent iterators from a single iterable. Useful for splitting one generator into n generators.</li>
<li><code>zip_longest</code>: <code>zip_longest('ABCD', 'xy', fillvalue='-') --&gt; Ax By C- D-</code></li>
<li>Combinatoric iterators: <code>product</code> (cartesian product), <code>permutations</code>, <code>combinations</code></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org83a7d8c" class="outline-2">
<h2 id="org83a7d8c"><span class="section-number-2">6.</span> Vectorization</h2>
<div class="outline-text-2" id="text-6">
<p>
Vectorization is the process of converting an algorithm from operating on a single value at a time to
operating on a set of values at one time. Vectorization of computations can occur only if we can fill
the CPU cache with all the relevant data. Modern CPUs provide direct support for vector operations where
a single instruction is applied to multiple data(SIMD). Python doesn't natively support vectorization for
two reasons:
</p>
<ul class="org-ul">
<li>Python lists store pointers to the actual data.</li>
<li>Python bytecode is not optimized for vectorization. (raw machine code uses nonvectorized operations)</li>
</ul>
</div>

<div id="outline-container-org32fdf5a" class="outline-3">
<h3 id="org32fdf5a"><span class="section-number-3">6.1.</span> <code>array</code> module</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Objects in array are sequentially in memory. Using the array type when creating lists of
data that must be iterated on is actually slower than simply creating a list. This is because
the array object stores a very low-level representation of the numbers it stores, and this must
be converted into a Python-compatible version before being returned to the user. This extra
overhead happens every time you index an array type. That implementation decision has made
the array object less suitable for math and more suitable for storing fixed-type data more
efficiently in memory.
</p>
</div>
</div>

<div id="outline-container-org8211241" class="outline-3">
<h3 id="org8211241"><span class="section-number-3">6.2.</span> <code>numpy</code></h3>
<div class="outline-text-3" id="text-6-2">
<ul class="org-ul">
<li><code>numpy</code> gives us memory locality and vectorized operations.</li>
</ul>
</div>

<div id="outline-container-orgb55fd07" class="outline-4">
<h4 id="orgb55fd07"><span class="section-number-4">6.2.1.</span> Comparison with Built-in Module</h4>
<div class="outline-text-4" id="text-6-2-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> array <span style="color: #3a81c3; font-weight: bold;">import</span> array
<span style="color: #3a81c3; font-weight: bold;">import</span> numpy

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">norm_square_list</span><span style="color: #3a81c3;">(</span>vector<span style="color: #3a81c3;">)</span>:
    <span style="color: #da8b55;">"""</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; vector = list(range(1_000_000))</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; %timeit norm_square_list(vector)</span>
<span style="color: #da8b55;">    85.5 ms &#177; 1.65 ms per loop (mean &#177; std. dev. of 7 runs, 10 loops each)</span>
<span style="color: #da8b55;">    """</span>
    <span style="color: #715ab1;">norm</span> = 0
    <span style="color: #3a81c3; font-weight: bold;">for</span> v <span style="color: #3a81c3; font-weight: bold;">in</span> vector:
	<span style="color: #715ab1;">norm</span> += v * v
    <span style="color: #3a81c3; font-weight: bold;">return</span> norm

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">norm_square_list_comprehension</span><span style="color: #3a81c3;">(</span>vector<span style="color: #3a81c3;">)</span>:
    <span style="color: #da8b55;">"""</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; vector = list(range(1_000_000))</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; %timeit norm_square_list_comprehension(vector)</span>
<span style="color: #da8b55;">    80.3 ms &#177; 1.37 ms per loop (mean &#177; std. dev. of 7 runs, 10 loops each)</span>
<span style="color: #da8b55;">    """</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">sum</span><span style="color: #3a81c3;">(</span><span style="color: #6c3163;">[</span>v * v <span style="color: #3a81c3; font-weight: bold;">for</span> v <span style="color: #3a81c3; font-weight: bold;">in</span> vector<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">norm_square_array</span><span style="color: #3a81c3;">(</span>vector<span style="color: #3a81c3;">)</span>:
    <span style="color: #da8b55;">"""</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; vector_array = array('l', range(1_000_000))</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; %timeit norm_square_array(vector_array)</span>
<span style="color: #da8b55;">    101 ms &#177; 4.69 ms per loop (mean &#177; std. dev. of 7 runs, 10 loops each)</span>
<span style="color: #da8b55;">    """</span>
    <span style="color: #715ab1;">norm</span> = 0
    <span style="color: #3a81c3; font-weight: bold;">for</span> v <span style="color: #3a81c3; font-weight: bold;">in</span> vector:
	<span style="color: #715ab1;">norm</span> += v * v
    <span style="color: #3a81c3; font-weight: bold;">return</span> norm

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">norm_square_numpy</span><span style="color: #3a81c3;">(</span>vector<span style="color: #3a81c3;">)</span>:
    <span style="color: #da8b55;">"""</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; vector_np = numpy.arange(1_000_000)</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; %timeit norm_square_numpy(vector_np)</span>
<span style="color: #da8b55;">    3.22 ms &#177; 136 &#181;s per loop (mean &#177; std. dev. of 7 runs, 100 loops each)</span>
<span style="color: #da8b55;">    """</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> numpy.<span style="color: #3a81c3;">sum</span><span style="color: #3a81c3;">(</span>vector * vector<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">norm_square_numpy_dot</span><span style="color: #3a81c3;">(</span>vector<span style="color: #3a81c3;">)</span>:
    <span style="color: #da8b55;">"""</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; vector_np = numpy.arange(1_000_000)</span>
<span style="color: #da8b55;">    &gt;&gt;&gt; %timeit norm_square_numpy_dot(vector_np)</span>
<span style="color: #da8b55;">    960 &#181;s &#177; 41.1 &#181;s per loop (mean &#177; std. dev. of 7 runs, 1000 loops each)</span>
<span style="color: #da8b55;">    """</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">we don&#8217;t need to store the intermediate value of vector * vector as in norm_square_numpy</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> numpy.dot<span style="color: #3a81c3;">(</span>vector, vector<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org66ed8cc" class="outline-4">
<h4 id="org66ed8cc"><span class="section-number-4">6.2.2.</span> In-Place Operations</h4>
<div class="outline-text-4" id="text-6-2-2">
<p>
Using in-place operations can help avoid the memory allocations. It is important to note that this effect
happens only when the array sizes are bigger than the CPU cache! When the arrays are smaller and the two
inputs and the output can all fit into cache, the out-of-place operation is faster because it can benefit
from vectorization.
</p>
</div>
</div>

<div id="outline-container-orge305dba" class="outline-4">
<h4 id="orge305dba"><span class="section-number-4">6.2.3.</span> <b>Numba</b></h4>
<div class="outline-text-4" id="text-6-2-3">
<p>
Numba is a just-in-time compiler that specializes in numpy code, which it compiles via the LLVM compiler
at runtime. The beauty is that you provide a decorator telling it which functions to focus on and then
you let Numba take over. It can automatically generate code for GPUs.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> numpy <span style="color: #3a81c3; font-weight: bold;">as</span> np
<span style="color: #3a81c3; font-weight: bold;">from</span> numba <span style="color: #3a81c3; font-weight: bold;">import</span> jit, prange

<span style="color: #715ab1;">input_array</span> = np.array<span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">range</span><span style="color: #6c3163;">(</span>100000<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
<span style="color: #715ab1;">output_array</span> = np.zeros<span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">len</span><span style="color: #6c3163;">(</span>input_array<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">double_all</span><span style="color: #3a81c3;">(</span>array, output<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">for</span> idx, value <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">enumerate</span><span style="color: #3a81c3;">(</span>array<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">output</span><span style="color: #3a81c3;">[</span>idx<span style="color: #3a81c3;">]</span> = value * 2

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">%timeit double_all(input_array, output_array)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">25.3 ms &#177; 774 &#181;s per loop (mean &#177; std. dev. of 7 runs, 10 loops each)</span>

<span style="color: #715ab1;">double_all_numba</span> = jit<span style="color: #3a81c3;">(</span>double_all, nopython=<span style="color: #4e3163;">True</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">%timeit double_all_numba(input_array, output_array)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">43.8 &#181;s &#177; 481 ns per loop (mean &#177; std. dev. of 7 runs, 10000 loops each)</span>

<span style="color: #ba2f59; font-weight: bold;">@jit</span><span style="color: #3a81c3;">()</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">double_all_jit</span><span style="color: #3a81c3;">(</span>array, output<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">for</span> idx, value <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">enumerate</span><span style="color: #3a81c3;">(</span>array<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">output</span><span style="color: #3a81c3;">[</span>idx<span style="color: #3a81c3;">]</span> = value * 2

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">%timeit double_all_jit(input_array, output_array)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">44.2 &#181;s &#177; 299 ns per loop (mean &#177; std. dev. of 7 runs, 10000 loops each)</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The nopython specifier means that if Numba cannot compile all of the code, it will fail.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Adding parallel enables support for prange</span>
<span style="color: #ba2f59; font-weight: bold;">@jit</span><span style="color: #3a81c3;">(</span>nopython=<span style="color: #4e3163;">True</span>, parallel=<span style="color: #4e3163;">True</span>, nogil=<span style="color: #4e3163;">True</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">double_all_jit_in_parallel</span><span style="color: #3a81c3;">(</span>array, output<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">len_array</span> = <span style="color: #3a81c3;">len</span><span style="color: #3a81c3;">(</span>array<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">for</span> idx <span style="color: #3a81c3; font-weight: bold;">in</span> prange<span style="color: #3a81c3;">(</span>len_array<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">output</span><span style="color: #3a81c3;">[</span>idx<span style="color: #3a81c3;">]</span> = array<span style="color: #3a81c3;">[</span>idx<span style="color: #3a81c3;">]</span> * 2

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">%timeit double_all_jit_in_parallel(input_array, output_array)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">14.4 &#181;s &#177; 238 ns per loop (mean &#177; std. dev. of 7 runs, 100000 loops each)</span>
</pre>
</div>

<ul class="org-ul">
<li>Debuging with Numba: using <code>double_all_jit.inspect_types()</code></li>
<li>Try to make your code compile in <b>nopython</b> mode.</li>
<li>Your best approach will be to break your current code into small(&lt;10 line) and to tackle these one at a time.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgad9bb64" class="outline-3">
<h3 id="orgad9bb64"><span class="section-number-3">6.3.</span> <code>numexpr</code></h3>
<div class="outline-text-3" id="text-6-3">
<p>
One downfall of numpy's optimization of vector operations is that it occurs on only one
operation at a time. <code>numexpr</code> can help take an entire vector expression and compile it into
very efficient code that is optimized to minimize cache misses and temporary space used. In
addition, the expressions can utilize multiple CPU cores(with OpenMP).
</p>
</div>

<div id="outline-container-org6c07f22" class="outline-4">
<h4 id="org6c07f22"><span class="section-number-4">6.3.1.</span> How to Use <code>numpexpr</code></h4>
<div class="outline-text-4" id="text-6-3-1">
<p>
Simply rewrite the expressions as strings with references to local variables. The expressions
are compiled behind the scenes and run using optimized code.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> numpy <span style="color: #3a81c3; font-weight: bold;">as</span> np
<span style="color: #3a81c3; font-weight: bold;">from</span> numexpr <span style="color: #3a81c3; font-weight: bold;">import</span> evaluate

<span style="color: #715ab1;">data</span> = np.array<span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">range</span><span style="color: #6c3163;">(</span>1000000<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
%timeit data + data * 5 + 4
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">1.95 ms &#177; 123 &#181;s per loop (mean &#177; std. dev. of 7 runs, 1000 loops each)</span>

%timeit evaluate<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"data + data * 5 + 4"</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">787 &#181;s &#177; 28.1 &#181;s per loop (mean &#177; std. dev. of 7 runs, 1000 loops each)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd8ff14d" class="outline-3">
<h3 id="orgd8ff14d"><span class="section-number-3">6.4.</span> <code>pandas</code></h3>
<div class="outline-text-3" id="text-6-4">
<ul class="org-ul">
<li>Operations on columns often generate temporary intermediate arrays, which consume RAM.</li>
<li>Make <code>pandas</code> parallel and scalable with <code>dask</code> module.</li>
<li>Columns of the same dtype are grouped together by a BlockManager.</li>
<li><code>df.apply(..., raw=True)</code> stops the creation of an intermediate Series object, uses raw numpy array instead.</li>
<li>Install the optional dependencies <code>numexpr</code> and <code>bottleneck</code> for additional performance improvements</li>
<li>Use <code>bulwark</code> to check the schema of dataframes up front.</li>
<li>Converting the Series to a Category dtype when dealing with low cardinality data. <code>df["col"].astype("category")</code></li>
</ul>
</div>

<div id="outline-container-org7f239f9" class="outline-4">
<h4 id="org7f239f9"><span class="section-number-4">6.4.1.</span> <code>Modin</code></h4>
<div class="outline-text-4" id="text-6-4-1">
<p>
Parallelizing with dask/ray.
</p>
<ol class="org-ol">
<li><code>pip install modin[dask]</code> or <code>pip install modin[ray]</code></li>
<li><code>export MODIN_ENGINE=dask</code> or <code>os.environ["MODIN_ENGINE"] = "dask"</code></li>
<li><code>import modin.pandas as pd</code></li>
</ol>
</div>
</div>

<div id="outline-container-orgf029a4d" class="outline-4">
<h4 id="orgf029a4d"><span class="section-number-4">6.4.2.</span> <code>cuDF</code></h4>
<div class="outline-text-4" id="text-6-4-2">
<p>
GPU DataFrame Library
</p>
</div>
</div>

<div id="outline-container-org050977b" class="outline-4">
<h4 id="org050977b"><span class="section-number-4">6.4.3.</span> <code>vaex</code></h4>
<div class="outline-text-4" id="text-6-4-3">
<ul class="org-ul">
<li>Vaex specializes in both larger datasets and string-heavy operations</li>
<li>Vaex offers a slew of built-in visualization functions.</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-org47de320" class="outline-3">
<h3 id="org47de320"><span class="section-number-3">6.5.</span> Summary</h3>
<div class="outline-text-3" id="text-6-5">
<p>
Two main routes:
</p>
<ul class="org-ul">
<li>reducing the time taken to get data to the CPU.</li>
<li>reducing the amount of work that the CPU had to do.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org6b640e6" class="outline-2">
<h2 id="org6b640e6"><span class="section-number-2">7.</span> Compiling to Bytecode</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-orgfee8f60" class="outline-3">
<h3 id="orgfee8f60"><span class="section-number-3">7.1.</span> All Routes</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>C-based compiling: Cython</li>
<li>LLVM-based compiling: Numba</li>
<li>just-in-time compiler: PyPy</li>
</ul>
</div>
</div>

<div id="outline-container-orgf3ab71c" class="outline-3">
<h3 id="orgf3ab71c"><span class="section-number-3">7.2.</span> Cython</h3>
<div class="outline-text-3" id="text-7-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">In setup.py</span>
<span style="color: #3a81c3; font-weight: bold;">from</span> distutils.core <span style="color: #3a81c3; font-weight: bold;">import</span> setup

<span style="color: #3a81c3; font-weight: bold;">from</span> Cython.Build <span style="color: #3a81c3; font-weight: bold;">import</span> cythonize

setup<span style="color: #3a81c3;">(</span>ext_modules=cythonize<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"cythonfn.pyx"</span>, compiler_directives=<span style="color: #2d9574;">{</span><span style="color: #2d9574;">"language_level"</span>: <span style="color: #2d9574;">"3"</span><span style="color: #2d9574;">}</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<p>
When we run <code>python setup.py build_ext --inplace</code>, Cython will look for <code>cythonfn.pyx</code> and build <code>cythonfn[…].so</code>.
</p>
</div>

<div id="outline-container-orgded4f05" class="outline-4">
<h4 id="orgded4f05"><span class="section-number-4">7.2.1.</span> <code>pyximport</code></h4>
<div class="outline-text-4" id="text-7-2-1">
<p>
Simplifing build system, no need to use setup.py.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">In client_code.py</span>
<span style="color: #3a81c3; font-weight: bold;">import</span> pyximport

pyximport.install<span style="color: #3a81c3;">(</span>language_level=3<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">import</span> cythonfn

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">followed by the usual code</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org965efe5" class="outline-4">
<h4 id="org965efe5"><span class="section-number-4">7.2.2.</span> Analyzing Generated C Code</h4>
<div class="outline-text-4" id="text-7-2-2">
<p>
<code>cython -a cythonfn.pyx</code> -&gt; <code>cythonfn.html</code>
</p>
<ul class="org-ul">
<li>More yellow means "more calls into the Python virtual machine"</li>
<li>More white means "more non-Python C code"</li>
</ul>
</div>
</div>

<div id="outline-container-org4dd9624" class="outline-4">
<h4 id="org4dd9624"><span class="section-number-4">7.2.3.</span> Type Annotation</h4>
<div class="outline-text-4" id="text-7-2-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">add</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">int</span> x, <span style="color: #3a81c3;">int</span> y<span style="color: #3a81c3;">)</span>:
    cdef unsigned <span style="color: #3a81c3;">int</span> x, y
    <span style="color: #3a81c3; font-weight: bold;">return</span> x + y
</pre>
</div>
</div>
</div>

<div id="outline-container-orge1c4af5" class="outline-4">
<h4 id="orge1c4af5"><span class="section-number-4">7.2.4.</span> Cython Flags</h4>
<div class="outline-text-4" id="text-7-2-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">cython: boundscheck=False</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">test</span><span style="color: #3a81c3;">(</span>...<span style="color: #3a81c3;">)</span>:
    ...
</pre>
</div>
</div>
</div>

<div id="outline-container-org5c16f62" class="outline-4">
<h4 id="org5c16f62"><span class="section-number-4">7.2.5.</span> Parallelizing on One Machine</h4>
<div class="outline-text-4" id="text-7-2-5">
<p>
With Cython, OpenMP can be added by using the <code>prange</code> (parallel range) operator and adding the <code>-fopenmp</code>
compiler directive to setup.py. Work in a prange loop can be performed in parallel because we disable the GIL.
</p>
</div>
</div>
<div id="outline-container-org0fe16d0" class="outline-4">
<h4 id="org0fe16d0"><span class="section-number-4">7.2.6.</span> Example</h4>
<div class="outline-text-4" id="text-7-2-6">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">cythonfn.pyx</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">cython: boundscheck=False # disable boundscheck on arrays</span>
<span style="color: #3a81c3; font-weight: bold;">from</span> cython.parallel <span style="color: #3a81c3; font-weight: bold;">import</span> prange
<span style="color: #3a81c3; font-weight: bold;">import</span> numpy <span style="color: #3a81c3; font-weight: bold;">as</span> np
cimport numpy <span style="color: #3a81c3; font-weight: bold;">as</span> np

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">calculate_z</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">int</span> maxiter, double <span style="color: #3a81c3;">complex</span><span style="color: #6c3163;">[</span>:<span style="color: #6c3163;">]</span> zs, double <span style="color: #3a81c3;">complex</span><span style="color: #6c3163;">[</span>:<span style="color: #6c3163;">]</span> cs<span style="color: #3a81c3;">)</span>:
    <span style="color: #da8b55;">"""Calculate output list using Julia update rule"""</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">using [] to annotate the buffer protocol, single colon indicates one-dimensional data</span>
    cdef unsigned <span style="color: #3a81c3;">int</span> i, length
    cdef double <span style="color: #3a81c3;">complex</span> z, c
    cdef <span style="color: #3a81c3;">int</span><span style="color: #3a81c3;">[</span>:<span style="color: #3a81c3;">]</span> <span style="color: #715ab1;">output</span> = np.empty<span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">len</span><span style="color: #6c3163;">(</span>zs<span style="color: #6c3163;">)</span>, dtype=np.int32<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">annotate output</span>
    <span style="color: #715ab1;">length</span> = <span style="color: #3a81c3;">len</span><span style="color: #3a81c3;">(</span>zs<span style="color: #3a81c3;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">with</span> nogil: <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">disable GIL</span>
	<span style="color: #3a81c3; font-weight: bold;">for</span> i <span style="color: #3a81c3; font-weight: bold;">in</span> prange<span style="color: #3a81c3;">(</span>length, schedule=<span style="color: #2d9574;">"guided"</span><span style="color: #3a81c3;">)</span>: <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">guided scheduling</span>
	    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">parallelizing in prange block</span>
	    <span style="color: #715ab1;">z</span> = zs<span style="color: #3a81c3;">[</span>i<span style="color: #3a81c3;">]</span>
	    <span style="color: #715ab1;">c</span> = cs<span style="color: #3a81c3;">[</span>i<span style="color: #3a81c3;">]</span>
	    <span style="color: #715ab1;">output</span><span style="color: #3a81c3;">[</span>i<span style="color: #3a81c3;">]</span> = 0
	    <span style="color: #3a81c3; font-weight: bold;">while</span> output<span style="color: #3a81c3;">[</span>i<span style="color: #3a81c3;">]</span> &lt; maxiter <span style="color: #3a81c3; font-weight: bold;">and</span> <span style="color: #3a81c3;">(</span>z.real * z.real + z.imag * z.imag<span style="color: #3a81c3;">)</span> &lt; 4:
		<span style="color: #715ab1;">z</span> = z * z + c
		<span style="color: #715ab1;">output</span><span style="color: #3a81c3;">[</span>i<span style="color: #3a81c3;">]</span> += 1
    <span style="color: #3a81c3; font-weight: bold;">return</span> output
</pre>
</div>
<p>
In setup.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">setup.py</span>
<span style="color: #3a81c3; font-weight: bold;">from</span> distutils.core <span style="color: #3a81c3; font-weight: bold;">import</span> setup
<span style="color: #3a81c3; font-weight: bold;">from</span> distutils.extension <span style="color: #3a81c3; font-weight: bold;">import</span> Extension

<span style="color: #3a81c3; font-weight: bold;">import</span> numpy <span style="color: #3a81c3; font-weight: bold;">as</span> np
<span style="color: #3a81c3; font-weight: bold;">from</span> Cython.Build <span style="color: #3a81c3; font-weight: bold;">import</span> cythonize

<span style="color: #715ab1;">ext_modules</span> = <span style="color: #3a81c3;">[</span>
    Extension<span style="color: #6c3163;">(</span>
	<span style="color: #2d9574;">"cythonfn"</span>, <span style="color: #2d9574;">[</span><span style="color: #2d9574;">"cythonfn.pyx"</span><span style="color: #2d9574;">]</span>, extra_compile_args=<span style="color: #2d9574;">[</span><span style="color: #2d9574;">"-fopenmp"</span><span style="color: #2d9574;">]</span>, extra_link_args=<span style="color: #2d9574;">[</span><span style="color: #2d9574;">"-fopenmp"</span><span style="color: #2d9574;">]</span>
    <span style="color: #6c3163;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Adding the OpenMP compiler flags and linker flags to setup.py for Cython</span>
<span style="color: #3a81c3;">]</span>


setup<span style="color: #3a81c3;">(</span>
    ext_modules=cythonize<span style="color: #6c3163;">(</span>
	ext_modules,
	compiler_directives=<span style="color: #2d9574;">{</span><span style="color: #2d9574;">"language_level"</span>: <span style="color: #2d9574;">"3"</span><span style="color: #2d9574;">}</span>,
    <span style="color: #6c3163;">)</span>,
    include_dirs=<span style="color: #6c3163;">[</span>np.get_include<span style="color: #2d9574;">()</span><span style="color: #6c3163;">]</span>,
<span style="color: #3a81c3;">)</span>
</pre>
</div>
<ul class="org-ul">
<li>Choosing scheduling approaches: <code>static</code>, <code>dynamic</code>, <code>guided</code></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgd4d7e75" class="outline-3">
<h3 id="orgd4d7e75"><span class="section-number-3">7.3.</span> PyPy</h3>
<div class="outline-text-3" id="text-7-3">
<ul class="org-ul">
<li>Different GC strategy(mark-and-sweep) than CPython(reference counting)</li>
<li>PyPy supports projects like numpy that require C bindings through the CPython extension compatibility layer <b>cpyext</b>, but it has an overhead of 4–6×, which generally makes numpy too slow.</li>
<li>May use more RAM than CPython.</li>
</ul>
</div>
</div>

<div id="outline-container-org04b2808" class="outline-3">
<h3 id="org04b2808"><span class="section-number-3">7.4.</span> Transonic</h3>
<div class="outline-text-3" id="text-7-4">
<p>
Transonic attempts to unify Cython, Pythran, and Numba, and potentially other compilers, behind one
interface to enable quick evaluation of multiple compilers without having to rewrite code.
</p>
</div>
</div>

<div id="outline-container-org74e7660" class="outline-3">
<h3 id="org74e7660"><span class="section-number-3">7.5.</span> CuPy</h3>
<div class="outline-text-3" id="text-7-5">
<p>
<a href="https://cupy.dev/">A NumPy-compatible array library accelerated by CUDA</a>
</p>
</div>
</div>

<div id="outline-container-org5a9402b" class="outline-3">
<h3 id="org5a9402b"><span class="section-number-3">7.6.</span> Foreign Function Interfaces</h3>
<div class="outline-text-3" id="text-7-6">
</div>
<div id="outline-container-org514d7a3" class="outline-4">
<h4 id="org514d7a3"><span class="section-number-4">7.6.1.</span> C <code>.so</code></h4>
<div class="outline-text-4" id="text-7-6-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">add_two</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">a</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">b</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> a + b;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<ol class="org-ol">
<li><code>gcc -O3 -std=gnu11 -c libtest.c</code></li>
<li><code>gcc -shared -o libtest.so libtest.o</code></li>
<li>Put <code>libtest.so</code> in <code>/usr/lib</code> or <code>/usr/local/lib</code> or somewhere is accessible to python code.</li>
</ol>
</div>
</div>
<div id="outline-container-org3277c7d" class="outline-4">
<h4 id="org3277c7d"><span class="section-number-4">7.6.2.</span> ctypes</h4>
<div class="outline-text-4" id="text-7-6-2">
<p>
The most basic foreign function interface in CPython is through the <code>ctypes</code> module.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> ctypes

<span style="color: #715ab1;">_libtest</span> = ctypes.CDLL<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"libtest.so"</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Create references to the C types that we will need to simplify future code</span>
<span style="color: #715ab1;">TYPE_INT</span> = ctypes.c_int

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Initialize the signature of the evolve function to:</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">int add_two(int, int)</span>
<span style="color: #715ab1;">_libtest.add_two.argtypes</span> = <span style="color: #3a81c3;">[</span>TYPE_INT, TYPE_INT<span style="color: #3a81c3;">]</span>
<span style="color: #715ab1;">_libtest.add_two.restype</span> = TYPE_INT


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">add_two_in_python</span><span style="color: #3a81c3;">(</span>a: <span style="color: #3a81c3;">int</span>, b: <span style="color: #3a81c3;">int</span><span style="color: #3a81c3;">)</span> -&gt; <span style="color: #3a81c3;">int</span>:
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">First we convert the Python types into the relevant C types</span>
    <span style="color: #715ab1;">a</span> = TYPE_INT<span style="color: #3a81c3;">(</span>a<span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">b</span> = TYPE_INT<span style="color: #3a81c3;">(</span>b<span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">res</span> = _libtest.add_two<span style="color: #3a81c3;">(</span>a, b<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> res
</pre>
</div>
<ul class="org-ul">
<li><p>
C structure
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> ctypes <span style="color: #3a81c3; font-weight: bold;">import</span> Structure, c_int

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">cPoint</span><span style="color: #3a81c3;">(</span>Structure<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">_fields_</span> = <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"x"</span>, c_int<span style="color: #3a81c3;">)</span>, <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"y"</span>, c_int<span style="color: #3a81c3;">)</span>

<span style="color: #715ab1;">point</span> = cPoint<span style="color: #3a81c3;">(</span>10, 5<span style="color: #3a81c3;">)</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgef9374b" class="outline-3">
<h3 id="orgef9374b"><span class="section-number-3">7.7.</span> Other Tools</h3>
<div class="outline-text-3" id="text-7-7">
<p>
See <a href="http://compilers.pydata.org/">http://compilers.pydata.org/</a>
</p>
</div>
</div>
</div>
</div>
</body>
</html>
