<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
<!-- 2021-09-10 Fri 14:18 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Python Cookbook</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="chrischen" />
<meta name="keywords" content="python, cookbook" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
	     margin-bottom: .2em; }
  .subtitle { text-align: center;
	      font-size: medium;
	      font-weight: bold;
	      margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
	    padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css">
</head>
<body>
<div id="content">
<h1 class="title">Python Cookbook</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org27be658">1. Data Structures and Algorithms</a></li>
<li><a href="#org57b3ed3">2. String Manipulation</a></li>
<li><a href="#org060742d">3. <span class="todo TODO">TODO</span> Numbers</a></li>
<li><a href="#org79b8193">4. Datetime</a></li>
<li><a href="#orge4ed194">5. Iterator</a></li>
<li><a href="#org2f40139">6. I/O</a></li>
<li><a href="#orgabd4765">7. Encoding</a></li>
<li><a href="#org5f22c69">8. Functions</a></li>
<li><a href="#orgad848dd">9. Class</a></li>
<li><a href="#orgbde7bc2">10. Metaprogramming</a></li>
<li><a href="#orgc492047">11. Metaclass</a></li>
<li><a href="#org1858620">12. Packages and Modules</a></li>
<li><a href="#org2756900">13. Network</a></li>
<li><a href="#orgdb7f864">14. Concurrency</a></li>
<li><a href="#org90aa9e4">15. System Utilities</a></li>
<li><a href="#org270737c">16. Testing</a></li>
<li><a href="#orged33c9e">17. Debuging</a></li>
</ul>
</div>
</div>
<div id="outline-container-org27be658" class="outline-2">
<h2 id="org27be658"><span class="section-number-2">1</span> Data Structures and Algorithms</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgb15c42e" class="outline-3">
<h3 id="orgb15c42e"><span class="section-number-3">1.1</span> Quick Summary</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">unpacking</span>
<span style="color: #715ab1;">data</span> = <span style="color: #3a81c3;">[</span><span style="color: #2d9574;">"ACME"</span>, 50, 91.1, <span style="color: #6c3163;">(</span>2012, 12, 21<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">]</span>
name, *_, <span style="color: #3a81c3;">(</span>year, mon, day<span style="color: #3a81c3;">)</span> = data

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">fixed-length queue</span>
<span style="color: #3a81c3; font-weight: bold;">from</span> collections <span style="color: #3a81c3; font-weight: bold;">import</span> deque

<span style="color: #715ab1;">d</span> = deque<span style="color: #3a81c3;">(</span>maxlen=N<span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">heap related</span>
<span style="color: #3a81c3; font-weight: bold;">import</span> heapq

heapq.nlargest<span style="color: #3a81c3;">(</span>N, items<span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">faster than sorted(items)[:N] if N is small</span>
heapq.nsmallest<span style="color: #3a81c3;">(</span>N, items, key=<span style="color: #4e3163;">None</span><span style="color: #3a81c3;">)</span>
<span style="color: #715ab1;">nums</span> = <span style="color: #3a81c3;">[</span>1, 8, 2, 23, 7, -4, 18, 23, 42, 37, 2<span style="color: #3a81c3;">]</span>
heapq.heapify<span style="color: #3a81c3;">(</span>nums<span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">inplace function</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">agg by values</span>
<span style="color: #715ab1;">prices</span> = <span style="color: #3a81c3;">{</span><span style="color: #2d9574;">"AAPL"</span>: 612.78, <span style="color: #2d9574;">"IBM"</span>: 205.55, <span style="color: #2d9574;">"FB"</span>: 10.75<span style="color: #3a81c3;">}</span>
<span style="color: #715ab1;">min_price</span> = <span style="color: #3a81c3;">min</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">zip</span><span style="color: #6c3163;">(</span>prices.values<span style="color: #2d9574;">()</span>, prices.keys<span style="color: #2d9574;">()</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">zip to ((value, key)) generator</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">key-views support set oparations</span>
d.keys<span style="color: #3a81c3;">()</span> - d2.keys<span style="color: #3a81c3;">()</span>
d.keys<span style="color: #3a81c3;">()</span> &amp; d2.keys<span style="color: #3a81c3;">()</span>
d.keys<span style="color: #3a81c3;">()</span> | d2.keys<span style="color: #3a81c3;">()</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">boolean selectors</span>
<span style="color: #3a81c3; font-weight: bold;">from</span> itertools <span style="color: #3a81c3; font-weight: bold;">import</span> compress
<span style="color: #715ab1;">alist</span> = <span style="color: #3a81c3;">list</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">range</span><span style="color: #6c3163;">(</span>10<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">list</span><span style="color: #3a81c3;">(</span>compress<span style="color: #6c3163;">(</span>alist, <span style="color: #2d9574;">[</span>i % 2 == 0 <span style="color: #3a81c3; font-weight: bold;">for</span> i <span style="color: #3a81c3; font-weight: bold;">in</span> alist<span style="color: #2d9574;">]</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>

<div id="outline-container-org8b808b1" class="outline-4">
<h4 id="org8b808b1"><span class="section-number-4">1.1.1</span> others</h4>
<div class="outline-text-4" id="text-1-1-1">
<ul class="org-ul">
<li>slice, itertools.islice</li>
<li>collections.Counter</li>
<li><code>from operator import itemgetter, attrgetter</code></li>
<li>itertools.groupby</li>
<li>from collections.ChainMap</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgdee357d" class="outline-3">
<h3 id="orgdee357d"><span class="section-number-3">1.2</span> PriorityQueue Implemention</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> heapq

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">PriorityQueue</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>._queue = <span style="color: #3a81c3;">[]</span>
	<span style="color: #3a81c3; font-weight: bold;">self</span>._index = 0 <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">using index to properly order items with the same priority level</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">push</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, item, priority<span style="color: #3a81c3;">)</span>:
	heapq.heappush<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>._queue, <span style="color: #6c3163;">(</span>-priority, <span style="color: #3a81c3; font-weight: bold;">self</span>._index, item<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">self</span>._index += 1

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">pop</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">return</span> heapq.heappop<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>._queue<span style="color: #3a81c3;">)[</span>-1<span style="color: #3a81c3;">]</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org57b3ed3" class="outline-2">
<h2 id="org57b3ed3"><span class="section-number-2">2</span> String Manipulation</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org66a4f19" class="outline-3">
<h3 id="org66a4f19"><span class="section-number-3">2.1</span> Quick Summary</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> re

re.split<span style="color: #3a81c3;">(</span>r<span style="color: #2d9574;">"[./]"</span>, <span style="color: #2d9574;">"btc.usd/coinbase"</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; ['btc', 'usd', 'coinbase'] slower than split("/").split(".")</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">shell-like matching</span>
fnmatch<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"foo.txt"</span>, <span style="color: #2d9574;">"*.txt"</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">searching &amp; replacing</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">str.find, str.findall, re.match</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">str.replace, re.sub</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Case-Insensitive Option: flags=re.IGNORECASE</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">For the Shortest Match</span>
<span style="color: #715ab1;">str_pat</span> = re.<span style="color: #3a81c3;">compile</span><span style="color: #3a81c3;">(</span>r<span style="color: #2d9574;">"\"(.*)\""</span><span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">default: greedy regular expression</span>
<span style="color: #715ab1;">text</span> = <span style="color: #2d9574;">'Computer says "no." Phone says "yes."'</span>
str_pat.findall<span style="color: #3a81c3;">(</span>text<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; ['no." Phone says "yes.']</span>

<span style="color: #715ab1;">str_pat</span> = re.<span style="color: #3a81c3;">compile</span><span style="color: #3a81c3;">(</span>r<span style="color: #2d9574;">"\"(.*?)\""</span><span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">nongreedy and produces the shortest match instead.</span>
str_pat.findall<span style="color: #3a81c3;">(</span>text<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; ['no.', 'yes.']</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Aligning</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">str.ljust, str.rjust, str.center</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">f"{text:&lt;20}", f"{text:&gt;20}", f"{text:^20}"</span>
<span style="color: #715ab1;">text</span> = <span style="color: #2d9574;">"Hello World"</span>
<span style="color: #715ab1;">ftext</span> = f<span style="color: #2d9574;">"{text:=&gt;20}"</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; "=========Hello World"</span>
<span style="color: #715ab1;">ftext</span> = f<span style="color: #2d9574;">"{text:*^20}"</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; "****Hello World*****"</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Byte Strings</span>
<span style="color: #715ab1;">bstr</span> = b<span style="color: #2d9574;">"Hello World"</span>
<span style="color: #715ab1;">barray</span> = <span style="color: #3a81c3;">bytearray</span><span style="color: #3a81c3;">(</span>b<span style="color: #2d9574;">"Hello World"</span><span style="color: #3a81c3;">)</span>
bstr.decode<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"ascii"</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; "Hello World"</span>
</pre>
</div>
</div>

<div id="outline-container-org29e4c5b" class="outline-4">
<h4 id="org29e4c5b"><span class="section-number-4">2.1.1</span> others</h4>
<div class="outline-text-4" id="text-2-1-1">
<ul class="org-ul">
<li>The <code>textwrap</code> module is a straightforward way to clean up text for printing. <code>textwrap.fill(s, 70, initial_indent="    ")</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgce6b251" class="outline-3">
<h3 id="orgce6b251"><span class="section-number-3">2.2</span> Tokenizing Text</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Tokenizing is often the first step for more advanced kinds of text parsing and handling.
<a href="https://docs.python.org/3/library/re.html#writing-a-tokenizer">https://docs.python.org/3/library/re.html#writing-a-tokenizer</a>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">text</span> = <span style="color: #2d9574;">"foo = 23 + 42 * 10"</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">expected results</span>
<span style="color: #715ab1;">tokens</span> = <span style="color: #3a81c3;">[</span>
    <span style="color: #6c3163;">(</span><span style="color: #2d9574;">"NAME"</span>, <span style="color: #2d9574;">"foo"</span><span style="color: #6c3163;">)</span>,
    <span style="color: #6c3163;">(</span><span style="color: #2d9574;">"EQ"</span>, <span style="color: #2d9574;">"="</span><span style="color: #6c3163;">)</span>,
    <span style="color: #6c3163;">(</span><span style="color: #2d9574;">"NUM"</span>, <span style="color: #2d9574;">"23"</span><span style="color: #6c3163;">)</span>,
    <span style="color: #6c3163;">(</span><span style="color: #2d9574;">"PLUS"</span>, <span style="color: #2d9574;">"+"</span><span style="color: #6c3163;">)</span>,
    <span style="color: #6c3163;">(</span><span style="color: #2d9574;">"NUM"</span>, <span style="color: #2d9574;">"42"</span><span style="color: #6c3163;">)</span>,
    <span style="color: #6c3163;">(</span><span style="color: #2d9574;">"TIMES"</span>, <span style="color: #2d9574;">"*"</span><span style="color: #6c3163;">)</span>,
    <span style="color: #6c3163;">(</span><span style="color: #2d9574;">"NUM"</span>, <span style="color: #2d9574;">"10"</span><span style="color: #6c3163;">)</span>,
<span style="color: #3a81c3;">]</span>

<span style="color: #3a81c3; font-weight: bold;">import</span> re

<span style="color: #715ab1;">NAME</span> = r<span style="color: #2d9574;">"(?P&lt;NAME&gt;[a-zA-Z_][a-zA-Z_0-9]*)"</span>
<span style="color: #715ab1;">NUM</span> = r<span style="color: #2d9574;">"(?P&lt;NUM&gt;\d+)"</span>
<span style="color: #715ab1;">PLUS</span> = r<span style="color: #2d9574;">"(?P&lt;PLUS&gt;\+)"</span>
<span style="color: #715ab1;">TIMES</span> = r<span style="color: #2d9574;">"(?P&lt;TIMES&gt;\*)"</span>
<span style="color: #715ab1;">EQ</span> = r<span style="color: #2d9574;">"(?P&lt;EQ&gt;=)"</span>
<span style="color: #715ab1;">WS</span> = r<span style="color: #2d9574;">"(?P&lt;WS&gt;\s+)"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the ?P&lt;TOKENNAME&gt; convention is used to assign a name to the pattern</span>
<span style="color: #715ab1;">master_pat</span> = re.<span style="color: #3a81c3;">compile</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"|"</span>.join<span style="color: #6c3163;">(</span><span style="color: #2d9574;">[</span>NAME, NUM, PLUS, TIMES, EQ, WS<span style="color: #2d9574;">]</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">for</span> mo <span style="color: #3a81c3; font-weight: bold;">in</span> re.finditer<span style="color: #3a81c3;">(</span>master_pat, <span style="color: #2d9574;">"foo = 42"</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>mo.lastgroup, mo.group<span style="color: #6c3163;">()</span><span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">NAME foo, WS , EQ =, ...</span>
</pre>
</div>
<ul class="org-ul">
<li>Syntax Parser: Recipe 2.19</li>
<li>For more complicated grammer: use <a href="https://github.com/pyparsing/pyparsing">pyparsing</a>, <a href="https://github.com/dabeaz/ply">PLY</a></li>
</ul>
</div>
</div>
</div>


<div id="outline-container-org060742d" class="outline-2">
<h2 id="org060742d"><span class="section-number-2">3</span> <span class="todo TODO">TODO</span> Numbers</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org5c71bbf" class="outline-3">
<h3 id="org5c71bbf"><span class="section-number-3">3.1</span> round</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3;">round</span><span style="color: #3a81c3;">(</span>1.29, 1<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1.3</span>
<span style="color: #3a81c3;">round</span><span style="color: #3a81c3;">(</span>1245, -1<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1240</span>
<span style="color: #3a81c3;">round</span><span style="color: #3a81c3;">(</span>1275, -1<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1280</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org41563b4" class="outline-3">
<h3 id="org41563b4"><span class="section-number-3">3.2</span> Decimal</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> decimal <span style="color: #3a81c3; font-weight: bold;">import</span> Decimal, localcontext
<span style="color: #715ab1;">a</span> = Decimal<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'6.32'</span><span style="color: #3a81c3;">)</span>
<span style="color: #715ab1;">b</span> = Decimal<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'2.41'</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">with</span> localcontext<span style="color: #3a81c3;">()</span> <span style="color: #3a81c3; font-weight: bold;">as</span> ctx:
    <span style="color: #715ab1;">ctx.prec</span> = 5
    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>a/b<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">2.6224</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf1a6c68" class="outline-3">
<h3 id="orgf1a6c68"><span class="section-number-3">3.3</span> Formatting</h3>
<div class="outline-text-3" id="text-3-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">x</span> = 1234.56789
<span style="color: #3a81c3;">format</span><span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">'0.2f'</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '1234.57'   # round</span>
<span style="color: #3a81c3;">format</span><span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">'&gt;10.1f'</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '    1234.6'</span>
<span style="color: #3a81c3;">format</span><span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">'0,.1f'</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '1,234.6</span>

<span style="color: #715ab1;">x</span> = 1234
<span style="color: #3a81c3;">bin</span><span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">others: oct, hex</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '0b10011010010'</span>
<span style="color: #3a81c3;">format</span><span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">'b'</span><span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">others: o, x</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '0011010010'</span>
<span style="color: #3a81c3;">int</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'10011010010'</span>, 2<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1234</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org94cfaca" class="outline-3">
<h3 id="org94cfaca"><span class="section-number-3">3.4</span> Bin, Oct, Hex Int</h3>
<div class="outline-text-3" id="text-3-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">x</span> = -1234
<span style="color: #3a81c3;">format</span><span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">'b'</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '-10011010010'</span>
<span style="color: #3a81c3;">format</span><span style="color: #3a81c3;">(</span>x, <span style="color: #2d9574;">'x'</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '-4d2'</span>
<span style="color: #3a81c3;">format</span><span style="color: #3a81c3;">(</span>2**32 + x, <span style="color: #2d9574;">'b'</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '11111111111111111111101100101110'</span>
<span style="color: #3a81c3;">format</span><span style="color: #3a81c3;">(</span>2**32 + x, <span style="color: #2d9574;">'x'</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 'fffffb2e'</span>
<span style="color: #3a81c3;">int</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'4d2'</span>, 16<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1234</span>
<span style="color: #3a81c3;">int</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'10011010010'</span>, 2<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1234</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc237980" class="outline-3">
<h3 id="orgc237980"><span class="section-number-3">3.5</span> Bytes2Int</h3>
<div class="outline-text-3" id="text-3-5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">data</span> = b<span style="color: #2d9574;">'\x00\x124V\x00x\x90\xab\x00\xcd\xef\x01\x00#\x004'</span>
<span style="color: #715ab1;">x</span> = <span style="color: #3a81c3;">int</span>.from_bytes<span style="color: #3a81c3;">(</span>data, <span style="color: #2d9574;">'little'</span><span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">or 'big</span>

<span style="color: #715ab1;">x</span> = 94522842520747284487117727783387188
x.to_bytes<span style="color: #3a81c3;">(</span>16, <span style="color: #2d9574;">'little'</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<p>
useful in cryptography or networking domains
</p>
<ul class="org-ul">
<li><code>struct</code> module</li>
<li><code>int.bit_length()</code></li>
</ul>
</div>
</div>

<div id="outline-container-org3d81193" class="outline-3">
<h3 id="org3d81193"><span class="section-number-3">3.6</span> Complex Math</h3>
<div class="outline-text-3" id="text-3-6">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">a</span> = <span style="color: #3a81c3;">complex</span><span style="color: #3a81c3;">(</span>2, 4<span style="color: #3a81c3;">)</span>
<span style="color: #715ab1;">b</span> = 3 - 5j
a.conjugate<span style="color: #3a81c3;">()</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; (2-4j)</span>
<span style="color: #3a81c3;">abs</span><span style="color: #3a81c3;">(</span>a<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 4.47213595499958</span>
a * b
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; (26+2j)</span>

<span style="color: #3a81c3; font-weight: bold;">import</span> cmath
cmath.sin<span style="color: #3a81c3;">(</span>a<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; (24.83130584894638-11.356612711218174j)</span>

<span style="color: #3a81c3; font-weight: bold;">import</span> numpy <span style="color: #3a81c3; font-weight: bold;">as</span> np
<span style="color: #715ab1;">a</span> = np.array<span style="color: #3a81c3;">(</span><span style="color: #6c3163;">[</span>2 + 3j, 4 + 5j, 6 - 7j, 8 + 9j<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
np.sin<span style="color: #3a81c3;">(</span>a<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org79cf082" class="outline-3">
<h3 id="org79cf082"><span class="section-number-3">3.7</span> random</h3>
<div class="outline-text-3" id="text-3-7">
<ul class="org-ul">
<li><code>random.choice</code></li>
<li><code>random.sample</code></li>
<li><code>random.shuffle</code></li>
<li><code>random.randint</code></li>
<li><code>random.random</code>: 0 to 1</li>
<li><code>random.getrandbits</code></li>
</ul>
</div>
<div id="outline-container-org144c89b" class="outline-4">
<h4 id="org144c89b"><span class="section-number-4">3.7.1</span> seed</h4>
<div class="outline-text-4" id="text-3-7-1">
<div class="org-src-container">
<pre class="src src-python">random.seed<span style="color: #3a81c3;">()</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Seed based on system time or os.urandom()</span>
random.seed<span style="color: #3a81c3;">(</span>12345<span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Seed based on integer given</span>
random.seed<span style="color: #3a81c3;">(</span>b<span style="color: #2d9574;">'bytedata'</span><span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Seed based on byte data</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0a351e5" class="outline-4">
<h4 id="org0a351e5"><span class="section-number-4">3.7.2</span> distribution</h4>
<div class="outline-text-4" id="text-3-7-2">
<ul class="org-ul">
<li><code>random.uniform</code></li>
<li><code>random.gauss</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgd43031c" class="outline-3">
<h3 id="orgd43031c"><span class="section-number-3">3.8</span> math.f***</h3>
<div class="outline-text-3" id="text-3-8">
<ul class="org-ul">
<li><code>math.fsum</code></li>
<li><code>math.fmod</code></li>
<li><code>math.fabs</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org79b8193" class="outline-2">
<h2 id="org79b8193"><span class="section-number-2">4</span> Datetime</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org9438575" class="outline-3">
<h3 id="org9438575"><span class="section-number-3">4.1</span> Finding Last Friday</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> dateutil.relativedelta <span style="color: #3a81c3; font-weight: bold;">import</span> relativedelta
<span style="color: #3a81c3; font-weight: bold;">from</span> dateutil.rrule <span style="color: #3a81c3; font-weight: bold;">import</span> FR
<span style="color: #715ab1;">d</span> = datetime.now<span style="color: #3a81c3;">()</span>
<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>d + relativedelta<span style="color: #6c3163;">(</span>weekday=FR<span style="color: #2d9574;">(</span>-1<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5281b2b" class="outline-3">
<h3 id="org5281b2b"><span class="section-number-3">4.2</span> Timezone</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> pytz
<span style="color: #715ab1;">d</span> = datetime.now<span style="color: #3a81c3;">()</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">no timezone info</span>
<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>d<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 2018-12-21 17:14:01.258941</span>

<span style="color: #715ab1;">shanghai</span> = pytz.timezone<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Asia/Shanghai'</span><span style="color: #3a81c3;">)</span>
<span style="color: #715ab1;">loc_d</span> = shanghai.localize<span style="color: #3a81c3;">(</span>d<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Localize the date for Shanghai</span>
<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>loc_d<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 2018-12-21 17:14:01.258941+08:00</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Once the date has been localized, it can be converted to other time zones</span>
<span style="color: #715ab1;">utc_d</span> = loc_d.astimezone<span style="color: #3a81c3;">(</span>pytz.utc<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>utc_d<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 2018-12-21 09:14:01.258941+00:00</span>
</pre>
</div>

<ul class="org-ul">
<li><code>datetime.replace</code></li>
<li><code>datetime.astimezone</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orge4ed194" class="outline-2">
<h2 id="orge4ed194"><span class="section-number-2">5</span> Iterator</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org7c3dff2" class="outline-3">
<h3 id="org7c3dff2"><span class="section-number-3">5.1</span> Manually Consuming an Iterator</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">iterable</span> = <span style="color: #3a81c3;">iter</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">range</span><span style="color: #6c3163;">(</span>5<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Invokes range.__iter__()</span>
<span style="color: #3a81c3; font-weight: bold;">try</span>:
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
	<span style="color: #715ab1;">line</span> = <span style="color: #3a81c3;">next</span><span style="color: #3a81c3;">(</span>iterable<span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Invokes iterable.__next__()</span>
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>line, end=<span style="color: #2d9574;">''</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">StopIteration</span>:
    <span style="color: #3a81c3; font-weight: bold;">pass</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">non exception version</span>
<span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
    <span style="color: #715ab1;">line</span> = <span style="color: #3a81c3;">next</span><span style="color: #3a81c3;">(</span>iterable, <span style="color: #4e3163;">None</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> line <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
	<span style="color: #3a81c3; font-weight: bold;">break</span>
    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>line, end=<span style="color: #2d9574;">''</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<ul class="org-ul">
<li>Python’s iterator protocol requires <code>__iter__()</code> to return a special iterator object that implements a <code>__next__()</code> method to carry out the actual iteration.</li>
</ul>
</div>
</div>
<div id="outline-container-org7a69320" class="outline-3">
<h3 id="org7a69320"><span class="section-number-3">5.2</span> Iterating Over Multi Sequences</h3>
<div class="outline-text-3" id="text-5-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">a</span> = <span style="color: #3a81c3;">[</span>1, 2, 3<span style="color: #3a81c3;">]</span>
<span style="color: #715ab1;">b</span> = <span style="color: #3a81c3;">[</span><span style="color: #2d9574;">'w'</span>, <span style="color: #2d9574;">'x'</span>, <span style="color: #2d9574;">'y'</span>, <span style="color: #2d9574;">'z'</span><span style="color: #3a81c3;">]</span>

<span style="color: #3a81c3; font-weight: bold;">for</span> i <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">zip</span><span style="color: #3a81c3;">(</span>a, b<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>i<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; (1, 'w') (2, 'x') (3, 'y')</span>

<span style="color: #3a81c3; font-weight: bold;">from</span> itertools <span style="color: #3a81c3; font-weight: bold;">import</span> zip_longest
<span style="color: #3a81c3; font-weight: bold;">for</span> i <span style="color: #3a81c3; font-weight: bold;">in</span> zip_longest<span style="color: #3a81c3;">(</span>a, b<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>i<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; (1, 'w') (2, 'x') (3, 'y') (None, 'z')</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org676c45a" class="outline-3">
<h3 id="org676c45a"><span class="section-number-3">5.3</span> <code>dropwhile</code></h3>
<div class="outline-text-3" id="text-5-3">
<p>
Drop all of the initial comment lines.
</p>
</div>
</div>

<div id="outline-container-org2a87ecd" class="outline-3">
<h3 id="org2a87ecd"><span class="section-number-3">5.4</span> Permutation &amp; Combination</h3>
<div class="outline-text-3" id="text-5-4">
<ul class="org-ul">
<li><code>combinations</code>, <code>permutations</code>, <code>combinations_with_replacement</code></li>
</ul>
</div>
</div>

<div id="outline-container-org1c24420" class="outline-3">
<h3 id="org1c24420"><span class="section-number-3">5.5</span> <code>itertools.chain</code></h3>
<div class="outline-text-3" id="text-5-5">
<p>
Concatenate two iterables(copy-free)
</p>
</div>
</div>
<div id="outline-container-orgb813eb0" class="outline-3">
<h3 id="orgb813eb0"><span class="section-number-3">5.6</span> Data Processing Pipelines</h3>
</div>
<div id="outline-container-orgb0ab4fa" class="outline-3">
<h3 id="orgb0ab4fa"><span class="section-number-3">5.7</span> Flattening a Nested Sequence</h3>
<div class="outline-text-3" id="text-5-7">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> collections <span style="color: #3a81c3; font-weight: bold;">import</span> Iterable


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">flatten</span><span style="color: #3a81c3;">(</span>items, ignore_types=<span style="color: #6c3163;">(</span><span style="color: #3a81c3;">str</span>, <span style="color: #3a81c3;">bytes</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">for</span> x <span style="color: #3a81c3; font-weight: bold;">in</span> items:
	<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">isinstance</span><span style="color: #3a81c3;">(</span>x, Iterable<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3; font-weight: bold;">and</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3;">isinstance</span><span style="color: #3a81c3;">(</span>x, ignore_types<span style="color: #3a81c3;">)</span>:
	    <span style="color: #3a81c3; font-weight: bold;">yield</span> <span style="color: #3a81c3; font-weight: bold;">from</span> flatten<span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">else</span>:
	    <span style="color: #3a81c3; font-weight: bold;">yield</span> x

<span style="color: #715ab1;">items</span> = <span style="color: #3a81c3;">[</span><span style="color: #2d9574;">'Dave'</span>, <span style="color: #2d9574;">'Paula'</span>, <span style="color: #6c3163;">[</span><span style="color: #2d9574;">'Thomas'</span>, <span style="color: #2d9574;">'Lewis'</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">]</span>
<span style="color: #3a81c3; font-weight: bold;">for</span> x <span style="color: #3a81c3; font-weight: bold;">in</span> flatten<span style="color: #3a81c3;">(</span>items<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orga1fcf83" class="outline-3">
<h3 id="orga1fcf83"><span class="section-number-3">5.8</span> Merge Two Sorted Iterables</h3>
<div class="outline-text-3" id="text-5-8">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> heapq
<span style="color: #715ab1;">a</span> = <span style="color: #3a81c3;">[</span>1, 4, 7, 10<span style="color: #3a81c3;">]</span>
<span style="color: #715ab1;">b</span> = <span style="color: #3a81c3;">[</span>2, 5, 6, 11<span style="color: #3a81c3;">]</span>
<span style="color: #3a81c3; font-weight: bold;">for</span> c <span style="color: #3a81c3; font-weight: bold;">in</span> heapq.merge<span style="color: #3a81c3;">(</span>a, b<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>c<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org30744f2" class="outline-3">
<h3 id="org30744f2"><span class="section-number-3">5.9</span> <code>iter()</code></h3>
<div class="outline-text-3" id="text-5-9">
<p>
<a id="org4cb2508"></a>
<code>iter()</code> optionally accepts a zero-argument <b>callable</b> and <b>sentinel</b> (terminating) value as inputs.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">for</span> chunk <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">iter</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span>: fs.read<span style="color: #6c3163;">(</span>10<span style="color: #6c3163;">)</span>, <span style="color: #2d9574;">''</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>chunk<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org2f40139" class="outline-2">
<h2 id="org2f40139"><span class="section-number-2">6</span> I/O</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orgdfa7fc2" class="outline-3">
<h3 id="orgdfa7fc2"><span class="section-number-3">6.1</span> Encoding</h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'somefile.txt'</span>, <span style="color: #2d9574;">'rt'</span>, encoding=<span style="color: #2d9574;">'latin-1'</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3; font-weight: bold;">as</span> f:
    ...
</pre>
</div>
<p>
<b>latin-1</b> encoding is notable in that it will never produce a decoding error when reading text of a possibly unknown encoding.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Replace bad chars with Unicode U+fffd replacement char</span>
<span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'sample.txt'</span>, <span style="color: #2d9574;">'rt'</span>, encoding=<span style="color: #2d9574;">'ascii'</span>, errors=<span style="color: #2d9574;">'replace'</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ignore bad chars entirely</span>
<span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'sample.txt'</span>, <span style="color: #2d9574;">'rt'</span>, encoding=<span style="color: #2d9574;">'ascii'</span>, errors=<span style="color: #2d9574;">'ignore'</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgab8d2a5" class="outline-3">
<h3 id="orgab8d2a5"><span class="section-number-3">6.2</span> <code>readinto</code></h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> array
<span style="color: #715ab1;">a</span> = array.array<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'i'</span>, <span style="color: #6c3163;">[</span>0, 0, 0, 0, 0, 0, 0, 0<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'data.bin'</span>, <span style="color: #2d9574;">'rb'</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3; font-weight: bold;">as</span> f:
    f.readinto<span style="color: #3a81c3;">(</span>a<span style="color: #3a81c3;">)</span>
</pre>
</div>
<p>
<code>readinto()</code> fills the contents of an existing buffer
</p>
<ul class="org-ul">
<li>One caution with using <code>f.readinto()~</code> is that you must always make sure to check its return code, which is the number of bytes actually read.</li>
</ul>
</div>
</div>
<div id="outline-container-org38eeb43" class="outline-3">
<h3 id="org38eeb43"><span class="section-number-3">6.3</span> <code>io.StringIO</code>, <code>io.BytesIO</code></h3>
</div>
<div id="outline-container-org578a9b2" class="outline-3">
<h3 id="org578a9b2"><span class="section-number-3">6.4</span> <code>gzip.open</code>, <code>bz2.open</code></h3>
</div>
<div id="outline-container-orgf553ea1" class="outline-3">
<h3 id="orgf553ea1"><span class="section-number-3">6.5</span> Iterating Over Fixed-Sized Records</h3>
<div class="outline-text-3" id="text-6-5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> functools <span style="color: #3a81c3; font-weight: bold;">import</span> partial

<span style="color: #715ab1;">RECORD_SIZE</span> = 32

<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'somefile.data'</span>, <span style="color: #2d9574;">'rb'</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3; font-weight: bold;">as</span> f:
    <span style="color: #715ab1;">records</span> = <span style="color: #3a81c3;">iter</span><span style="color: #3a81c3;">(</span>partial<span style="color: #6c3163;">(</span>f.read, RECORD_SIZE<span style="color: #6c3163;">)</span>, b<span style="color: #2d9574;">''</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">for</span> r <span style="color: #3a81c3; font-weight: bold;">in</span> records:
	...
</pre>
</div>
<ul class="org-ul">
<li><a href="#org4cb2508">5.9</a></li>
</ul>
</div>
</div>

<div id="outline-container-org9bebf19" class="outline-3">
<h3 id="org9bebf19"><span class="section-number-3">6.6</span> In-memory Modification</h3>
<div class="outline-text-3" id="text-6-6">
</div>
<div id="outline-container-orge4e67aa" class="outline-4">
<h4 id="orge4e67aa"><span class="section-number-4">6.6.1</span> <code>nmap</code></h4>
<div class="outline-text-4" id="text-6-6-1">
<p>
Use the <code>mmap</code> module to memory map files for random access to its contents or to make in-place modifications.
</p>
<ul class="org-ul">
<li><code>nmap</code> also can be used to exchange data between interpreters</li>
</ul>
</div>
</div>

<div id="outline-container-orge8bc057" class="outline-4">
<h4 id="orge8bc057"><span class="section-number-4">6.6.2</span> <code>memoryview</code></h4>
<div class="outline-text-4" id="text-6-6-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">buf</span> = <span style="color: #3a81c3;">bytearray</span><span style="color: #3a81c3;">(</span>b<span style="color: #2d9574;">'Hello World'</span><span style="color: #3a81c3;">)</span>
<span style="color: #715ab1;">m1</span> = <span style="color: #3a81c3;">memoryview</span><span style="color: #3a81c3;">(</span>buf<span style="color: #3a81c3;">)</span>
<span style="color: #715ab1;">m2</span> = m1<span style="color: #3a81c3;">[</span>-5:<span style="color: #3a81c3;">]</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">m2=&gt; &lt;memory at 0x100681390&gt;</span>
<span style="color: #715ab1;">m2</span><span style="color: #3a81c3;">[</span>:<span style="color: #3a81c3;">]</span> = b<span style="color: #2d9574;">'WORLD'</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">buf=&gt; bytearray(b'Hello WORLD')</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf650b36" class="outline-3">
<h3 id="orgf650b36"><span class="section-number-3">6.7</span> <code>os.path</code></h3>
<div class="outline-text-3" id="text-6-7">
<div class="org-src-container">
<pre class="src src-python">os.path.basename<span style="color: #3a81c3;">(</span>path<span style="color: #3a81c3;">)</span>
os.path.dirname<span style="color: #3a81c3;">(</span>path<span style="color: #3a81c3;">)</span>
os.path.expanduser<span style="color: #3a81c3;">(</span>path<span style="color: #3a81c3;">)</span>
os.path.splitext<span style="color: #3a81c3;">(</span>path<span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Split the file extension</span>
os.path.exists<span style="color: #3a81c3;">(</span>path<span style="color: #3a81c3;">)</span>
os.path.isfile<span style="color: #3a81c3;">(</span>path<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">isdir, islink</span>
os.path.realpath<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'/usr/local/bin/python3'</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; '/usr/local/bin/python3.3'</span>
os.path.getsize<span style="color: #3a81c3;">()</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">getmtime</span>
os.listdir<span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">dir</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<ul class="org-ul">
<li>other module: <code>glob</code>, <code>fnmatch</code> used for filename matching</li>
</ul>
</div>
</div>
<div id="outline-container-org990f2e0" class="outline-3">
<h3 id="org990f2e0"><span class="section-number-3">6.8</span> Changing Encoding of a File</h3>
<div class="outline-text-3" id="text-6-8">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> io
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">decode a binary file</span>
<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'some_binary_file.bin'</span>, <span style="color: #2d9574;">'rb'</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3; font-weight: bold;">as</span> open_file:
    <span style="color: #715ab1;">fs</span> = io.TextIOWrapper<span style="color: #3a81c3;">(</span>open_file, encoding=<span style="color: #2d9574;">'utf8'</span><span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">text</span> = fs.read<span style="color: #3a81c3;">()</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">change encoding</span>
<span style="color: #3a81c3; font-weight: bold;">import</span> sys
sys.stdout.encoding  <span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 'UTF-8'</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">use its detach() method to remove the existing text encoding layer before replacing it with a new one</span>
<span style="color: #715ab1;">sys.stdout</span> = io.TextIOWrapper<span style="color: #3a81c3;">(</span>sys.stdout.detach<span style="color: #6c3163;">()</span>, encoding=<span style="color: #2d9574;">'latin-1'</span><span style="color: #3a81c3;">)</span>
sys.stdout.encoding <span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 'latin-1'</span>
</pre>
</div>
<ul class="org-ul">
<li>layers on I/O:</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">f</span> = <span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'sample.txt'</span>, <span style="color: #2d9574;">'w'</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">a text-handling layer that encodes and decodes Unicode</span>
f <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; &lt;_io.TextIOWrapper name='sample.txt' mode='w' encoding='UTF-8'&gt;</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">a buffered I/O layer that handles binary data</span>
f.<span style="color: #3a81c3;">buffer</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; &lt;_io.BufferedWriter name='sample.txt'&gt;</span>
f.<span style="color: #3a81c3;">buffer</span>.write<span style="color: #3a81c3;">(</span>b<span style="color: #2d9574;">'hello\n'</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">write bytes to a text file</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">io.FileIO is a raw file representing the low-level file descriptor in the operating system</span>
f.<span style="color: #3a81c3;">buffer</span>.raw <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; &lt;_io.FileIO name='sample.txt' mode='wb'&gt;</span>
</pre>
</div>
<ul class="org-ul">
<li><code>detach</code>: disconnects the topmost layer of a file and returns the next lower layer.</li>
</ul>
</div>
</div>

<div id="outline-container-org114453b" class="outline-3">
<h3 id="org114453b"><span class="section-number-3">6.9</span> File Descriptor</h3>
<div class="outline-text-3" id="text-6-9">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Create a file object, but don't close underlying fd when done</span>
<span style="color: #715ab1;">f</span> = <span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span>fd, <span style="color: #2d9574;">'wt'</span>, closefd=<span style="color: #4e3163;">False</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">echo_client</span><span style="color: #3a81c3;">(</span>client_sock, addr<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Got connection from'</span>, addr<span style="color: #3a81c3;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Make text-mode file wrappers for socket reading/writing, only works on Unix-based systems</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Use the makefile() method of sockets instead to be cross platform</span>
    <span style="color: #715ab1;">client_in</span> = <span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span>client_sock.fileno<span style="color: #6c3163;">()</span>, <span style="color: #2d9574;">'rt'</span>, encoding=<span style="color: #2d9574;">'latin-1'</span>,
			 closefd=<span style="color: #4e3163;">False</span><span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">client_out</span> = <span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span>client_sock.fileno<span style="color: #6c3163;">()</span>, <span style="color: #2d9574;">'wt'</span>, encoding=<span style="color: #2d9574;">'latin-1'</span>,
			  closefd=<span style="color: #4e3163;">False</span><span style="color: #3a81c3;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Echo lines back to the client using file I/O</span>
    <span style="color: #3a81c3; font-weight: bold;">for</span> line <span style="color: #3a81c3; font-weight: bold;">in</span> client_in:
	client_out.write<span style="color: #3a81c3;">(</span>line<span style="color: #3a81c3;">)</span>
	client_out.flush<span style="color: #3a81c3;">()</span>
    client_sock.close<span style="color: #3a81c3;">()</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6343c21" class="outline-3">
<h3 id="org6343c21"><span class="section-number-3">6.10</span> Temporary Files</h3>
<div class="outline-text-3" id="text-6-10">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> tempfile <span style="color: #3a81c3; font-weight: bold;">import</span> TemporaryFile, NamedTemporaryFile, TemporaryDirectory
<span style="color: #3a81c3; font-weight: bold;">with</span> TemporaryFile<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'w+t'</span>, encoding=<span style="color: #2d9574;">'utf-8'</span>, errors=<span style="color: #2d9574;">'ignore'</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3; font-weight: bold;">as</span> f:
    f.write<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Hello World\n'</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">with</span> NamedTemporaryFile<span style="color: #3a81c3;">(</span>
	<span style="color: #2d9574;">'w+t'</span>, delete=<span style="color: #4e3163;">False</span>, prefix=<span style="color: #2d9574;">'mytemp'</span>, suffix=<span style="color: #2d9574;">'.txt'</span>, <span style="color: #3a81c3;">dir</span>=<span style="color: #2d9574;">'/tmp'</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3; font-weight: bold;">as</span> f:
    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'filename is:'</span>, f.name<span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; /tmp/mytemp2tmz4nl5.txt</span>

<span style="color: #3a81c3; font-weight: bold;">with</span> TemporaryDirectory<span style="color: #3a81c3;">()</span> <span style="color: #3a81c3; font-weight: bold;">as</span> dirname:
    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'dirname is:'</span>, dirname<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc8d8794" class="outline-3">
<h3 id="orgc8d8794"><span class="section-number-3">6.11</span> Serializing Python Objects</h3>
<div class="outline-text-3" id="text-6-11">
<p>
<code>pickle</code> is a Python-specific self-describing data encoding
</p>
</div>
<div id="outline-container-orga0e07c1" class="outline-4">
<h4 id="orga0e07c1"><span class="section-number-4">6.11.1</span> Dealing with Multiple Objects</h4>
<div class="outline-text-4" id="text-6-11-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> pickle
<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'somedata'</span>, <span style="color: #2d9574;">'wb'</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3; font-weight: bold;">as</span> fs:
    pickle.dump<span style="color: #3a81c3;">(</span><span style="color: #6c3163;">[</span>1, 2, 3, 4<span style="color: #6c3163;">]</span>, fs<span style="color: #3a81c3;">)</span>
    pickle.dump<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'hello'</span>, fs<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'somedata'</span>, <span style="color: #2d9574;">'rb'</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3; font-weight: bold;">as</span> fs:
    pickle.load<span style="color: #3a81c3;">(</span>fs<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; [1, 2, 3, 4]</span>
    pickle.load<span style="color: #3a81c3;">(</span>fs<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; hello</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org406fea8" class="outline-4">
<h4 id="org406fea8"><span class="section-number-4">6.11.2</span> Safety</h4>
<div class="outline-text-4" id="text-6-11-2">
<p>
<code>pickle.load()</code> should never be used on untrusted data
</p>
</div>
</div>

<div id="outline-container-org56353f9" class="outline-4">
<h4 id="org56353f9"><span class="section-number-4">6.11.3</span> User-defined Classes</h4>
<div class="outline-text-4" id="text-6-11-3">
<p>
Certain kinds of objects can’t be pickled. These are typically objects that involve some sort of external system state, such as open files,
open network connections, threads, processes, stack frames, and so forth. User-defined classes can sometimes work around these limitations
by providing <code>__getstate__()</code> and <code>__setstate__()</code> methods
</p>
<ul class="org-ul">
<li><code>pickle.dump()</code> will call <code>__getstate__()</code> to get an object that can be pickled</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-orgabd4765" class="outline-2">
<h2 id="orgabd4765"><span class="section-number-2">7</span> Encoding</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org9f70d54" class="outline-3">
<h3 id="org9f70d54"><span class="section-number-3">7.1</span> csv</h3>
<div class="outline-text-3" id="text-7-1">
</div>
<div id="outline-container-org0379a54" class="outline-4">
<h4 id="org0379a54"><span class="section-number-4">7.1.1</span> <code>reader</code></h4>
<div class="outline-text-4" id="text-7-1-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> collections <span style="color: #3a81c3; font-weight: bold;">import</span> namedtuple
<span style="color: #3a81c3; font-weight: bold;">import</span> re
<span style="color: #3a81c3; font-weight: bold;">import</span> csv
<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'stock.csv'</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3; font-weight: bold;">as</span> f:
    <span style="color: #715ab1;">f_csv</span> = csv.reader<span style="color: #3a81c3;">(</span>f<span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">headings</span> = <span style="color: #3a81c3;">next</span><span style="color: #3a81c3;">(</span>f_csv<span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">Row</span> = namedtuple<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Row'</span>, headings<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">for</span> r <span style="color: #3a81c3; font-weight: bold;">in</span> f_csv:
	<span style="color: #715ab1;">row</span> = Row<span style="color: #3a81c3;">(</span>*r<span style="color: #3a81c3;">)</span>
	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Process row</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org94f4571" class="outline-4">
<h4 id="org94f4571"><span class="section-number-4">7.1.2</span> <code>DictReader</code></h4>
<div class="outline-text-4" id="text-7-1-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> csv
<span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'stocks.csv'</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3; font-weight: bold;">as</span> f:
    <span style="color: #715ab1;">f_csv</span> = csv.DictReader<span style="color: #3a81c3;">(</span>f<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">for</span> row <span style="color: #3a81c3; font-weight: bold;">in</span> f_csv:
	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">process row</span>
	...
</pre>
</div>
</div>
</div>

<div id="outline-container-org4a786d1" class="outline-4">
<h4 id="org4a786d1"><span class="section-number-4">7.1.3</span> <code>writer</code></h4>
<div class="outline-text-4" id="text-7-1-3">
<ul class="org-ul">
<li><code>writer.writerow</code> and <code>writer.writerows</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgeebd5b6" class="outline-4">
<h4 id="orgeebd5b6"><span class="section-number-4">7.1.4</span> <code>DictWriter</code></h4>
<div class="outline-text-4" id="text-7-1-4">
<ul class="org-ul">
<li><code>writer.writeheader</code> and <code>writer.writerows</code></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org0540bfa" class="outline-3">
<h3 id="org0540bfa"><span class="section-number-3">7.2</span> json2object</h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li>use <code>object_pairs_hook</code> and <code>object_hook</code> options</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> json
<span style="color: #3a81c3; font-weight: bold;">from</span> collections <span style="color: #3a81c3; font-weight: bold;">import</span> OrderedDict
<span style="color: #715ab1;">s</span> = <span style="color: #2d9574;">'{"name": "ACME", "shares": 50, "price": 490.1}'</span>
<span style="color: #715ab1;">data</span> = json.loads<span style="color: #3a81c3;">(</span>s, object_pairs_hook=OrderedDict<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">data =&gt; OrderedDict([('name', 'ACME'), ('shares', 50), ('price', 490.1)])</span>

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">JSONObject</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, d<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.<span style="color: #3a81c3;">__dict__</span> = d

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__str__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">str</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>.<span style="color: #3a81c3;">__dict__</span><span style="color: #3a81c3;">)</span>


<span style="color: #715ab1;">obj</span> = json.loads<span style="color: #3a81c3;">(</span>s, object_hook=JSONObject<span style="color: #3a81c3;">)</span>
<span style="color: #715ab1;">obj.name</span> = <span style="color: #2d9574;">'def'</span>

json.dumps<span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">vars</span><span style="color: #6c3163;">(</span>obj<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">vars(obj) same as obj.__dict__</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">or</span>
json.dumps<span style="color: #3a81c3;">(</span>obj, default=<span style="color: #3a81c3;">vars</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">use vars as a serializing function</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6e82f81" class="outline-3">
<h3 id="org6e82f81"><span class="section-number-3">7.3</span> xml</h3>
<div class="outline-text-3" id="text-7-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> xml.etree.ElementTree <span style="color: #3a81c3; font-weight: bold;">import</span> parse
<span style="color: #715ab1;">doc</span> = parse<span style="color: #3a81c3;">(</span>xml_str<span style="color: #3a81c3;">)</span>
</pre>
</div>
<ul class="org-ul">
<li><code>lxml</code></li>
<li>for huge xml: <code>Recipe 6.4</code></li>
<li>more: <code>Recipe 6.3~6.7</code></li>
</ul>
</div>
</div>

<div id="outline-container-org1265f27" class="outline-3">
<h3 id="org1265f27"><span class="section-number-3">7.4</span> hex encoding</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li><code>binascii</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> binascii

<span style="color: #715ab1;">s</span> = b<span style="color: #2d9574;">'hello'</span>
<span style="color: #715ab1;">h</span> = binascii.b2a_hex<span style="color: #3a81c3;">(</span>s<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">bytes2hexbytes b'68656c6c6f'</span>
<span style="color: #715ab1;">b</span> = binascii.a2b_hex<span style="color: #3a81c3;">(</span>h<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">hexbytes2bytes</span>
</pre>
</div>
<ul class="org-ul">
<li><code>base64</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> base64
<span style="color: #715ab1;">s</span> = b<span style="color: #2d9574;">'hello'</span>
<span style="color: #715ab1;">h</span> = base64.b16encode<span style="color: #3a81c3;">(</span>s<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">b'68656C6C6F' uppercase</span>
<span style="color: #715ab1;">b</span> = base64.b16decode<span style="color: #3a81c3;">(</span>h<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5723ce1" class="outline-3">
<h3 id="org5723ce1"><span class="section-number-3">7.5</span> base64</h3>
<div class="outline-text-3" id="text-7-5">
<ul class="org-ul">
<li><code>base64.b64encode</code></li>
<li><code>base64.b64decode</code></li>
</ul>
</div>
</div>

<div id="outline-container-org67bb827" class="outline-3">
<h3 id="org67bb827"><span class="section-number-3">7.6</span> struct</h3>
<div class="outline-text-3" id="text-7-6">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> struct <span style="color: #3a81c3; font-weight: bold;">import</span> Struct

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">write_records</span><span style="color: #3a81c3;">(</span>records: <span style="color: #3a81c3;">tuple</span>, <span style="color: #3a81c3;">format</span>, f<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">record_struct</span> = Struct<span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">format</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">for</span> r <span style="color: #3a81c3; font-weight: bold;">in</span> records:
	f.write<span style="color: #3a81c3;">(</span>record_struct.pack<span style="color: #6c3163;">(</span>*r<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">read_records</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">format</span>, f<span style="color: #3a81c3;">)</span> -&gt; <span style="color: #3a81c3;">tuple</span>:
    <span style="color: #715ab1;">record_struct</span> = Struct<span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">format</span><span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">chunks</span> = <span style="color: #3a81c3;">iter</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span>: f.read<span style="color: #6c3163;">(</span>record_struct.size<span style="color: #6c3163;">)</span>, b<span style="color: #2d9574;">''</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">star!</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">(</span>record_struct.unpack<span style="color: #6c3163;">(</span>chunk<span style="color: #6c3163;">)</span> <span style="color: #3a81c3; font-weight: bold;">for</span> chunk <span style="color: #3a81c3; font-weight: bold;">in</span> chunks<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">star!</span>

</pre>
</div>
<ul class="org-ul">
<li>more to explore <code>Recipe 6.12</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org5f22c69" class="outline-2">
<h2 id="org5f22c69"><span class="section-number-2">8</span> Functions</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-org442404a" class="outline-3">
<h3 id="org442404a"><span class="section-number-3">8.1</span> Keyword-only Arguments</h3>
<div class="outline-text-3" id="text-8-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">recv</span><span style="color: #3a81c3;">(</span>maxsize, *, block<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">pass</span>

recv<span style="color: #3a81c3;">(</span>1024, <span style="color: #4e3163;">True</span><span style="color: #3a81c3;">)</span><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">TypeError</span>
recv<span style="color: #3a81c3;">(</span>1024, block=<span style="color: #4e3163;">True</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">OK</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org867dbca" class="outline-3">
<h3 id="org867dbca"><span class="section-number-3">8.2</span> Capture Variables</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">x</span> = 10
<span style="color: #715ab1;">a</span> = <span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #715ab1;">y</span>, <span style="color: #715ab1;">x</span>=x: x + y <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">use x=x to bind at definition time</span>
<span style="color: #715ab1;">x</span> = 20
a<span style="color: #3a81c3;">(</span>5<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 15</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0ffa3fe" class="outline-3">
<h3 id="org0ffa3fe"><span class="section-number-3">8.3</span> Replace Single-method Classes with Closures</h3>
</div>

<div id="outline-container-org2ecb434" class="outline-3">
<h3 id="org2ecb434"><span class="section-number-3">8.4</span> Callback Shared State</h3>
<div class="outline-text-3" id="text-8-4">
<p>
<code>Recipe 7.10</code> four ways:
</p>
<ul class="org-ul">
<li>single-method class</li>
<li>closure</li>
<li>coroutine: use coroutine.send as callback</li>
<li>use <code>functools.partial</code></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgad848dd" class="outline-2">
<h2 id="orgad848dd"><span class="section-number-2">9</span> Class</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-orga998ef6" class="outline-3">
<h3 id="orga998ef6"><span class="section-number-3">9.1</span> String Representation</h3>
<div class="outline-text-3" id="text-9-1">
<ul class="org-ul">
<li><code>__repr__</code>: returns the code representation of an instance, and is usually the text you would type to recreate the instance. <code>eval(repr(x)) == x</code></li>
<li><code>__str__</code>: converts the instance to a string.</li>
</ul>
</div>
</div>

<div id="outline-container-orgc609442" class="outline-3">
<h3 id="orgc609442"><span class="section-number-3">9.2</span> <code>__format__</code></h3>
<div class="outline-text-3" id="text-9-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">_formats</span> = <span style="color: #3a81c3;">{</span>
    <span style="color: #2d9574;">'ymd'</span> : <span style="color: #2d9574;">'{d.year}-{d.month}-{d.day}'</span>,
    <span style="color: #2d9574;">'mdy'</span> : <span style="color: #2d9574;">'{d.month}/{d.day}/{d.year}'</span>,
    <span style="color: #2d9574;">'dmy'</span> : <span style="color: #2d9574;">'{d.day}/{d.month}/{d.year}'</span>
    <span style="color: #3a81c3;">}</span>
<span style="color: #3a81c3; font-weight: bold;">from</span> datetime <span style="color: #3a81c3; font-weight: bold;">import</span> date
<span style="color: #715ab1;">d</span> = date.today<span style="color: #3a81c3;">()</span>
<span style="color: #3a81c3;">format</span><span style="color: #3a81c3;">(</span>d, <span style="color: #2d9574;">'mdy'</span><span style="color: #3a81c3;">)</span>
<span style="color: #2d9574;">'The date is {:ymd}'</span>.<span style="color: #3a81c3;">format</span><span style="color: #3a81c3;">(</span>d<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6fe8796" class="outline-3">
<h3 id="org6fe8796"><span class="section-number-3">9.3</span> Context Management</h3>
<div class="outline-text-3" id="text-9-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Connection</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__enter__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.fs = <span style="color: #3a81c3;">open</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'somefile.txt'</span>, <span style="color: #2d9574;">'rt'</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.fs

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__exit__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, exc_ty, exc_val, tb<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.fs.close<span style="color: #3a81c3;">()</span>
	<span style="color: #3a81c3; font-weight: bold;">self</span>.fs = <span style="color: #4e3163;">None</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge6fa849" class="outline-3">
<h3 id="orge6fa849"><span class="section-number-3">9.4</span> Saving Memory <code>__slots__</code></h3>
<div class="outline-text-3" id="text-9-4">
<ul class="org-ul">
<li>Instances are built around a small fixed-sized array instead of a dictionary.</li>
<li>A side effect of using slots is that it is no longer possible to add new attributes to instances.</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Date</span>:
    <span style="color: #715ab1;">__slots__</span> = <span style="color: #3a81c3;">[</span><span style="color: #2d9574;">'year'</span>, <span style="color: #2d9574;">'month'</span>, <span style="color: #2d9574;">'day'</span><span style="color: #3a81c3;">]</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, year, month, day<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.year = year
	<span style="color: #3a81c3; font-weight: bold;">self</span>.month = month
	<span style="color: #3a81c3; font-weight: bold;">self</span>.day = day
</pre>
</div>
</div>
</div>

<div id="outline-container-org7dec963" class="outline-3">
<h3 id="org7dec963"><span class="section-number-3">9.5</span> Properties</h3>
<div class="outline-text-3" id="text-9-5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Object</span>:
    @<span style="color: #3a81c3;">property</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">attr</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.__attr

    <span style="color: #ba2f59; font-weight: bold;">@attr.setter</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">attr</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, value<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.__attr = value

    <span style="color: #ba2f59; font-weight: bold;">@attr.deleter</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">attr</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.__attr = <span style="color: #4e3163;">None</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">del obj.attr</span>
</pre>
</div>
</div>
<div id="outline-container-org59ec443" class="outline-4">
<h4 id="org59ec443"><span class="section-number-4">9.5.1</span> Extending a Property</h4>
<div class="outline-text-4" id="text-9-5-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">SubPerson</span><span style="color: #3a81c3;">(</span>Person<span style="color: #3a81c3;">)</span>:
    @<span style="color: #3a81c3;">property</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">name</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Getting name'</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.name

    <span style="color: #ba2f59; font-weight: bold;">@name.setter</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">name</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, value<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Setting name to'</span>, value<span style="color: #3a81c3;">)</span>
	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the only way to get to setter method is to access it as a class variable</span>
	<span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">(</span>SubPerson, SubPerson<span style="color: #3a81c3;">)</span>.name.__set__<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, value<span style="color: #3a81c3;">)</span>

    <span style="color: #ba2f59; font-weight: bold;">@name.deleter</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">name</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Deleting name'</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">(</span>SubPerson, SubPerson<span style="color: #3a81c3;">)</span>.name.__delete__<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<ul class="org-ul">
<li><p>
Extending only <code>getter</code> method
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">SubPerson</span><span style="color: #3a81c3;">(</span>Person<span style="color: #3a81c3;">)</span>:
    <span style="color: #ba2f59; font-weight: bold;">@Person.name.getter</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">name</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Getting name'</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.name
</pre>
</div></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org2f6bccf" class="outline-3">
<h3 id="org2f6bccf"><span class="section-number-3">9.6</span> <code>super()</code></h3>
<div class="outline-text-3" id="text-9-6">
<ul class="org-ul">
<li>To avoid double-invocation when involving multiple inheritance.</li>
<li>Use <code>__mro__</code> to see method resolution order.</li>
</ul>
</div>

<div id="outline-container-org9adad0f" class="outline-4">
<h4 id="org9adad0f"><span class="section-number-4">9.6.1</span> MRO</h4>
<div class="outline-text-4" id="text-9-6-1">
<p>
The actual determination of the MRO list itself is made using a technique known as C3 Linearization.
</p>
<ul class="org-ul">
<li>Child classes get checked before parents.</li>
<li>Multiple parents get checked in the order listed.</li>
<li>If there are two valid choices for the next class, pick the one from the first parent.</li>
</ul>
<p>
When you use the <code>super()</code> function, Python continues its search starting with the next class on the MRO. See Chapter 8.7 <a href="https://rhettinger.wordpress.com/2011/05/26/super-considered-super/">More details</a>.
</p>

<ul class="org-ul">
<li>Hint: <code>super(MyClass, self).__init__()</code> provides the next <code>__init__</code> method according to the used Method Resolution Ordering(MRO)</li>
</ul>
</div>
</div>
<div id="outline-container-orgc128841" class="outline-4">
<h4 id="orgc128841"><span class="section-number-4">9.6.2</span> Multiple Inheritance with Different Arguments to Constructors</h4>
<div class="outline-text-4" id="text-9-6-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">A</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, a, **kw<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__init__<span style="color: #3a81c3;">(</span>**kw<span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'A a'</span>, a<span style="color: #3a81c3;">)</span>


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">B</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, b, c=0, **kw<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__init__<span style="color: #3a81c3;">(</span>**kw<span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'B b'</span>, b<span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'B c'</span>, c<span style="color: #3a81c3;">)</span>


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">C</span><span style="color: #3a81c3;">(</span>A, B<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, a, b, c, d<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__init__<span style="color: #3a81c3;">(</span>a=a, b=b, c=c<span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'C d'</span>, d<span style="color: #3a81c3;">)</span>
</pre>
</div>
<p>
or
</p>
<div class="org-src-container">
<pre class="src src-python"> <span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">C</span><span style="color: #3a81c3;">(</span>A, B<span style="color: #3a81c3;">)</span>:
     <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, a, b, c<span style="color: #3a81c3;">)</span>:
	 A.__init__<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, a<span style="color: #3a81c3;">)</span>
	 B.__init__<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, b, c<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">should be careful with double-invocation</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org87d89dd" class="outline-3">
<h3 id="org87d89dd"><span class="section-number-3">9.7</span> <b>Descriptor</b></h3>
<div class="outline-text-3" id="text-9-7">
<p>
Use Descriptor to create a new kind of instance attribute with some extra functionality, such as type checking.
Descriptors provide the underlying magic for most of Python’s class features, such as <code>@classmethod</code>, <code>@staticmethod</code>, <code>@property</code>.
</p>
<ul class="org-ul">
<li><code>__get__(self, instance, cls)</code></li>
<li><code>__set__(self, instance, value)</code></li>
<li><code>__delete__(self, instance)</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">String</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.name = name

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__get__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance, cls<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> instance <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">called as class variable</span>
	    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> instance.<span style="color: #3a81c3;">__dict__</span><span style="color: #3a81c3;">[</span><span style="color: #3a81c3; font-weight: bold;">self</span>.name<span style="color: #3a81c3;">]</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__set__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3;">isinstance</span><span style="color: #3a81c3;">(</span>value, <span style="color: #3a81c3;">str</span><span style="color: #3a81c3;">)</span>:
	    <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Expected a string'</span><span style="color: #3a81c3;">)</span>
	instance.<span style="color: #3a81c3;">__dict__</span><span style="color: #3a81c3;">[</span><span style="color: #3a81c3; font-weight: bold;">self</span>.name<span style="color: #3a81c3;">]</span> = value

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__delete__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">del</span> instance.<span style="color: #3a81c3;">__dict__</span><span style="color: #3a81c3;">[</span><span style="color: #3a81c3; font-weight: bold;">self</span>.name<span style="color: #3a81c3;">]</span>


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Person</span>:
    <span style="color: #715ab1;">name</span> = String<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'name'</span><span style="color: #3a81c3;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
</pre>
</div>
</div>
<div id="outline-container-orge0849ec" class="outline-4">
<h4 id="orge0849ec"><span class="section-number-4">9.7.1</span> Advanced Usage</h4>
<div class="outline-text-4" id="text-9-7-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Descriptor for a type-checked attribute</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Typed</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name, expected_type<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
	<span style="color: #3a81c3; font-weight: bold;">self</span>.expected_type = expected_type

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__get__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance, cls<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> instance <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
	    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>
	<span style="color: #3a81c3; font-weight: bold;">else</span>:
	    <span style="color: #3a81c3; font-weight: bold;">return</span> instance.<span style="color: #3a81c3;">__dict__</span><span style="color: #3a81c3;">[</span><span style="color: #3a81c3; font-weight: bold;">self</span>.name<span style="color: #3a81c3;">]</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__set__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3;">isinstance</span><span style="color: #3a81c3;">(</span>value, <span style="color: #3a81c3; font-weight: bold;">self</span>.expected_type<span style="color: #3a81c3;">)</span>:
	    <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Expected '</span> + <span style="color: #3a81c3;">str</span><span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>.expected_type<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
	instance.<span style="color: #3a81c3;">__dict__</span><span style="color: #3a81c3;">[</span><span style="color: #3a81c3; font-weight: bold;">self</span>.name<span style="color: #3a81c3;">]</span> = value

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__delete__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">del</span> instance.<span style="color: #3a81c3;">__dict__</span><span style="color: #3a81c3;">[</span><span style="color: #3a81c3; font-weight: bold;">self</span>.name<span style="color: #3a81c3;">]</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Class decorator that applies it to selected attributes</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">typeassert</span><span style="color: #3a81c3;">(</span>**kwargs<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">decorate</span><span style="color: #3a81c3;">(</span>cls<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">for</span> name, expected_type <span style="color: #3a81c3; font-weight: bold;">in</span> kwargs.items<span style="color: #3a81c3;">()</span>:
	    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Attach a Typed descriptor to the class</span>
	    <span style="color: #3a81c3;">setattr</span><span style="color: #3a81c3;">(</span>cls, name, Typed<span style="color: #6c3163;">(</span>name, expected_type<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
	    <span style="color: #3a81c3; font-weight: bold;">return</span> cls

    <span style="color: #3a81c3; font-weight: bold;">return</span> decorate


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example use</span>
<span style="color: #ba2f59; font-weight: bold;">@typeassert</span><span style="color: #3a81c3;">(</span>name=<span style="color: #3a81c3;">str</span>, shares=<span style="color: #3a81c3;">int</span>, price=<span style="color: #3a81c3;">float</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Stock</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name, shares, price<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
	<span style="color: #3a81c3; font-weight: bold;">self</span>.shares = shares
	<span style="color: #3a81c3; font-weight: bold;">self</span>.price = price
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb4a3fb8" class="outline-4">
<h4 id="orgb4a3fb8"><span class="section-number-4">9.7.2</span> Lazy Properties</h4>
<div class="outline-text-4" id="text-9-7-2">
<p>
Define a read-only attribute as a property that only gets computed on access.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">lazyproperty</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, func<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.func = func

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__get__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance, cls<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> instance <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
	    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>
	<span style="color: #3a81c3; font-weight: bold;">else</span>:
	    <span style="color: #715ab1;">value</span> = <span style="color: #3a81c3; font-weight: bold;">self</span>.func<span style="color: #3a81c3;">(</span>instance<span style="color: #3a81c3;">)</span>
	    <span style="color: #3a81c3;">setattr</span><span style="color: #3a81c3;">(</span>instance, <span style="color: #3a81c3; font-weight: bold;">self</span>.func.<span style="color: #3a81c3;">__name__</span>, value<span style="color: #3a81c3;">)</span>
	    <span style="color: #3a81c3; font-weight: bold;">return</span> value


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Circle</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, radius<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.radius = radius

    <span style="color: #ba2f59; font-weight: bold;">@lazyproperty</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">area</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Computing area'</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> math.pi * <span style="color: #3a81c3; font-weight: bold;">self</span>.radius**2
</pre>
</div>
</div>
</div>

<div id="outline-container-org6ab0070" class="outline-4">
<h4 id="org6ab0070"><span class="section-number-4">9.7.3</span> Data Model</h4>
<div class="outline-text-4" id="text-9-7-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Base class. Uses a descriptor to set a value</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Descriptor</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name=<span style="color: #4e3163;">None</span>, **opts<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
	<span style="color: #3a81c3; font-weight: bold;">for</span> key, value <span style="color: #3a81c3; font-weight: bold;">in</span> opts.items<span style="color: #3a81c3;">()</span>:
	    <span style="color: #3a81c3;">setattr</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, key, value<span style="color: #3a81c3;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__set__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value<span style="color: #3a81c3;">)</span>:
	instance.<span style="color: #3a81c3;">__dict__</span><span style="color: #3a81c3;">[</span><span style="color: #3a81c3; font-weight: bold;">self</span>.name<span style="color: #3a81c3;">]</span> = value


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Descriptor for enforcing types</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Typed</span><span style="color: #3a81c3;">(</span>Descriptor<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">expected_type</span> = <span style="color: #3a81c3;">type</span><span style="color: #3a81c3;">(</span><span style="color: #4e3163;">None</span><span style="color: #3a81c3;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__set__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3;">isinstance</span><span style="color: #3a81c3;">(</span>value, <span style="color: #3a81c3; font-weight: bold;">self</span>.expected_type<span style="color: #3a81c3;">)</span>:
	    <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'expected '</span> + <span style="color: #3a81c3;">str</span><span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>.expected_type<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__set__<span style="color: #3a81c3;">(</span>instance, value<span style="color: #3a81c3;">)</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Descriptor for enforcing values</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Unsigned</span><span style="color: #3a81c3;">(</span>Descriptor<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__set__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> value &lt; 0:
	    <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">ValueError</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Expected &gt;= 0'</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__set__<span style="color: #3a81c3;">(</span>instance, value<span style="color: #3a81c3;">)</span>


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Integer</span><span style="color: #3a81c3;">(</span>Typed<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">expected_type</span> = <span style="color: #3a81c3;">int</span>


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">UnsignedInteger</span><span style="color: #3a81c3;">(</span>Integer, Unsigned<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">pass</span>
</pre>
</div>
</div>

<ul class="org-ul">
<li><a id="org7911d06"></a>Simplify the Specification by Class Decorator<br />
<div class="outline-text-5" id="text-org7911d06">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Class decorator to apply constraints</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">check_attributes</span><span style="color: #3a81c3;">(</span>**kwargs<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">decorate</span><span style="color: #3a81c3;">(</span>cls<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">for</span> key, value <span style="color: #3a81c3; font-weight: bold;">in</span> kwargs.items<span style="color: #3a81c3;">()</span>:
	    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">isinstance</span><span style="color: #3a81c3;">(</span>value, Descriptor<span style="color: #3a81c3;">)</span>:
		<span style="color: #715ab1;">value.name</span> = key
		<span style="color: #3a81c3;">setattr</span><span style="color: #3a81c3;">(</span>cls, key, value<span style="color: #3a81c3;">)</span>
	    <span style="color: #3a81c3; font-weight: bold;">else</span>:
		<span style="color: #3a81c3;">setattr</span><span style="color: #3a81c3;">(</span>cls, key, value<span style="color: #6c3163;">(</span>key<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> cls
    <span style="color: #3a81c3; font-weight: bold;">return</span> decorate

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example</span>
<span style="color: #ba2f59; font-weight: bold;">@check_attributes</span><span style="color: #3a81c3;">(</span>name=SizedString<span style="color: #6c3163;">(</span>size=8<span style="color: #6c3163;">)</span>,
		  shares=UnsignedInteger,
		  price=UnsignedFloat<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Stock</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name, shares, price<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
	<span style="color: #3a81c3; font-weight: bold;">self</span>.shares = shares
	<span style="color: #3a81c3; font-weight: bold;">self</span>.price = price
</pre>
</div>
</div>
</li>

<li><a id="org7bc4e5b"></a>Simplify the Specification by Metaclass<br />
<div class="outline-text-5" id="text-org7bc4e5b">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">A metaclass that applies checking</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">checkedmeta</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">type</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__new__</span><span style="color: #3a81c3;">(</span>cls, clsname, bases, methods<span style="color: #3a81c3;">)</span>:
	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Attach attribute names to the descriptors</span>
	<span style="color: #3a81c3; font-weight: bold;">for</span> key, value <span style="color: #3a81c3; font-weight: bold;">in</span> methods.items<span style="color: #3a81c3;">()</span>:
	    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">isinstance</span><span style="color: #3a81c3;">(</span>value, Descriptor<span style="color: #3a81c3;">)</span>:
		<span style="color: #715ab1;">value.name</span> = key
	    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">type</span>.__new__<span style="color: #3a81c3;">(</span>cls, clsname, bases, methods<span style="color: #3a81c3;">)</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Stock</span><span style="color: #3a81c3;">(</span>metaclass=checkedmeta<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">name</span> = SizedString<span style="color: #3a81c3;">(</span>size=8<span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">shares</span> = UnsignedInteger<span style="color: #3a81c3;">()</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">no need to give a name</span>
    <span style="color: #715ab1;">price</span> = UnsignedFloat<span style="color: #3a81c3;">()</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name, shares, price<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
	<span style="color: #3a81c3; font-weight: bold;">self</span>.shares = shares
	<span style="color: #3a81c3; font-weight: bold;">self</span>.price = price
</pre>
</div>
</div>
</li>

<li><a id="org390b1f6"></a>Decorator Version(Preferred Approach)<br />
<div class="outline-text-5" id="text-org390b1f6">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Base class. Uses a descriptor to set a value</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Descriptor</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name=<span style="color: #4e3163;">None</span>, **opts<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
	<span style="color: #3a81c3; font-weight: bold;">for</span> key, value <span style="color: #3a81c3; font-weight: bold;">in</span> opts.items<span style="color: #3a81c3;">()</span>:
	    <span style="color: #3a81c3;">setattr</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, key, value<span style="color: #3a81c3;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__set__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value<span style="color: #3a81c3;">)</span>:
	instance.<span style="color: #3a81c3;">__dict__</span><span style="color: #3a81c3;">[</span><span style="color: #3a81c3; font-weight: bold;">self</span>.name<span style="color: #3a81c3;">]</span> = value


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Decorator for applying type checking</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">Typed</span><span style="color: #3a81c3;">(</span>expected_type, cls=<span style="color: #4e3163;">None</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">if</span> cls <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">lambda</span> cls: Typed<span style="color: #3a81c3;">(</span>expected_type, cls<span style="color: #3a81c3;">)</span>

    <span style="color: #715ab1;">super_set</span> = cls.__set__

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__set__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3;">isinstance</span><span style="color: #3a81c3;">(</span>value, expected_type<span style="color: #3a81c3;">)</span>:
	    <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'expected '</span> + <span style="color: #3a81c3;">str</span><span style="color: #6c3163;">(</span>expected_type<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
	super_set<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance, value<span style="color: #3a81c3;">)</span>

    <span style="color: #715ab1;">cls.__set__</span> = __set__
    <span style="color: #3a81c3; font-weight: bold;">return</span> cls


<span style="color: #ba2f59; font-weight: bold;">@Typed</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">int</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Integer</span><span style="color: #3a81c3;">(</span>Descriptor<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">pass</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-org3b9cd73" class="outline-3">
<h3 id="org3b9cd73"><span class="section-number-3">9.8</span> Simplifying Initialization</h3>
<div class="outline-text-3" id="text-9-8">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Structure</span>:
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Class variable that specifies expected fields</span>
    <span style="color: #715ab1;">_fields</span> = <span style="color: #3a81c3;">[]</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, *args<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">len</span><span style="color: #3a81c3;">(</span>args<span style="color: #3a81c3;">)</span> != <span style="color: #3a81c3;">len</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>._fields<span style="color: #3a81c3;">)</span>:
	    <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Expected {} arguments'</span>.<span style="color: #3a81c3;">format</span><span style="color: #6c3163;">(</span><span style="color: #3a81c3;">len</span><span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>._fields<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Set the arguments</span>
	<span style="color: #3a81c3; font-weight: bold;">for</span> name, value <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">zip</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>._fields, args<span style="color: #3a81c3;">)</span>:
	    <span style="color: #3a81c3;">setattr</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name, value<span style="color: #3a81c3;">)</span>


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Stock</span><span style="color: #3a81c3;">(</span>Structure<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">_fields</span> = <span style="color: #3a81c3;">[</span><span style="color: #2d9574;">'name'</span>, <span style="color: #2d9574;">'shares'</span>, <span style="color: #2d9574;">'price'</span><span style="color: #3a81c3;">]</span>
</pre>
</div>
<ul class="org-ul">
<li>Downside: documentation and help features of IDEs. It can be solved by attaching or enforcing a type signature</li>
</ul>
</div>
</div>

<div id="outline-container-org9f3042c" class="outline-3">
<h3 id="org9f3042c"><span class="section-number-3">9.9</span> Abstract Base Class</h3>
<div class="outline-text-3" id="text-9-9">
<ul class="org-ul">
<li>Define an abc class: <code>class AbstractBase(metaclass=abc.ABCMeta)</code></li>
<li>Using <code>register</code> to bind other class which is already defined</li>
<li><code>@abstractmethod</code> can work with <code>@staticmethod</code>, <code>@classmethod</code></li>
</ul>
</div>
</div>

<div id="outline-container-org7a5f37d" class="outline-3">
<h3 id="org7a5f37d"><span class="section-number-3">9.10</span> Implementing Custom Containers</h3>
<div class="outline-text-3" id="text-9-10">
<ul class="org-ul">
<li><code>Container</code>: <code>__contains__</code></li>
<li><code>Iterable</code>: <code>__iter__</code></li>
<li><code>Sized</code>: <code>__len__</code></li>
<li><code>Sequence</code>: <code>__getitem__</code>, <code>__len__</code></li>
<li><code>MutableSequence</code>: <code>__delitem__</code>, <code>__getitem__</code>, <code>__len__</code>, <code>__setitem__</code>, <code>insert</code></li>
</ul>
</div>
</div>

<div id="outline-container-org7056eb7" class="outline-3">
<h3 id="org7056eb7"><span class="section-number-3">9.11</span> Proxy Class</h3>
<div class="outline-text-3" id="text-9-11">
<p>
Implement <code>__getattr__</code>, <code>__setattr__</code>, <code>__delattr__</code>
</p>
<ul class="org-ul">
<li><code>__getattr__</code> method is actually a fallback method that only gets called when an attribute is not found.</li>
</ul>
</div>
</div>

<div id="outline-container-orgf6a6e8b" class="outline-3">
<h3 id="orgf6a6e8b"><span class="section-number-3">9.12</span> Multiple Constructors</h3>
<div class="outline-text-3" id="text-9-12">
<ul class="org-ul">
<li>Use <code>@classmethod</code>, example: <code>Date.today</code></li>
<li>Use <code>cls.__new__(cls)</code> to create instance without initialization.</li>
</ul>
</div>
</div>

<div id="outline-container-org0d8e305" class="outline-3">
<h3 id="org0d8e305"><span class="section-number-3">9.13</span> Mixin Class</h3>
<div class="outline-text-3" id="text-9-13">
<ul class="org-ul">
<li>To enhance the functionality of existing classes with optional features.</li>
<li>See Recipe 8.18, example: <code>ThreadedXMLRPCServer(ThreadingMixIn, SimpleXMLRPCServer)</code></li>
<li>Mixin classes are never meant to be instantiated directly.</li>
<li>Mixin classes typically have no state of their own(not a restriction)</li>
<li>Use <code>__slots__ = ()</code> to serve as a strong hint that the mixin classes do not have their own instance data.</li>
<li>Use class decorator to patch method(preferred approach)</li>
</ul>
</div>
</div>

<div id="outline-container-orgfa83712" class="outline-3">
<h3 id="orgfa83712"><span class="section-number-3">9.14</span> State Machine</h3>
<div class="outline-text-3" id="text-9-14">
<p>
Based on state design pattern. See Recipe 8.19, should use <code>__class__</code>
</p>
</div>
</div>

<div id="outline-container-orgd3fb773" class="outline-3">
<h3 id="orgd3fb773"><span class="section-number-3">9.15</span> Calling a Method by Name</h3>
<div class="outline-text-3" id="text-9-15">
<ul class="org-ul">
<li><code>getattr</code></li>
<li><code>operator.methodcaller()</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgb7c4ec6" class="outline-3">
<h3 id="orgb7c4ec6"><span class="section-number-3">9.16</span> Visitor Pattern</h3>
<div class="outline-text-3" id="text-9-16">
<p>
<b>Recipe 8.21</b>
</p>
</div>
<div id="outline-container-org41525fd" class="outline-4">
<h4 id="org41525fd"><span class="section-number-4">9.16.1</span> <b>Without Recursion</b></h4>
<div class="outline-text-4" id="text-9-16-1">
<p>
<b>Recipe 8.22</b>
</p>
<ul class="org-ul">
<li>Use <b>stack</b> (like depth-first traversal) and generator</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> types


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Node</span>:
    <span style="color: #3a81c3; font-weight: bold;">pass</span>


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">NodeVisitor</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">visit</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, node<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">stack</span> = <span style="color: #3a81c3;">[</span>node<span style="color: #3a81c3;">]</span>
	<span style="color: #715ab1;">last_result</span> = <span style="color: #4e3163;">None</span>
	<span style="color: #3a81c3; font-weight: bold;">while</span> stack:
	    <span style="color: #3a81c3; font-weight: bold;">try</span>:
		<span style="color: #715ab1;">last</span> = stack<span style="color: #3a81c3;">[</span>-1<span style="color: #3a81c3;">]</span>
		<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">isinstance</span><span style="color: #3a81c3;">(</span>last, types.GeneratorType<span style="color: #3a81c3;">)</span>:
		    stack.append<span style="color: #3a81c3;">(</span>last.send<span style="color: #6c3163;">(</span>last_result<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
		    <span style="color: #715ab1;">last_result</span> = <span style="color: #4e3163;">None</span>
		<span style="color: #3a81c3; font-weight: bold;">elif</span> <span style="color: #3a81c3;">isinstance</span><span style="color: #3a81c3;">(</span>last, Node<span style="color: #3a81c3;">)</span>:
		    stack.append<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>._visit<span style="color: #6c3163;">(</span>stack.pop<span style="color: #2d9574;">()</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
		<span style="color: #3a81c3; font-weight: bold;">else</span>:
		    <span style="color: #715ab1;">last_result</span> = stack.pop<span style="color: #3a81c3;">()</span>
	    <span style="color: #3a81c3; font-weight: bold;">except</span> <span style="color: #ba2f59; font-weight: bold;">StopIteration</span>:
		stack.pop<span style="color: #3a81c3;">()</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> last_result


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">_visit</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, node<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">methname</span> = <span style="color: #2d9574;">'visit_'</span> + <span style="color: #3a81c3;">type</span><span style="color: #3a81c3;">(</span>node<span style="color: #3a81c3;">)</span>.<span style="color: #3a81c3;">__name__</span>
    <span style="color: #715ab1;">meth</span> = <span style="color: #3a81c3;">getattr</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, methname, <span style="color: #4e3163;">None</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> meth <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
	<span style="color: #715ab1;">meth</span> = <span style="color: #3a81c3; font-weight: bold;">self</span>.generic_visit
    <span style="color: #3a81c3; font-weight: bold;">return</span> meth<span style="color: #3a81c3;">(</span>node<span style="color: #3a81c3;">)</span>


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">generic_visit</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, node<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">RuntimeError</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'No {} method'</span>.<span style="color: #3a81c3;">format</span><span style="color: #6c3163;">(</span><span style="color: #2d9574;">'visit_'</span> + <span style="color: #3a81c3;">type</span><span style="color: #2d9574;">(</span>node<span style="color: #2d9574;">)</span>.<span style="color: #3a81c3;">__name__</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org250ae89" class="outline-3">
<h3 id="org250ae89"><span class="section-number-3">9.17</span> Comparison</h3>
<div class="outline-text-3" id="text-9-17">
<p>
<code>__le__</code>, <code>__ge__</code>, <code>__lt__</code>, <code>__gt__</code>, <code>__eq__</code>
</p>
</div>
</div>

<div id="outline-container-orge9413d8" class="outline-3">
<h3 id="orge9413d8"><span class="section-number-3">9.18</span> <code>weakref</code></h3>
<div class="outline-text-3" id="text-9-18">
</div>
<div id="outline-container-orgcd84fd1" class="outline-4">
<h4 id="orgcd84fd1"><span class="section-number-4">9.18.1</span> Avoid Cyclic Reference</h4>
<div class="outline-text-4" id="text-9-18-1">
<p>
<code>weakref.ref</code>
</p>
</div>
</div>

<div id="outline-container-org86dff33" class="outline-4">
<h4 id="org86dff33"><span class="section-number-4">9.18.2</span> Cache Instances(like <code>logging.getLogger</code>)</h4>
<div class="outline-text-4" id="text-9-18-2">
<p>
Use <code>weakref.WeakValueDictionary</code> to store instances as weak reference
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbde7bc2" class="outline-2">
<h2 id="orgbde7bc2"><span class="section-number-2">10</span> Metaprogramming</h2>
<div class="outline-text-2" id="text-10">
</div>
<div id="outline-container-org2601886" class="outline-3">
<h3 id="org2601886"><span class="section-number-3">10.1</span> <code>functools.wrap</code></h3>
<div class="outline-text-3" id="text-10-1">
<ul class="org-ul">
<li>Preserving function metadata, <code>__name__</code>, <code>__doc__</code>, <code>__annotations__</code>.</li>
<li>original function in <code>__wrapped__</code> (hint: <code>@classmethod</code> and <code>@staticmethod</code> store original function in <code>__func__</code>)</li>
</ul>
</div>
</div>

<div id="outline-container-orge1e9f22" class="outline-3">
<h3 id="orge1e9f22"><span class="section-number-3">10.2</span> Decorator with get/set</h3>
<div class="outline-text-3" id="text-10-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">attach_wrapper</span><span style="color: #3a81c3;">(</span>obj, func=<span style="color: #4e3163;">None</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">if</span> func <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
	<span style="color: #3a81c3; font-weight: bold;">return</span> partial<span style="color: #3a81c3;">(</span>attach_wrapper, obj<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3;">setattr</span><span style="color: #3a81c3;">(</span>obj, func.<span style="color: #3a81c3;">__name__</span>, func<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> func
</pre>
</div>
</div>
</div>

<div id="outline-container-org00f1eec" class="outline-3">
<h3 id="org00f1eec"><span class="section-number-3">10.3</span> Decorator with Optional Arguments</h3>
<div class="outline-text-3" id="text-10-3">
<p>
example:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> logging
<span style="color: #3a81c3; font-weight: bold;">from</span> functools <span style="color: #3a81c3; font-weight: bold;">import</span> partial, wraps


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">logged</span><span style="color: #3a81c3;">(</span>func=<span style="color: #4e3163;">None</span>, *, level=logging.DEBUG, name=<span style="color: #4e3163;">None</span>, message=<span style="color: #4e3163;">None</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">if</span> func <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
	<span style="color: #3a81c3; font-weight: bold;">return</span> partial<span style="color: #3a81c3;">(</span>logged, level=level, name=name, message=message<span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">logname</span> = name <span style="color: #3a81c3; font-weight: bold;">if</span> name <span style="color: #3a81c3; font-weight: bold;">else</span> func.<span style="color: #3a81c3;">__module__</span>
    <span style="color: #715ab1;">log</span> = logging.getLogger<span style="color: #3a81c3;">(</span>logname<span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">logmsg</span> = message <span style="color: #3a81c3; font-weight: bold;">if</span> message <span style="color: #3a81c3; font-weight: bold;">else</span> func.<span style="color: #3a81c3;">__name__</span>

    <span style="color: #ba2f59; font-weight: bold;">@wraps</span><span style="color: #3a81c3;">(</span>func<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">wrapper</span><span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>:
	log.log<span style="color: #3a81c3;">(</span>level, logmsg<span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> func<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">return</span> wrapper
</pre>
</div>
</div>
</div>

<div id="outline-container-org1951e13" class="outline-3">
<h3 id="org1951e13"><span class="section-number-3">10.4</span> Type Checking Decorator</h3>
<div class="outline-text-3" id="text-10-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> inspect <span style="color: #3a81c3; font-weight: bold;">import</span> signature
<span style="color: #3a81c3; font-weight: bold;">from</span> functools <span style="color: #3a81c3; font-weight: bold;">import</span> wraps


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">typeassert</span><span style="color: #3a81c3;">(</span>*ty_args, **ty_kwargs<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">decorate</span><span style="color: #3a81c3;">(</span>func<span style="color: #3a81c3;">)</span>:
	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">If in optimized mode, disable type checking</span>
	<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #4e3163;">__debug__</span>:
	    <span style="color: #3a81c3; font-weight: bold;">return</span> func
	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Map function argument names to supplied types</span>
	<span style="color: #715ab1;">sig</span> = signature<span style="color: #3a81c3;">(</span>func<span style="color: #3a81c3;">)</span>
	<span style="color: #715ab1;">bound_types</span> = sig.bind_partial<span style="color: #3a81c3;">(</span>*ty_args, **ty_kwargs<span style="color: #3a81c3;">)</span>.arguments

	<span style="color: #ba2f59; font-weight: bold;">@wraps</span><span style="color: #3a81c3;">(</span>func<span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">wrapper</span><span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>:
	    <span style="color: #715ab1;">bound_values</span> = sig.bind<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>
	    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Enforce type assertions across supplied arguments</span>
	    <span style="color: #3a81c3; font-weight: bold;">for</span> name, value <span style="color: #3a81c3; font-weight: bold;">in</span> bound_values.arguments.items<span style="color: #3a81c3;">()</span>:
		<span style="color: #3a81c3; font-weight: bold;">if</span> name <span style="color: #3a81c3; font-weight: bold;">in</span> bound_types:
		    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3;">isinstance</span><span style="color: #3a81c3;">(</span>value, bound_types<span style="color: #6c3163;">[</span>name<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>:
			<span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Argument {} must be {}'</span>.<span style="color: #3a81c3;">format</span><span style="color: #6c3163;">(</span>
			    name, bound_types<span style="color: #2d9574;">[</span>name<span style="color: #2d9574;">]</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
	    <span style="color: #3a81c3; font-weight: bold;">return</span> func<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> wrapper
    <span style="color: #3a81c3; font-weight: bold;">return</span> decorate


<span style="color: #ba2f59; font-weight: bold;">@typeassert</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">int</span>, z=<span style="color: #3a81c3;">int</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">add</span><span style="color: #3a81c3;">(</span>x, y, z=42<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">return</span> x + y + z
</pre>
</div>
</div>
</div>

<div id="outline-container-org5d36cc3" class="outline-3">
<h3 id="org5d36cc3"><span class="section-number-3">10.5</span> Decorator as Functional Class</h3>
<div class="outline-text-3" id="text-10-5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> types
<span style="color: #3a81c3; font-weight: bold;">from</span> functools <span style="color: #3a81c3; font-weight: bold;">import</span> wraps


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Profiled</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, func<span style="color: #3a81c3;">)</span>:
	wraps<span style="color: #3a81c3;">(</span>func<span style="color: #3a81c3;">)(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">self</span>.ncalls = 0

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__call__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.ncalls += 1
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.__wrapped__<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__get__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance, cls<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> instance <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
	    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>
	<span style="color: #3a81c3; font-weight: bold;">else</span>:
	    <span style="color: #3a81c3; font-weight: bold;">return</span> types.MethodType<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, instance<span style="color: #3a81c3;">)</span>


<span style="color: #ba2f59; font-weight: bold;">@Profiled</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">add</span><span style="color: #3a81c3;">(</span>x, y<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">return</span> x + y


add<span style="color: #3a81c3;">(</span>4, 5<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>add.ncalls<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org32e1bd2" class="outline-3">
<h3 id="org32e1bd2"><span class="section-number-3">10.6</span> <code>inspect</code></h3>
<div class="outline-text-3" id="text-10-6">
<ul class="org-ul">
<li>signature</li>
<li>getargspec</li>
<li>Parameter</li>
</ul>
</div>
</div>

<div id="outline-container-org23b4725" class="outline-3">
<h3 id="org23b4725"><span class="section-number-3">10.7</span> Using Decorators to Patch Class Definitions</h3>
<div class="outline-text-3" id="text-10-7">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">patch</span><span style="color: #3a81c3;">(</span>cls<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">orig_method</span> = cls.method

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">new_method</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">return</span> orig_method<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>

    <span style="color: #715ab1;">cls.method</span> = new_method
</pre>
</div>
</div>
</div>
<div id="outline-container-org361a07f" class="outline-3">
<h3 id="org361a07f"><span class="section-number-3">10.8</span> Enforcing an Argument Signature on *args and **kwargs</h3>
<div class="outline-text-3" id="text-10-8">
</div>
<div id="outline-container-orga126859" class="outline-4">
<h4 id="orga126859"><span class="section-number-4">10.8.1</span> Creating a Function Signature</h4>
<div class="outline-text-4" id="text-10-8-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> inspect <span style="color: #3a81c3; font-weight: bold;">import</span> Signature, Parameter

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Make a signature for a func(x, y=42, *, z=None)</span>

<span style="color: #715ab1;">parms</span> = <span style="color: #3a81c3;">[</span>
    Parameter<span style="color: #6c3163;">(</span><span style="color: #2d9574;">'x'</span>, Parameter.POSITIONAL_OR_KEYWORD<span style="color: #6c3163;">)</span>,
    Parameter<span style="color: #6c3163;">(</span><span style="color: #2d9574;">'y'</span>, Parameter.POSITIONAL_OR_KEYWORD, default=42<span style="color: #6c3163;">)</span>,
    Parameter<span style="color: #6c3163;">(</span><span style="color: #2d9574;">'z'</span>, Parameter.KEYWORD_ONLY, default=<span style="color: #4e3163;">None</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">]</span>
<span style="color: #715ab1;">sig</span> = Signature<span style="color: #3a81c3;">(</span>parms<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>sig<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">func</span><span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">bound_values</span> = sig.bind<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf89217f" class="outline-4">
<h4 id="orgf89217f"><span class="section-number-4">10.8.2</span> <b>Enforcing Function Signatures</b></h4>
<div class="outline-text-4" id="text-10-8-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> inspect <span style="color: #3a81c3; font-weight: bold;">import</span> Signature, Parameter
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">make_sig</span><span style="color: #3a81c3;">(</span>*names<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">parms</span> = <span style="color: #3a81c3;">[</span>Parameter<span style="color: #6c3163;">(</span>name, Parameter.POSITIONAL_OR_KEYWORD<span style="color: #6c3163;">)</span>
	     <span style="color: #3a81c3; font-weight: bold;">for</span> name <span style="color: #3a81c3; font-weight: bold;">in</span> names<span style="color: #3a81c3;">]</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> Signature<span style="color: #3a81c3;">(</span>parms<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Structure</span>:
    <span style="color: #715ab1;">__signature__</span> = make_sig<span style="color: #3a81c3;">()</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">inspect.signature will lookup __signature__</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">bound_values</span> = <span style="color: #3a81c3; font-weight: bold;">self</span>.__signature__.bind<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">for</span> name, value <span style="color: #3a81c3; font-weight: bold;">in</span> bound_values.arguments.items<span style="color: #3a81c3;">()</span>:
	    <span style="color: #3a81c3;">setattr</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name, value<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Stock</span><span style="color: #3a81c3;">(</span>Structure<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">__signature__</span> = make_sig<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'name'</span>, <span style="color: #2d9574;">'shares'</span>, <span style="color: #2d9574;">'price'</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__init__<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3474997" class="outline-4">
<h4 id="org3474997"><span class="section-number-4">10.8.3</span> Metaclass Approach</h4>
<div class="outline-text-4" id="text-10-8-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> inspect <span style="color: #3a81c3; font-weight: bold;">import</span> Signature, Parameter


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">make_sig</span><span style="color: #3a81c3;">(</span>*names<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">parms</span> = <span style="color: #3a81c3;">[</span>
	Parameter<span style="color: #6c3163;">(</span>name, Parameter.POSITIONAL_OR_KEYWORD<span style="color: #6c3163;">)</span> <span style="color: #3a81c3; font-weight: bold;">for</span> name <span style="color: #3a81c3; font-weight: bold;">in</span> names
    <span style="color: #3a81c3;">]</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> Signature<span style="color: #3a81c3;">(</span>parms<span style="color: #3a81c3;">)</span>


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">StructureMeta</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">type</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__new__</span><span style="color: #3a81c3;">(</span>cls, clsname, bases, clsdict<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">clsdict</span><span style="color: #3a81c3;">[</span><span style="color: #2d9574;">'__signature__'</span><span style="color: #3a81c3;">]</span> = make_sig<span style="color: #3a81c3;">(</span>*clsdict.get<span style="color: #6c3163;">(</span><span style="color: #2d9574;">'_fields'</span>, <span style="color: #2d9574;">[]</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__new__<span style="color: #3a81c3;">(</span>cls, clsname, bases, clsdict<span style="color: #3a81c3;">)</span>


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Structure</span><span style="color: #3a81c3;">(</span>metaclass=StructureMeta<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">fields</span> = <span style="color: #3a81c3;">[]</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">bound_values</span> = <span style="color: #3a81c3; font-weight: bold;">self</span>.__signature__.bind<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">for</span> name, value <span style="color: #3a81c3; font-weight: bold;">in</span> bound_values.arguments.items<span style="color: #3a81c3;">()</span>:
	    <span style="color: #3a81c3;">setattr</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name, value<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb5d6d53" class="outline-3">
<h3 id="orgb5d6d53"><span class="section-number-3">10.9</span> Parsing and Analyzing Python Source</h3>
<div class="outline-text-3" id="text-10-9">
<ul class="org-ul">
<li><code>eval('2 + 3*4 + x')</code></li>
</ul>
</div>
<div id="outline-container-org7b79f70" class="outline-4">
<h4 id="org7b79f70"><span class="section-number-4">10.9.1</span> <code>exec</code></h4>
<div class="outline-text-4" id="text-10-9-1">
<ul class="org-ul">
<li><code>exec('for i in range(10): print(i)')</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">test1</span><span style="color: #3a81c3;">()</span>:
    <span style="color: #715ab1;">x</span> = 0
    <span style="color: #3a81c3; font-weight: bold;">exec</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'x += 1'</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 0</span>

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">test2</span><span style="color: #3a81c3;">()</span>:
    <span style="color: #715ab1;">x</span> = 0
    <span style="color: #715ab1;">loc</span> = <span style="color: #3a81c3;">locals</span><span style="color: #3a81c3;">()</span>
    <span style="color: #3a81c3; font-weight: bold;">exec</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'x += 1'</span><span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">x</span> = loc<span style="color: #3a81c3;">[</span><span style="color: #2d9574;">'x'</span><span style="color: #3a81c3;">]</span>
    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">=&gt; 1</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3643133" class="outline-4">
<h4 id="org3643133"><span class="section-number-4">10.9.2</span> <code>ast</code></h4>
<div class="outline-text-4" id="text-10-9-2">
<p>
compile Python source code into an abstract syntax tree(AST)
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> ast
<span style="color: #715ab1;">ex</span> = ast.parse<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'2 + 3*4 + x'</span>, mode=<span style="color: #2d9574;">'eval'</span><span style="color: #3a81c3;">)</span>
ast.dump<span style="color: #3a81c3;">(</span>ex<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">"Expression(body=BinOp(left=BinOp(left=Num(n=2), op=Add(), right=BinOp(left=Num(n=3), op=Mult(), right=Num(n=4))), op=Add(), right=Name(id='x', ctx=Load())))"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga4e1070" class="outline-4">
<h4 id="orga4e1070"><span class="section-number-4">10.9.3</span> Rewriting AST to Achieve Performance Improvement</h4>
<div class="outline-text-4" id="text-10-9-3">
<ul class="org-ul">
<li>see 9.24</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org3a658f2" class="outline-3">
<h3 id="org3a658f2"><span class="section-number-3">10.10</span> <code>dis</code></h3>
<div class="outline-text-3" id="text-10-10">
<ul class="org-ul">
<li><code>dis.dis</code></li>
<li>disassembled code: <code>some_func.__code__.co_code</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgdbd2068" class="outline-3">
<h3 id="orgdbd2068"><span class="section-number-3">10.11</span> Simple namedtuple</h3>
<div class="outline-text-3" id="text-10-11">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> operator

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">StructTupleMeta</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">type</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span>cls, *args, **kwargs<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__init__<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">for</span> n, name <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">enumerate</span><span style="color: #3a81c3;">(</span>cls._fields<span style="color: #3a81c3;">)</span>:
	    <span style="color: #3a81c3;">setattr</span><span style="color: #3a81c3;">(</span>cls, name, <span style="color: #3a81c3;">property</span><span style="color: #6c3163;">(</span>operator.itemgetter<span style="color: #2d9574;">(</span>n<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
	    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">After f = itemgetter(2), the call f(r) returns r[2]</span>

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">StructTuple</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">tuple</span>, metaclass=StructTupleMeta<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">_fields</span> = <span style="color: #3a81c3;">[]</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__new__</span><span style="color: #3a81c3;">(</span>cls, *args<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">len</span><span style="color: #3a81c3;">(</span>args<span style="color: #3a81c3;">)</span> != <span style="color: #3a81c3;">len</span><span style="color: #3a81c3;">(</span>cls._fields<span style="color: #3a81c3;">)</span>:
	    <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">ValueError</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'{} arguments required'</span>.<span style="color: #3a81c3;">format</span><span style="color: #6c3163;">(</span><span style="color: #3a81c3;">len</span><span style="color: #2d9574;">(</span>cls._fields<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__new__<span style="color: #3a81c3;">(</span>cls, args<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Stock</span><span style="color: #3a81c3;">(</span>StructTuple<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">_fields</span> = <span style="color: #3a81c3;">[</span><span style="color: #2d9574;">'name'</span>, <span style="color: #2d9574;">'shares'</span>, <span style="color: #2d9574;">'price'</span><span style="color: #3a81c3;">]</span>

<span style="color: #715ab1;">s</span> = Stock<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'ACME'</span>, 50, 91.1<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org2a0d1d6" class="outline-3">
<h3 id="org2a0d1d6"><span class="section-number-3">10.12</span> Multimethod 9.20</h3>
</div>
<div id="outline-container-orgf7949b0" class="outline-3">
<h3 id="orgf7949b0"><span class="section-number-3">10.13</span> Avoiding Repetitive Property</h3>
<div class="outline-text-3" id="text-10-13">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">typed_property</span><span style="color: #3a81c3;">(</span>name, expected_type<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">storage_name</span> = <span style="color: #2d9574;">'_'</span> + name

    @<span style="color: #3a81c3;">property</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">prop</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">getattr</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, storage_name<span style="color: #3a81c3;">)</span>

    <span style="color: #ba2f59; font-weight: bold;">@prop.setter</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">prop</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, value<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">not</span> <span style="color: #3a81c3;">isinstance</span><span style="color: #3a81c3;">(</span>value, expected_type<span style="color: #3a81c3;">)</span>:
	    <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'{} must be a {}'</span>.<span style="color: #3a81c3;">format</span><span style="color: #6c3163;">(</span>name, expected_type<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3;">setattr</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, storage_name, value<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> prop

<span style="color: #3a81c3; font-weight: bold;">from</span> functools <span style="color: #3a81c3; font-weight: bold;">import</span> partial
<span style="color: #715ab1;">String</span> = partial<span style="color: #3a81c3;">(</span>typed_property, expected_type=<span style="color: #3a81c3;">str</span><span style="color: #3a81c3;">)</span>
<span style="color: #715ab1;">Integer</span> = partial<span style="color: #3a81c3;">(</span>typed_property, expected_type=<span style="color: #3a81c3;">int</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example use</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Person</span>:
    <span style="color: #715ab1;">name</span> = String<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'name'</span><span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">age</span> = Integer<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'age'</span><span style="color: #3a81c3;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name, age<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.name = name
	<span style="color: #3a81c3; font-weight: bold;">self</span>.age = age
</pre>
</div>
</div>
</div>

<div id="outline-container-org0ba9c7a" class="outline-3">
<h3 id="org0ba9c7a"><span class="section-number-3">10.14</span> Defining Context Manager the Easy Way</h3>
<div class="outline-text-3" id="text-10-14">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> time
<span style="color: #3a81c3; font-weight: bold;">from</span> contextlib <span style="color: #3a81c3; font-weight: bold;">import</span> contextmanager

<span style="color: #ba2f59; font-weight: bold;">@contextmanager</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">timethis</span><span style="color: #3a81c3;">(</span>label<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">start</span> = time.time<span style="color: #3a81c3;">()</span>
    <span style="color: #3a81c3; font-weight: bold;">try</span>:
	<span style="color: #3a81c3; font-weight: bold;">yield</span>
    <span style="color: #3a81c3; font-weight: bold;">finally</span>:
	<span style="color: #715ab1;">end</span> = time.time<span style="color: #3a81c3;">()</span>
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'{}: {}'</span>.<span style="color: #3a81c3;">format</span><span style="color: #6c3163;">(</span>label, end - start<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example use</span>
<span style="color: #3a81c3; font-weight: bold;">with</span> timethis<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'counting'</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">n</span> = 10000000
    <span style="color: #3a81c3; font-weight: bold;">while</span> n &gt; 0:
	<span style="color: #715ab1;">n</span> -= 1
</pre>
</div>
<ul class="org-ul">
<li>all of the code prior to the yield executes as the <code>__enter__()</code> method of a context manager. All of the code after the <code>yield</code> executes as the <code>__exit__()</code> method</li>
<li>If there was an exception, it is <b>raised</b> at the <code>yield</code> statement.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgc492047" class="outline-2">
<h2 id="orgc492047"><span class="section-number-2">11</span> Metaclass</h2>
<div class="outline-text-2" id="text-11">
</div>
<div id="outline-container-orga0a437a" class="outline-3">
<h3 id="orga0a437a"><span class="section-number-3">11.1</span> Basic</h3>
<div class="outline-text-3" id="text-11-1">
<p>
When writing metaclasses, it is somewhat common to only define a <code>__new__()</code> or <code>__init__()</code> method, <b>but not both</b>.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">MyMeta</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">type</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__new__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, clsname, bases, clsdict<span style="color: #3a81c3;">)</span>:
	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">self is a class object</span>
	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">clsname is name of class being defined</span>
	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">bases is tuple of base classes</span>
	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">clsdict is class dictionary</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__new__<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, clsname, bases, clsdict<span style="color: #3a81c3;">)</span>
</pre>
</div>
<p>
or
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">MyMeta</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">type</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span>cls, clsname, bases, clsdict<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__init__<span style="color: #3a81c3;">(</span>clsname, bases, clsdict<span style="color: #3a81c3;">)</span>
</pre>
</div>
<dl class="org-dl">
<dt><code>__prepare__</code></dt><dd>is called first and used to <b>create the class namespace</b> prior to the body of any class definition being processed. Normally, this method simply returns a dictionary or other mapping object</dd>
<dt><code>__new__</code> </dt><dd>is invoked prior to class creation and is typically used when a metaclass wants to alter the class definition in some way</dd>
<dt><code>__init__</code></dt><dd>is invoked after a class has been created, and is useful if you want to write code that works with the fully formed class object.</dd>
</dl>
</div>
</div>

<div id="outline-container-org6040440" class="outline-3">
<h3 id="org6040440"><span class="section-number-3">11.2</span> NoInstances</h3>
<div class="outline-text-3" id="text-11-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">NoInstances</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">type</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__call__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">TypeError</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"Can't instantiate directly"</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Spam</span><span style="color: #3a81c3;">(</span>metaclass=NoInstances<span style="color: #3a81c3;">)</span>:
    @<span style="color: #3a81c3;">staticmethod</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">grok</span><span style="color: #3a81c3;">(</span>x<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Spam.grok'</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3af0847" class="outline-3">
<h3 id="org3af0847"><span class="section-number-3">11.3</span> Singleton</h3>
<div class="outline-text-3" id="text-11-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Singleton</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">type</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.__instance = <span style="color: #4e3163;">None</span>
	<span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__init__<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__call__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.__instance <span style="color: #3a81c3; font-weight: bold;">is</span> <span style="color: #4e3163;">None</span>:
	    <span style="color: #3a81c3; font-weight: bold;">self</span>.__instance = <span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__call__<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>
	    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.__instance
	<span style="color: #3a81c3; font-weight: bold;">else</span>:
	    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.__instance
</pre>
</div>
</div>
</div>

<div id="outline-container-org8dd7ff7" class="outline-3">
<h3 id="org8dd7ff7"><span class="section-number-3">11.4</span> Cached Instances</h3>
<div class="outline-text-3" id="text-11-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> weakref

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Cached</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">type</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, *args, **kwargs<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__init__<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">self</span>.__cache = weakref.WeakValueDictionary<span style="color: #3a81c3;">()</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__call__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, *args<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">if</span> args <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.__cache:
	    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.__cache<span style="color: #3a81c3;">[</span>args<span style="color: #3a81c3;">]</span>
	<span style="color: #3a81c3; font-weight: bold;">else</span>:
	    <span style="color: #715ab1;">obj</span> = <span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__call__<span style="color: #3a81c3;">(</span>*args<span style="color: #3a81c3;">)</span>
	    <span style="color: #3a81c3; font-weight: bold;">self</span>.__cache<span style="color: #3a81c3;">[</span>args<span style="color: #3a81c3;">]</span> = obj
	    <span style="color: #3a81c3; font-weight: bold;">return</span> obj
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd45359b" class="outline-3">
<h3 id="orgd45359b"><span class="section-number-3">11.5</span> OrderedDict for Class Body</h3>
<div class="outline-text-3" id="text-11-5">
<p>
This method is invoked immediately at the start of a class definition with the class name and base classes. It must then return a mapping object to use when processing the class body.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Metaclass that uses an OrderedDict for class body</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">OrderedMeta</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">type</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__new__</span><span style="color: #3a81c3;">(</span>cls, clsname, bases, clsdict<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">d</span> = <span style="color: #3a81c3;">dict</span><span style="color: #3a81c3;">(</span>clsdict<span style="color: #3a81c3;">)</span>
	<span style="color: #715ab1;">order</span> = <span style="color: #3a81c3;">[]</span>
	<span style="color: #3a81c3; font-weight: bold;">for</span> name, value <span style="color: #3a81c3; font-weight: bold;">in</span> clsdict.items<span style="color: #3a81c3;">()</span>:
	    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">isinstance</span><span style="color: #3a81c3;">(</span>value, Typed<span style="color: #3a81c3;">)</span>:
		<span style="color: #715ab1;">value._name</span> = name
		order.append<span style="color: #3a81c3;">(</span>name<span style="color: #3a81c3;">)</span>
	<span style="color: #715ab1;">d</span><span style="color: #3a81c3;">[</span><span style="color: #2d9574;">'_order'</span><span style="color: #3a81c3;">]</span> = order
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">type</span>.__new__<span style="color: #3a81c3;">(</span>cls, clsname, bases, d<span style="color: #3a81c3;">)</span>

    @<span style="color: #3a81c3;">classmethod</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__prepare__</span><span style="color: #3a81c3;">(</span>cls, clsname, bases<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">return</span> OrderedDict<span style="color: #3a81c3;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org61c0ec3" class="outline-3">
<h3 id="org61c0ec3"><span class="section-number-3">11.6</span> Optional Arguments on Class Definitions</h3>
<div class="outline-text-3" id="text-11-6">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Spam</span><span style="color: #3a81c3;">(</span>metaclass=MyMeta, debug=<span style="color: #4e3163;">True</span>, synchronize=<span style="color: #4e3163;">True</span><span style="color: #3a81c3;">)</span>:
    ...
</pre>
</div>
<p>
To support such keyword arguments in a metaclass, make sure you define them on the
<code>__prepare__()</code>, <code>__new__()</code>, and <code>__init__()</code> methods using keyword-only arguments
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">MyMeta</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">type</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Optional</span>
    @<span style="color: #3a81c3;">classmethod</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__prepare__</span><span style="color: #3a81c3;">(</span>cls, name, bases, *, debug=<span style="color: #4e3163;">False</span>, synchronize=<span style="color: #4e3163;">False</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Custom processing</span>
	...
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__prepare__<span style="color: #3a81c3;">(</span>name, bases<span style="color: #3a81c3;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Required</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__new__</span><span style="color: #3a81c3;">(</span>cls, name, bases, ns, *, debug=<span style="color: #4e3163;">False</span>, synchronize=<span style="color: #4e3163;">False</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Custom processing</span>
	...
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__new__<span style="color: #3a81c3;">(</span>cls, name, bases, ns<span style="color: #3a81c3;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Required</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name, bases, ns, *, debug=<span style="color: #4e3163;">False</span>, synchronize=<span style="color: #4e3163;">False</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Custom processing</span>
	...
	<span style="color: #3a81c3;">super</span><span style="color: #3a81c3;">()</span>.__init__<span style="color: #3a81c3;">(</span>name, bases, ns<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1858620" class="outline-2">
<h2 id="org1858620"><span class="section-number-2">12</span> Packages and Modules</h2>
<div class="outline-text-2" id="text-12">
</div>
<div id="outline-container-org5ea616b" class="outline-3">
<h3 id="org5ea616b"><span class="section-number-3">12.1</span> Lazy Import</h3>
<div class="outline-text-3" id="text-12-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">__init__.py</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">A</span><span style="color: #3a81c3;">()</span>:
    <span style="color: #3a81c3; font-weight: bold;">from</span> .a <span style="color: #3a81c3; font-weight: bold;">import</span> A
    <span style="color: #3a81c3; font-weight: bold;">return</span> A<span style="color: #3a81c3;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5e9e297" class="outline-3">
<h3 id="org5e9e297"><span class="section-number-3">12.2</span> Organize Add-on Packages into a Common Package</h3>
<div class="outline-text-3" id="text-12-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">foo-package/</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#   </span><span style="color: #2aa1ae; background-color: #ecf3ec;">spam/</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#     </span><span style="color: #2aa1ae; background-color: #ecf3ec;">blah.py</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">bar-package/</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#   </span><span style="color: #2aa1ae; background-color: #ecf3ec;">spam/</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#     </span><span style="color: #2aa1ae; background-color: #ecf3ec;">grok.py</span>
<span style="color: #3a81c3; font-weight: bold;">import</span> sys
sys.path.extend<span style="color: #3a81c3;">(</span><span style="color: #6c3163;">[</span><span style="color: #2d9574;">'foo-package'</span>, <span style="color: #2d9574;">'bar-package'</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">import</span> spam.blah
<span style="color: #3a81c3; font-weight: bold;">import</span> spam.grok
</pre>
</div>
</div>
</div>
<div id="outline-container-org97b93ad" class="outline-3">
<h3 id="org97b93ad"><span class="section-number-3">12.3</span> Read Data File</h3>
<div class="outline-text-3" id="text-12-3">
<ul class="org-ul">
<li><code>pkgutil.get_data</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgcd2c58f" class="outline-3">
<h3 id="orgcd2c58f"><span class="section-number-3">12.4</span> Import Hooks</h3>
<div class="outline-text-3" id="text-12-4">
<ul class="org-ul">
<li>See <code>10.11</code>, <code>10.12</code></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org2756900" class="outline-2">
<h2 id="org2756900"><span class="section-number-2">13</span> Network</h2>
<div class="outline-text-2" id="text-13">
</div>
<div id="outline-container-org42d2bca" class="outline-3">
<h3 id="org42d2bca"><span class="section-number-3">13.1</span> <code>socketserver</code></h3>
</div>
<div id="outline-container-orgc9b8b5d" class="outline-3">
<h3 id="orgc9b8b5d"><span class="section-number-3">13.2</span> CIDR network address</h3>
<div class="outline-text-3" id="text-13-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> ipaddress
<span style="color: #715ab1;">net</span> = ipaddress.ip_network<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'123.45.67.64/27'</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">list</span><span style="color: #3a81c3;">(</span>net<span style="color: #3a81c3;">)</span>
net.num_addresses

<span style="color: #715ab1;">inet</span> = ipaddress.ip_interface<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'123.45.67.73/27'</span><span style="color: #3a81c3;">)</span>
inet.network
inet.ip
</pre>
</div>
</div>
</div>
<div id="outline-container-org76a3f8e" class="outline-3">
<h3 id="org76a3f8e"><span class="section-number-3">13.3</span> Simple WSGI</h3>
<div class="outline-text-3" id="text-13-3">
<p>
WSGI: Web Server Gateway Interface. Same code for different web framework.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">application</span><span style="color: #3a81c3;">(</span>environ, start_response<span style="color: #3a81c3;">)</span>:
    start_response<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'200 OK'</span>, <span style="color: #6c3163;">[</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">'Content-Type'</span>, <span style="color: #2d9574;">'text/html'</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">[</span>b<span style="color: #2d9574;">'&lt;h1&gt;Hello, web!&lt;/h1&gt;'</span><span style="color: #3a81c3;">]</span>

<span style="color: #3a81c3; font-weight: bold;">from</span> wsgiref.simple_server <span style="color: #3a81c3; font-weight: bold;">import</span> make_server
<span style="color: #715ab1;">httpd</span> = make_server<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">''</span>, 8000, application<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Serving HTTP on port 8000...'</span><span style="color: #3a81c3;">)</span>
httpd.serve_forever<span style="color: #3a81c3;">()</span>
</pre>
</div>
<ul class="org-ul">
<li>environ: http request info</li>
<li><code>start_response</code>: a function that must be called to initiate a response</li>
<li>return: response body</li>
</ul>
</div>

<div id="outline-container-org8d869df" class="outline-4">
<h4 id="org8d869df"><span class="section-number-4">13.3.1</span> PathDispatcher</h4>
<div class="outline-text-4" id="text-13-3-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> cgi


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">notfound_404</span><span style="color: #3a81c3;">(</span>environ, start_response<span style="color: #3a81c3;">)</span>:
    start_response<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'404 Not Found'</span>, <span style="color: #6c3163;">[</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">'Content-type'</span>, <span style="color: #2d9574;">'text/plain'</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">[</span>b<span style="color: #2d9574;">'Not Found'</span><span style="color: #3a81c3;">]</span>


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">PathDispatcher</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.pathmap = <span style="color: #3a81c3;">{}</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__call__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, environ, start_response<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">path</span> = environ<span style="color: #3a81c3;">[</span><span style="color: #2d9574;">'PATH_INFO'</span><span style="color: #3a81c3;">]</span>

	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">extracts supplied query parameters from the request and puts them into a dictionary-like object</span>
	<span style="color: #715ab1;">params</span> = cgi.FieldStorage<span style="color: #3a81c3;">(</span>environ<span style="color: #6c3163;">[</span><span style="color: #2d9574;">'wsgi.input'</span><span style="color: #6c3163;">]</span>, environ=environ<span style="color: #3a81c3;">)</span>
	<span style="color: #715ab1;">method</span> = environ<span style="color: #3a81c3;">[</span><span style="color: #2d9574;">'REQUEST_METHOD'</span><span style="color: #3a81c3;">]</span>.lower<span style="color: #3a81c3;">()</span>
	<span style="color: #715ab1;">environ</span><span style="color: #3a81c3;">[</span><span style="color: #2d9574;">'params'</span><span style="color: #3a81c3;">]</span> = <span style="color: #3a81c3;">{</span>key: params.getvalue<span style="color: #6c3163;">(</span>key<span style="color: #6c3163;">)</span> <span style="color: #3a81c3; font-weight: bold;">for</span> key <span style="color: #3a81c3; font-weight: bold;">in</span> params<span style="color: #3a81c3;">}</span>
	<span style="color: #715ab1;">handler</span> = <span style="color: #3a81c3; font-weight: bold;">self</span>.pathmap.get<span style="color: #3a81c3;">(</span><span style="color: #6c3163;">(</span>method, path<span style="color: #6c3163;">)</span>, notfound_404<span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> handler<span style="color: #3a81c3;">(</span>environ, start_response<span style="color: #3a81c3;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">register</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, method, path, function<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>.pathmap<span style="color: #3a81c3;">[</span>method.lower<span style="color: #6c3163;">()</span>, path<span style="color: #3a81c3;">]</span> = function
	<span style="color: #3a81c3; font-weight: bold;">return</span> function


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">hello</span><span style="color: #3a81c3;">(</span>environ, start_response<span style="color: #3a81c3;">)</span>:
    start_response<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'200 OK'</span>, <span style="color: #6c3163;">[</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">'Content-Type'</span>, <span style="color: #2d9574;">'text/html'</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3;">[</span>b<span style="color: #2d9574;">'&lt;h1&gt;Hello, web!&lt;/h1&gt;'</span><span style="color: #3a81c3;">]</span>


<span style="color: #3a81c3; font-weight: bold;">from</span> wsgiref.simple_server <span style="color: #3a81c3; font-weight: bold;">import</span> make_server
<span style="color: #715ab1;">dispatcher</span> = PathDispatcher<span style="color: #3a81c3;">()</span>
dispatcher.register<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'GET'</span>, <span style="color: #2d9574;">'/hello'</span>, hello<span style="color: #3a81c3;">)</span>
<span style="color: #715ab1;">httpd</span> = make_server<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">''</span>, 8080, dispatcher<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Serving on port 8080...'</span><span style="color: #3a81c3;">)</span>
httpd.serve_forever<span style="color: #3a81c3;">()</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org80d4a4e" class="outline-3">
<h3 id="org80d4a4e"><span class="section-number-3">13.4</span> XMLRPC</h3>
<div class="outline-text-3" id="text-13-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> xmlrpc.server <span style="color: #3a81c3; font-weight: bold;">import</span> SimpleXMLRPCServer

<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">KeyValueServer</span>:
    <span style="color: #715ab1;">_rpc_methods_</span> = <span style="color: #3a81c3;">[</span><span style="color: #2d9574;">'get'</span>, <span style="color: #2d9574;">'set'</span><span style="color: #3a81c3;">]</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, address<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>._data = <span style="color: #3a81c3;">{}</span>
	<span style="color: #3a81c3; font-weight: bold;">self</span>._serv = SimpleXMLRPCServer<span style="color: #3a81c3;">(</span>address, allow_none=<span style="color: #4e3163;">True</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">for</span> name <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3; font-weight: bold;">self</span>._rpc_methods_:
	    <span style="color: #3a81c3; font-weight: bold;">self</span>._serv.register_function<span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">getattr</span><span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">get</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #3a81c3; font-weight: bold;">self</span>._data<span style="color: #3a81c3;">[</span>name<span style="color: #3a81c3;">]</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">set</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, name, value<span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>._data<span style="color: #3a81c3;">[</span>name<span style="color: #3a81c3;">]</span> = value

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">serve_forever</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>._serv.serve_forever<span style="color: #3a81c3;">()</span>

<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">__name__</span> == <span style="color: #2d9574;">'__main__'</span>:
    <span style="color: #715ab1;">kvserv</span> = KeyValueServer<span style="color: #3a81c3;">(</span><span style="color: #6c3163;">(</span><span style="color: #2d9574;">''</span>, 15000<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
    kvserv.serve_forever<span style="color: #3a81c3;">()</span>
</pre>
</div>
<ul class="org-ul">
<li>client</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> xmlrpc.client <span style="color: #3a81c3; font-weight: bold;">import</span> ServerProxy
<span style="color: #715ab1;">s</span> = ServerProxy<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'http://localhost:15000'</span>, allow_none=<span style="color: #4e3163;">True</span><span style="color: #3a81c3;">)</span>
s.<span style="color: #3a81c3;">set</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'foo'</span>, <span style="color: #2d9574;">'bar'</span><span style="color: #3a81c3;">)</span>
s.get<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'foo'</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb66a9d7" class="outline-3">
<h3 id="orgb66a9d7"><span class="section-number-3">13.5</span> Communicating Between Interpreters</h3>
<div class="outline-text-3" id="text-13-5">
<ul class="org-ul">
<li><code>multiprocessing.connection</code>: support UNIX domain sockets</li>
</ul>
</div>
</div>

<div id="outline-container-orgf7657a0" class="outline-3">
<h3 id="orgf7657a0"><span class="section-number-3">13.6</span> Simple Auth</h3>
<div class="outline-text-3" id="text-13-6">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> hmac
<span style="color: #3a81c3; font-weight: bold;">import</span> os

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">client_authenticate</span><span style="color: #3a81c3;">(</span>connection, secret_key<span style="color: #3a81c3;">)</span>:
    <span style="color: #da8b55;">'''</span>
<span style="color: #da8b55;">    Authenticate client to a remote service.</span>
<span style="color: #da8b55;">    connection represents a network connection.</span>
<span style="color: #da8b55;">    secret_key is a key known only to both client/server.</span>
<span style="color: #da8b55;">    '''</span>
    <span style="color: #715ab1;">message</span> = connection.recv<span style="color: #3a81c3;">(</span>32<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3;">hash</span> = hmac.new<span style="color: #3a81c3;">(</span>secret_key, message<span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">digest</span> = <span style="color: #3a81c3;">hash</span>.digest<span style="color: #3a81c3;">()</span>
    connection.send<span style="color: #3a81c3;">(</span>digest<span style="color: #3a81c3;">)</span>


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">server_authenticate</span><span style="color: #3a81c3;">(</span>connection, secret_key<span style="color: #3a81c3;">)</span>:
    <span style="color: #da8b55;">'''</span>
<span style="color: #da8b55;">    Request client authentication.</span>
<span style="color: #da8b55;">    '''</span>
    <span style="color: #715ab1;">message</span> = os.urandom<span style="color: #3a81c3;">(</span>32<span style="color: #3a81c3;">)</span>
    connection.send<span style="color: #3a81c3;">(</span>message<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3;">hash</span> = hmac.new<span style="color: #3a81c3;">(</span>secret_key, message<span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">digest</span> = <span style="color: #3a81c3;">hash</span>.digest<span style="color: #3a81c3;">()</span>
    <span style="color: #715ab1;">response</span> = connection.recv<span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">len</span><span style="color: #6c3163;">(</span>digest<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> hmac.compare_digest<span style="color: #3a81c3;">(</span>digest, response<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge710970" class="outline-3">
<h3 id="orge710970"><span class="section-number-3">13.7</span> SSL Wrapper</h3>
<div class="outline-text-3" id="text-13-7">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> ssl
<span style="color: #715ab1;">KEYFILE</span> = <span style="color: #2d9574;">'server_key.pem'</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Private key of the server</span>
<span style="color: #715ab1;">CERTFILE</span> = <span style="color: #2d9574;">'server_cert.pem'</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Server certificate (given to client)</span>
<span style="color: #715ab1;">s_ssl</span> = ssl.wrap_socket<span style="color: #3a81c3;">(</span>
    s, keyfile=KEYFILE, certfile=CERTFILE, server_side=<span style="color: #4e3163;">True</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org079f1e1" class="outline-3">
<h3 id="org079f1e1"><span class="section-number-3">13.8</span> select</h3>
<div class="outline-text-3" id="text-13-8">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> select

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">event_loop</span><span style="color: #3a81c3;">(</span>handlers<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
	<span style="color: #715ab1;">wants_recv</span> = <span style="color: #3a81c3;">[</span>h <span style="color: #3a81c3; font-weight: bold;">for</span> h <span style="color: #3a81c3; font-weight: bold;">in</span> handlers <span style="color: #3a81c3; font-weight: bold;">if</span> h.wants_to_receive<span style="color: #6c3163;">()</span><span style="color: #3a81c3;">]</span>
	<span style="color: #715ab1;">wants_send</span> = <span style="color: #3a81c3;">[</span>h <span style="color: #3a81c3; font-weight: bold;">for</span> h <span style="color: #3a81c3; font-weight: bold;">in</span> handlers <span style="color: #3a81c3; font-weight: bold;">if</span> h.wants_to_send<span style="color: #6c3163;">()</span><span style="color: #3a81c3;">]</span>
	<span style="color: #715ab1;">can_recv</span>, <span style="color: #715ab1;">can_send</span>, <span style="color: #715ab1;">_</span> = select.select<span style="color: #3a81c3;">(</span>wants_recv, wants_send, <span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">for</span> h <span style="color: #3a81c3; font-weight: bold;">in</span> can_recv:
	    h.handle_receive<span style="color: #3a81c3;">()</span>
	<span style="color: #3a81c3; font-weight: bold;">for</span> h <span style="color: #3a81c3; font-weight: bold;">in</span> can_send:
	    h.handle_send<span style="color: #3a81c3;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org066293c" class="outline-3">
<h3 id="org066293c"><span class="section-number-3">13.9</span> Sending Large Arrays</h3>
<div class="outline-text-3" id="text-13-9">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">zero copy with memoryview</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">send_from</span><span style="color: #3a81c3;">(</span>arr, dest<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">view</span> = <span style="color: #3a81c3;">memoryview</span><span style="color: #3a81c3;">(</span>arr<span style="color: #3a81c3;">)</span>.cast<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'B'</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #3a81c3;">len</span><span style="color: #3a81c3;">(</span>view<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">nsent</span> = dest.send<span style="color: #3a81c3;">(</span>view<span style="color: #3a81c3;">)</span>
	<span style="color: #715ab1;">view</span> = view<span style="color: #3a81c3;">[</span>nsent:<span style="color: #3a81c3;">]</span>


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">recv_into</span><span style="color: #3a81c3;">(</span>arr, source<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">view</span> = <span style="color: #3a81c3;">memoryview</span><span style="color: #3a81c3;">(</span>arr<span style="color: #3a81c3;">)</span>.cast<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'B'</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #3a81c3;">len</span><span style="color: #3a81c3;">(</span>view<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">nrecv</span> = source.recv_into<span style="color: #3a81c3;">(</span>view<span style="color: #3a81c3;">)</span>
	<span style="color: #715ab1;">view</span> = view<span style="color: #3a81c3;">[</span>nrecv:<span style="color: #3a81c3;">]</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgdb7f864" class="outline-2">
<h2 id="orgdb7f864"><span class="section-number-2">14</span> Concurrency</h2>
<div class="outline-text-2" id="text-14">
</div>
<div id="outline-container-orga0af2ee" class="outline-3">
<h3 id="orga0af2ee"><span class="section-number-3">14.1</span> Threading</h3>
<div class="outline-text-3" id="text-14-1">
<ul class="org-ul">
<li><code>Thread</code> methods: <code>start</code>, <code>is_alive</code>, <code>join</code>, <code>terminate</code></li>
<li><code>Thread</code> interface: <code>run</code></li>
</ul>
</div>
<div id="outline-container-orgba41649" class="outline-4">
<h4 id="orgba41649"><span class="section-number-4">14.1.1</span> Daemonic Thread</h4>
<div class="outline-text-4" id="text-14-1-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #715ab1;">t</span> = Thread<span style="color: #3a81c3;">(</span>target=countdown, args=<span style="color: #6c3163;">(</span>10,<span style="color: #6c3163;">)</span>, daemon=<span style="color: #4e3163;">True</span><span style="color: #3a81c3;">)</span>
t.start<span style="color: #3a81c3;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgda0042a" class="outline-4">
<h4 id="orgda0042a"><span class="section-number-4">14.1.2</span> Storing Thread-Specific State</h4>
<div class="outline-text-4" id="text-14-1-2">
<ul class="org-ul">
<li><code>threading.local()</code> : create a thread-local storage object</li>
</ul>
</div>
</div>

<div id="outline-container-orga3ae1a6" class="outline-4">
<h4 id="orga3ae1a6"><span class="section-number-4">14.1.3</span> Threading Pool</h4>
<div class="outline-text-4" id="text-14-1-3">
<ul class="org-ul">
<li><code>from concurrent.futures import ThreadPoolExecutor</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orge73097b" class="outline-3">
<h3 id="orge73097b"><span class="section-number-3">14.2</span> Synchronization Primitives</h3>
<div class="outline-text-3" id="text-14-2">
</div>
<div id="outline-container-orga89f1d4" class="outline-4">
<h4 id="orga89f1d4"><span class="section-number-4">14.2.1</span> Event</h4>
<div class="outline-text-4" id="text-14-2-1">
<p>
Event instances are similar to a "sticky" flag that allows threads to wait for something to happan.
</p>
</div>
</div>

<div id="outline-container-orgde661f7" class="outline-4">
<h4 id="orgde661f7"><span class="section-number-4">14.2.2</span> Avoid Deadlock</h4>
<div class="outline-text-4" id="text-14-2-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> threading
<span style="color: #3a81c3; font-weight: bold;">from</span> contextlib <span style="color: #3a81c3; font-weight: bold;">import</span> contextmanager

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Thread-local state to stored information on locks already acquired</span>
<span style="color: #715ab1;">_local</span> = threading.local<span style="color: #3a81c3;">()</span>


<span style="color: #ba2f59; font-weight: bold;">@contextmanager</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">acquire</span><span style="color: #3a81c3;">(</span>*locks<span style="color: #3a81c3;">)</span>:
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Sort locks by object identifier</span>
    <span style="color: #715ab1;">locks</span> = <span style="color: #3a81c3;">sorted</span><span style="color: #3a81c3;">(</span>locks, key=<span style="color: #3a81c3; font-weight: bold;">lambda</span> x: <span style="color: #3a81c3;">id</span><span style="color: #6c3163;">(</span>x<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Make sure lock order of previously acquired locks is not violated</span>
    <span style="color: #715ab1;">acquired</span> = <span style="color: #3a81c3;">getattr</span><span style="color: #3a81c3;">(</span>_local, <span style="color: #2d9574;">'acquired'</span>, <span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> acquired <span style="color: #3a81c3; font-weight: bold;">and</span> <span style="color: #3a81c3;">max</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">id</span><span style="color: #6c3163;">(</span>lock<span style="color: #6c3163;">)</span> <span style="color: #3a81c3; font-weight: bold;">for</span> lock <span style="color: #3a81c3; font-weight: bold;">in</span> acquired<span style="color: #3a81c3;">)</span> &gt;= <span style="color: #3a81c3;">id</span><span style="color: #3a81c3;">(</span>locks<span style="color: #6c3163;">[</span>0<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">RuntimeError</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Lock Order Violation'</span><span style="color: #3a81c3;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Acquire all of the locks</span>
    acquired.extend<span style="color: #3a81c3;">(</span>locks<span style="color: #3a81c3;">)</span>
    <span style="color: #715ab1;">_local.acquired</span> = acquired
    <span style="color: #3a81c3; font-weight: bold;">try</span>:
	<span style="color: #3a81c3; font-weight: bold;">for</span> lock <span style="color: #3a81c3; font-weight: bold;">in</span> locks:
	    lock.acquire<span style="color: #3a81c3;">()</span>
	<span style="color: #3a81c3; font-weight: bold;">yield</span>
    <span style="color: #3a81c3; font-weight: bold;">finally</span>:
	<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Release locks in reverse order of acquisition</span>
	<span style="color: #3a81c3; font-weight: bold;">for</span> lock <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">reversed</span><span style="color: #3a81c3;">(</span>locks<span style="color: #3a81c3;">)</span>:
	    lock.release<span style="color: #3a81c3;">()</span>
	<span style="color: #3a81c3; font-weight: bold;">del</span> acquired<span style="color: #3a81c3;">[</span>-<span style="color: #3a81c3;">len</span><span style="color: #6c3163;">(</span>locks<span style="color: #6c3163;">)</span>:<span style="color: #3a81c3;">]</span>


<span style="color: #3a81c3; font-weight: bold;">import</span> threading
<span style="color: #715ab1;">x_lock</span> = threading.Lock<span style="color: #3a81c3;">()</span>
<span style="color: #715ab1;">y_lock</span> = threading.Lock<span style="color: #3a81c3;">()</span>

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">thread_1</span><span style="color: #3a81c3;">()</span>:
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
	<span style="color: #3a81c3; font-weight: bold;">with</span> acquire<span style="color: #3a81c3;">(</span>x_lock, y_lock<span style="color: #3a81c3;">)</span>:
	    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Thread-1'</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">thread_2</span><span style="color: #3a81c3;">()</span>:
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
	<span style="color: #3a81c3; font-weight: bold;">with</span> acquire<span style="color: #3a81c3;">(</span>y_lock, x_lock<span style="color: #3a81c3;">)</span>:
	    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'Thread-2'</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf300050" class="outline-3">
<h3 id="orgf300050"><span class="section-number-3">14.3</span> Message Queue</h3>
<div class="outline-text-3" id="text-14-3">
<ul class="org-ul">
<li>ZeroMQ</li>
<li>Celery</li>
</ul>
</div>
<div id="outline-container-org0ce66f6" class="outline-4">
<h4 id="org0ce66f6"><span class="section-number-4">14.3.1</span> Actor Model</h4>
<div class="outline-text-4" id="text-14-3-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">from</span> queue <span style="color: #3a81c3; font-weight: bold;">import</span> Queue
<span style="color: #3a81c3; font-weight: bold;">from</span> threading <span style="color: #3a81c3; font-weight: bold;">import</span> Thread, Event


<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Sentinel used for shutdown</span>
<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">ActorExit</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">Exception</span><span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">pass</span>


<span style="color: #3a81c3; font-weight: bold;">class</span> <span style="color: #ba2f59; font-weight: bold;">Actor</span>:
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">__init__</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>._mailbox = Queue<span style="color: #3a81c3;">()</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">send</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span>, msg<span style="color: #3a81c3;">)</span>:
	<span style="color: #da8b55;">'''</span>
<span style="color: #da8b55;">        Send a message to the actor</span>
<span style="color: #da8b55;">        '''</span>
	<span style="color: #3a81c3; font-weight: bold;">self</span>._mailbox.put<span style="color: #3a81c3;">(</span>msg<span style="color: #3a81c3;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">recv</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #da8b55;">'''</span>
<span style="color: #da8b55;">        Receive an incoming message</span>
<span style="color: #da8b55;">        '''</span>
	<span style="color: #715ab1;">msg</span> = <span style="color: #3a81c3; font-weight: bold;">self</span>._mailbox.get<span style="color: #3a81c3;">()</span>
	<span style="color: #3a81c3; font-weight: bold;">if</span> msg <span style="color: #3a81c3; font-weight: bold;">is</span> ActorExit:
	    <span style="color: #3a81c3; font-weight: bold;">raise</span> ActorExit<span style="color: #3a81c3;">()</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> msg

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">close</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #da8b55;">'''</span>
<span style="color: #da8b55;">        Close the actor, thus shutting it down</span>
<span style="color: #da8b55;">        '''</span>
	<span style="color: #3a81c3; font-weight: bold;">self</span>.send<span style="color: #3a81c3;">(</span>ActorExit<span style="color: #3a81c3;">)</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">start</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #da8b55;">'''</span>
<span style="color: #da8b55;">        Start concurrent execution</span>
<span style="color: #da8b55;">        '''</span>
	<span style="color: #3a81c3; font-weight: bold;">self</span>._terminated = Event<span style="color: #3a81c3;">()</span>
	<span style="color: #715ab1;">t</span> = Thread<span style="color: #3a81c3;">(</span>target=<span style="color: #3a81c3; font-weight: bold;">self</span>._bootstrap<span style="color: #3a81c3;">)</span>
	<span style="color: #715ab1;">t.daemon</span> = <span style="color: #4e3163;">True</span>
	t.start<span style="color: #3a81c3;">()</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">_bootstrap</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">try</span>:
	    <span style="color: #3a81c3; font-weight: bold;">self</span>.run<span style="color: #3a81c3;">()</span>
	<span style="color: #3a81c3; font-weight: bold;">except</span> ActorExit:
	    <span style="color: #3a81c3; font-weight: bold;">pass</span>
	<span style="color: #3a81c3; font-weight: bold;">finally</span>:
	    <span style="color: #3a81c3; font-weight: bold;">self</span>._terminated.<span style="color: #3a81c3;">set</span><span style="color: #3a81c3;">()</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">join</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #3a81c3; font-weight: bold;">self</span>._terminated.wait<span style="color: #3a81c3;">()</span>

    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">run</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">self</span><span style="color: #3a81c3;">)</span>:
	<span style="color: #da8b55;">'''</span>
<span style="color: #da8b55;">        Run method to be implemented by the user</span>
<span style="color: #da8b55;">        '''</span>
	<span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #4e3163;">True</span>:
	    <span style="color: #715ab1;">msg</span> = <span style="color: #3a81c3; font-weight: bold;">self</span>.recv<span style="color: #3a81c3;">()</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org90aa9e4" class="outline-2">
<h2 id="org90aa9e4"><span class="section-number-2">15</span> System Utilities</h2>
<div class="outline-text-2" id="text-15">
<ul class="org-ul">
<li><code>getpass</code>: prompting for a password</li>
</ul>
</div>

<div id="outline-container-orgb9eebb6" class="outline-3">
<h3 id="orgb9eebb6"><span class="section-number-3">15.1</span> Subprocess</h3>
<div class="outline-text-3" id="text-15-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> subprocess
<span style="color: #715ab1;">out_bytes</span> = subprocess.check_output<span style="color: #3a81c3;">(</span><span style="color: #6c3163;">[</span><span style="color: #2d9574;">'netstat'</span>,<span style="color: #2d9574;">'-a'</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
<span style="color: #715ab1;">out_text</span> = out_bytes.decode<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'utf-8'</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdf568ac" class="outline-3">
<h3 id="orgdf568ac"><span class="section-number-3">15.2</span> Performance Counter</h3>
<div class="outline-text-3" id="text-15-2">
<p>
use <code>time.perf_counter</code> for wall-time, <code>time.process_time</code> for CPU time
</p>
</div>
</div>
<div id="outline-container-org7440337" class="outline-3">
<h3 id="org7440337"><span class="section-number-3">15.3</span> CPU&amp;memory Limits</h3>
<div class="outline-text-3" id="text-15-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> signal
<span style="color: #3a81c3; font-weight: bold;">import</span> resource
<span style="color: #3a81c3; font-weight: bold;">import</span> os


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">time_exceeded</span><span style="color: #3a81c3;">(</span>signo, frame<span style="color: #3a81c3;">)</span>:
    <span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"Time's up!"</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">raise</span> <span style="color: #ba2f59; font-weight: bold;">SystemExit</span><span style="color: #3a81c3;">(</span>1<span style="color: #3a81c3;">)</span>


<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">set_max_runtime</span><span style="color: #3a81c3;">(</span>seconds<span style="color: #3a81c3;">)</span>:
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Install the signal handler and set a resource limit</span>
    <span style="color: #715ab1;">soft</span>, <span style="color: #715ab1;">hard</span> = resource.getrlimit<span style="color: #3a81c3;">(</span>resource.RLIMIT_CPU<span style="color: #3a81c3;">)</span>
    resource.setrlimit<span style="color: #3a81c3;">(</span>resource.RLIMIT_CPU, <span style="color: #6c3163;">(</span>seconds, hard<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
    signal.signal<span style="color: #3a81c3;">(</span>signal.SIGXCPU, time_exceeded<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">limit_memory</span><span style="color: #3a81c3;">(</span>maxsize<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">soft</span>, <span style="color: #715ab1;">hard</span> = resource.getrlimit<span style="color: #3a81c3;">(</span>resource.RLIMIT_AS<span style="color: #3a81c3;">)</span>
    resource.setrlimit<span style="color: #3a81c3;">(</span>resource.RLIMIT_AS, <span style="color: #6c3163;">(</span>maxsize, hard<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org42fdb72" class="outline-3">
<h3 id="org42fdb72"><span class="section-number-3">15.4</span> webbrowser</h3>
<div class="outline-text-3" id="text-15-4">
<p>
<code>get</code>, <code>open</code>, <code>open_new</code>, <code>open_new_tab</code>
</p>
</div>
</div>
</div>

<div id="outline-container-org270737c" class="outline-2">
<h2 id="org270737c"><span class="section-number-2">16</span> Testing</h2>
<div class="outline-text-2" id="text-16">
</div>
<div id="outline-container-org11e0836" class="outline-3">
<h3 id="org11e0836"><span class="section-number-3">16.1</span> Mock</h3>
<div class="outline-text-3" id="text-16-1">
<ul class="org-ul">
<li><code>unittest.mock.patch</code></li>
<li><code>@patch('somefunc')</code> or <code>with patch('somefunc') as mock</code></li>
<li>patch value: <code>with patch(__main__.x, 'patched_value')</code></li>
</ul>
</div>
</div>

<div id="outline-container-org4d81c33" class="outline-3">
<h3 id="org4d81c33"><span class="section-number-3">16.2</span> Assert Regex</h3>
<div class="outline-text-3" id="text-16-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #3a81c3; font-weight: bold;">self</span>.assertRaisesRegex<span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">ValueError</span>, <span style="color: #2d9574;">'error*'</span><span style="color: #3a81c3;">)</span>:
    ...
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc25c098" class="outline-3">
<h3 id="orgc25c098"><span class="section-number-3">16.3</span> Raise from another exception</h3>
<div class="outline-text-3" id="text-16-3">
<ul class="org-ul">
<li><code>raise ... from e</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgd670a37" class="outline-3">
<h3 id="orgd670a37"><span class="section-number-3">16.4</span> Warnings</h3>
<div class="outline-text-3" id="text-16-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> warnings
warnings.warn<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'logfile argument deprecated'</span>, <span style="color: #ba2f59; font-weight: bold;">DeprecationWarning</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orged33c9e" class="outline-2">
<h2 id="orged33c9e"><span class="section-number-2">17</span> Debuging</h2>
<div class="outline-text-2" id="text-17">
<ul class="org-ul">
<li><code>python3 -i</code>: starts an shell as soon as a program terminates, then uses <code>pdb</code></li>
</ul>
</div>
<div id="outline-container-orgb2ff6b7" class="outline-3">
<h3 id="orgb2ff6b7"><span class="section-number-3">17.1</span> Traceback</h3>
<div class="outline-text-3" id="text-17-1">
<ul class="org-ul">
<li><code>traceback.print_exc(file=sys.stderr)</code></li>
<li><code>traceback.print_stack(file=sys.stderr)</code></li>
</ul>
</div>
</div>

<div id="outline-container-org6b68694" class="outline-3">
<h3 id="org6b68694"><span class="section-number-3">17.2</span> Profiling</h3>
<div class="outline-text-3" id="text-17-2">
<p>
The first rule of optimization might be  to "not do it" the second rule is almost certainly "don't optimize the unimportant"
</p>
</div>
<div id="outline-container-orgb17088a" class="outline-4">
<h4 id="orgb17088a"><span class="section-number-4">17.2.1</span> Decorator Version</h4>
<div class="outline-text-4" id="text-17-2-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> time
<span style="color: #3a81c3; font-weight: bold;">from</span> functools <span style="color: #3a81c3; font-weight: bold;">import</span> wraps

<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">timethis</span><span style="color: #3a81c3;">(</span>func<span style="color: #3a81c3;">)</span>:
    <span style="color: #ba2f59; font-weight: bold;">@wraps</span><span style="color: #3a81c3;">(</span>func<span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">wrapper</span><span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>:
	<span style="color: #715ab1;">start</span> = time.perf_counter<span style="color: #3a81c3;">()</span>
	<span style="color: #715ab1;">r</span> = func<span style="color: #3a81c3;">(</span>*args, **kwargs<span style="color: #3a81c3;">)</span>
	<span style="color: #715ab1;">end</span> = time.perf_counter<span style="color: #3a81c3;">()</span>
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'{}.{} : {}'</span>.<span style="color: #3a81c3;">format</span><span style="color: #6c3163;">(</span>func.<span style="color: #3a81c3;">__module__</span>, func.<span style="color: #3a81c3;">__name__</span>, end - start<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
	<span style="color: #3a81c3; font-weight: bold;">return</span> r
    <span style="color: #3a81c3; font-weight: bold;">return</span> wrapper
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf64272c" class="outline-4">
<h4 id="orgf64272c"><span class="section-number-4">17.2.2</span> Contextmanager Version</h4>
<div class="outline-text-4" id="text-17-2-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #3a81c3; font-weight: bold;">import</span> time
<span style="color: #3a81c3; font-weight: bold;">from</span> contextlib <span style="color: #3a81c3; font-weight: bold;">import</span> contextmanager

<span style="color: #ba2f59; font-weight: bold;">@contextmanager</span>
<span style="color: #3a81c3; font-weight: bold;">def</span> <span style="color: #6c3163; font-weight: bold;">timeblock</span><span style="color: #3a81c3;">(</span>label<span style="color: #3a81c3;">)</span>:
    <span style="color: #715ab1;">start</span> = time.perf_counter<span style="color: #3a81c3;">()</span>
    <span style="color: #3a81c3; font-weight: bold;">try</span>:
	<span style="color: #3a81c3; font-weight: bold;">yield</span>
    <span style="color: #3a81c3; font-weight: bold;">finally</span>:
	<span style="color: #715ab1;">end</span> = time.perf_counter<span style="color: #3a81c3;">()</span>
	<span style="color: #3a81c3; font-weight: bold;">print</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">'{} : {}'</span>.<span style="color: #3a81c3;">format</span><span style="color: #6c3163;">(</span>label, end - start<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org481e706" class="outline-4">
<h4 id="org481e706"><span class="section-number-4">17.2.3</span> <code>time.process_time()</code></h4>
</div>
<div id="outline-container-orgc414c25" class="outline-4">
<h4 id="orgc414c25"><span class="section-number-4">17.2.4</span> Tools</h4>
<div class="outline-text-4" id="text-17-2-4">
<ul class="org-ul">
<li>pypy</li>
<li>Numba</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
