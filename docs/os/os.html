<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
<!-- 2021-09-09 Thu 22:31 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Operating Systems</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="ChrisChen" />
<meta name="keywords" content="OS" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
	     margin-bottom: .2em; }
  .subtitle { text-align: center;
	      font-size: medium;
	      font-weight: bold;
	      margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
	    padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css">
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
	displayAlign: "left",
	displayIndent: "2em",

	"HTML-CSS": { scale: 100,
			linebreaks: { automatic: "false" },
			webFont: "TeX"
		       },
	SVG: {scale: 100,
	      linebreaks: { automatic: "false" },
	      font: "TeX"},
	NativeMML: {scale: 100},
	TeX: { equationNumbers: {autoNumber: "AMS"},
	       MultLineWidth: "85%",
	       TagSide: "left",
	       TagIndent: ".8em"
	     }
});
</script>
<script type="text/javascript"
	src="https://cdn.bootcdn.net/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Operating Systems</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1f059ce">1. Represeting Infomation</a>
<ul>
<li><a href="#org132b4ab">1.1. Integer</a></li>
<li><a href="#org5b2569c">1.2. Floating Point</a></li>
</ul>
</li>
<li><a href="#orga01a9a2">2. Manipulating Infomation</a>
<ul>
<li><a href="#org6a1d497">2.1. Integer arithmatic</a></li>
<li><a href="#org4afd991">2.2. Floating Operation</a></li>
</ul>
</li>
<li><a href="#orgd72bf4b">3. Program Structure</a>
<ul>
<li><a href="#org67ab1e2">3.1. Processor State</a></li>
<li><a href="#orgb133425">3.2. Asm</a></li>
<li><a href="#org70b1637">3.3. Data Formats</a></li>
<li><a href="#orga75b9d8">3.4. Interger Registers</a></li>
<li><a href="#org01750a6">3.5. Operand Specifiers</a></li>
<li><a href="#org7c8011a">3.6. Basic Operations</a></li>
<li><a href="#org466c8ac">3.7. Control</a></li>
<li><a href="#orgf2f1daa">3.8. Procedure</a></li>
<li><a href="#org2971fde">3.9. Array Allocation</a></li>
<li><a href="#orgcdab825">3.10. Float Operations</a></li>
</ul>
</li>
<li><a href="#org65f5243">4. Optimizing Program Performance</a>
<ul>
<li><a href="#org97b9b0d">4.1. Limits of Optimizing Compilers</a></li>
<li><a href="#org35166e6">4.2. Expressing Program Performance</a></li>
<li><a href="#orgdb3e66b">4.3. Optimizing Performance</a></li>
<li><a href="#org5d0214a">4.4. CPU related Optimization</a></li>
<li><a href="#orgb7fe54e">4.5. Basic strategies for Optimization in the Real World</a></li>
<li><a href="#org2be8020">4.6. Profiling</a></li>
</ul>
</li>
<li><a href="#org4fed4cb">5. Storage</a>
<ul>
<li><a href="#org2954e06">5.1. Storage Hierarchy</a></li>
<li><a href="#org00db2bc">5.2. BUS</a></li>
<li><a href="#org8664f8c">5.3. Locality</a></li>
<li><a href="#org0139673">5.4. Cache Memories</a></li>
</ul>
</li>
<li><a href="#org585f158">6. Linking</a>
<ul>
<li><a href="#org5cc83f9">6.1. Object Files</a></li>
<li><a href="#orgebf961c">6.2. Symbols</a></li>
<li><a href="#org4f7f68d">6.3. Static Libraries</a></li>
<li><a href="#orga1a7b50">6.4. Shared Libraries</a></li>
<li><a href="#org1d46154">6.5. Relocation</a></li>
<li><a href="#orgb1198aa">6.6. Loading Executable Object Files</a></li>
<li><a href="#orgafedb7c">6.7. Position-Independent Code (PIC)</a></li>
<li><a href="#org5588f3f">6.8. Tools</a></li>
</ul>
</li>
<li><a href="#orgea97887">7. ECF(Exceptional Control Flow)</a>
<ul>
<li><a href="#orgb7f55fa">7.1. Classes of Exceptions</a></li>
<li><a href="#orgf3165bc">7.2. Process</a></li>
<li><a href="#org21221e7">7.3. Signals</a></li>
<li><a href="#org94869fd">7.4. Tools</a></li>
</ul>
</li>
<li><a href="#orgbb617e5">8. Unix I/O</a>
<ul>
<li><a href="#org270e3f9">8.1. File operations</a></li>
<li><a href="#org7ab6d0d">8.2. Directory</a></li>
<li><a href="#orgf28d030">8.3. I/O Redirection</a></li>
</ul>
</li>
<li><a href="#org9c7a6f0">9. Socket</a>
<ul>
<li><a href="#orga34c1a4">9.1. Network Byte Order</a></li>
<li><a href="#orgfe45bf9">9.2. IP Address</a></li>
<li><a href="#orgd1ef969">9.3. Connection</a></li>
<li><a href="#org0cbccac">9.4. Socket Address</a></li>
<li><a href="#orge81a17f">9.5. Interface</a></li>
</ul>
</li>
<li><a href="#orgfa3b49f">10. Concurrency</a>
<ul>
<li><a href="#org12b5df2">10.1. Process</a></li>
<li><a href="#orgb5f2fa6">10.2. I/O Multiplexing</a></li>
<li><a href="#org2b27348">10.3. Thread</a></li>
<li><a href="#orgc9c6e91">10.4. Synchronization</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org1f059ce" class="outline-2">
<h2 id="org1f059ce"><span class="section-number-2">1</span> Represeting Infomation</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org132b4ab" class="outline-3">
<h3 id="org132b4ab"><span class="section-number-3">1.1</span> Integer</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-orge03d695" class="outline-4">
<h4 id="orge03d695"><span class="section-number-4">1.1.1</span> Integer Limits</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
\[TMax_w = 2^{w-1}-1\quad TMin_w = - 2^{w-1}\quad UMax_w = 2^w-1\quad UMin_w = 0\]
</p>
</div>
</div>
<div id="outline-container-orgf1c2608" class="outline-4">
<h4 id="orgf1c2608"><span class="section-number-4">1.1.2</span> B2U</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
\[B2U_w(\overrightarrow{x})\doteq\sum_{i=0}^{w-1}x_i2^i\]
</p>
</div>
</div>
<div id="outline-container-orgdc72cf1" class="outline-4">
<h4 id="orgdc72cf1"><span class="section-number-4">1.1.3</span> B2T</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
\[B2T_w(\overrightarrow{x})\doteq-x_{w-1}2^{w-1}+\sum_{i=0}^{w-2}x_i2^i\]
</p>
</div>
</div>
<div id="outline-container-org3eaf747" class="outline-4">
<h4 id="org3eaf747"><span class="section-number-4">1.1.4</span> T2U</h4>
<div class="outline-text-4" id="text-1-1-4">
<p>
\[T2U_w(x)\doteqB2U_w(T2B_w(x))\]
</p>
<ul class="org-ul">
<li>input: \(TMin_w\sim TMax_w\)</li>
<li>output: \(0\sim UMax_w\)</li>
</ul>
<p>
\[T2U_w(x) = \begin{cases}
    x+2^w, & x < 0 \\
    x, & x \ge 0 \\
    \end{cases}\]
\[T2U_w(x) = x_{w-1}2^w + x\]
</p>
</div>
<div id="outline-container-orgab238d7" class="outline-5">
<h5 id="orgab238d7"><span class="section-number-5">1.1.4.1</span> Verification</h5>
<div class="outline-text-5" id="text-1-1-4-1">
<p>
\[B2U_w(\overrightarrow{x})-B2T_w(\overrightarrow{x})=x_{w-1}(2^{w-1}+2^{w-1})=x_{w-1}2^w\]
\[B2U_w(\overrightarrow{x})=x_{w-1}2^w + B2T_w(\overrightarrow{x})\]
Let \(\overrightarrow{x}=T2B_w(x)\) , Then:
\[T2U_w(x)=B2U_w(T2B_w(x)) = x_{w-1}2^w + B2T_w(T2B_w(x)) = x_{w-1}2^w + x\]
</p>
</div>
</div>
</div>

<div id="outline-container-org66c31ef" class="outline-4">
<h4 id="org66c31ef"><span class="section-number-4">1.1.5</span> \(U2T_w(x)\)</h4>
<div class="outline-text-4" id="text-1-1-5">
<p>
\[U2T_w(u) = \begin{cases}
    u, & u<2^{w-1} \\
    u - 2^w, & u\ge2^{w-1} \\
    \end{cases}\]
\[U2T_w(u)=B2T_w(U2B_w(u))=-u_{w-1}2^w+u\]
</p>
</div>
</div>

<div id="outline-container-orgb6da7d3" class="outline-4">
<h4 id="orgb6da7d3"><span class="section-number-4">1.1.6</span> Small size to big size</h4>
<div class="outline-text-4" id="text-1-1-6">
<ol class="org-ol">
<li>Change the size(fill 0 or 1 depends on signed/unsigned)</li>
<li>Convert signed/unsigned</li>
</ol>
</div>
</div>

<div id="outline-container-orga64f498" class="outline-4">
<h4 id="orga64f498"><span class="section-number-4">1.1.7</span> Big size to small size</h4>
<div class="outline-text-4" id="text-1-1-7">
<ul class="org-ul">
<li>Unsigned big2small：\(B2U_k([x_{k-1},x_{k-2},\cdots,x_0])=B2U_w([x_{w-1},x_{w-2},\cdots,x_0])\mod 2^k\)</li>
<li>Signed big2small：\(B2T_k([x_{k-1}, x_{k-2}, \cdots, x_0])=U2T_k(B2U_k([x_{k-1},x_{k-2},\cdots,x_0])\)</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org5b2569c" class="outline-3">
<h3 id="org5b2569c"><span class="section-number-3">1.2</span> Floating Point</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org0dde255" class="outline-4">
<h4 id="org0dde255"><span class="section-number-4">1.2.1</span> Fractional Binary Numbers</h4>
<div class="outline-text-4" id="text-1-2-1">
</div>
<div id="outline-container-org7c8abbe" class="outline-5">
<h5 id="org7c8abbe"><span class="section-number-5">1.2.1.1</span> Sign-Magnitude</h5>
<div class="outline-text-5" id="text-1-2-1-1">
<p>
\[B2S_w(\overrightarrow{x})\doteq(-1)^{x_{w-1}}\cdot(\dots)\]
</p>
</div>
</div>
<div id="outline-container-org21da62e" class="outline-5">
<h5 id="org21da62e"><span class="section-number-5">1.2.1.2</span> Fractional Decimal</h5>
<div class="outline-text-5" id="text-1-2-1-2">
<p>
\[d=\sum_{i=-n}^m10^i\times{d_i}\]
Consider Fractional decimal \(12.34_{10}\)
\[ 1\times{10^1} + 2\times{10^0} + 3\times{10^{-1}} + 4\times{10^{-2}}=12\frac{34}{100}\]
</p>
</div>
</div>
<div id="outline-container-org3d280b9" class="outline-5">
<h5 id="org3d280b9"><span class="section-number-5">1.2.1.3</span> Fractional Binary</h5>
<div class="outline-text-5" id="text-1-2-1-3">
<p>
\[b=\sum_{i=-n}^m2^i\times{b_i}\]
eg:  \(101.11_2\)
\[ 1\times{2^2} + 0\times{2^1} + 1\times{2^0} + 1\times{2^{-1}} + 1\times{2^{-2}} = 5\frac{3}{4}\]
</p>
</div>
</div>
</div>
<div id="outline-container-orgd645a1c" class="outline-4">
<h4 id="orgd645a1c"><span class="section-number-4">1.2.2</span> IEEE Floating-Point</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
\[V=(-1)^{s}\times{M}\times{2^E}\]
</p>
<ul class="org-ul">
<li>sign s: negative(s=1) positive(s=0), Sign-Magnitude</li>
<li>significand M: a fractional binary number, <i>n</i> bits</li>
<li>exponent E: weights the value by a power of 2, <i>k</i> bits</li>
<li>\(Bias = 2^{k-1} -1\)</li>
</ul>
</div>
<div id="outline-container-org02f24f2" class="outline-5">
<h5 id="org02f24f2"><span class="section-number-5">1.2.2.1</span> float(single-precision)</h5>
<div class="outline-text-5" id="text-1-2-2-1">
<p>
s=1, k=8, n=23 yielding a 32-bit representation, Bias = 127
</p>
</div>
</div>
<div id="outline-container-org9142faf" class="outline-5">
<h5 id="org9142faf"><span class="section-number-5">1.2.2.2</span> double(double-precision)</h5>
<div class="outline-text-5" id="text-1-2-2-2">
<p>
s=1, k=11, n=52, yielding a 64-bit representation, Bias = 1023
</p>
</div>
</div>
<div id="outline-container-orgce6f0ae" class="outline-5">
<h5 id="orgce6f0ae"><span class="section-number-5">1.2.2.3</span> Nomalized Values</h5>
<div class="outline-text-5" id="text-1-2-2-3">
<p>
Condition: exp is not all zeros(0) &amp; not all ones(255 for single, 2047 for double)
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">s</td>
<td class="org-left">exp neither all 1 nor all 0</td>
<td class="org-left">frac</td>
</tr>
</tbody>
</table>
<p>
\(E = e - Bias\), e is the unsigned number, Hance, the range of \(E\) is
</p>
<ul class="org-ul">
<li>\(-126\leq{E}\leq{+127}\) for single</li>
<li>\(-1022\leq{E}\leq{+1023}\) for double</li>
</ul>

<p>
\(M=1+f\) where \(0\leq{f}<1\) having binary representation \(0.f_{n-1}...f_1f_0\)
so that, M is in the range \(1\leq{M}<2\) This implied leading 1 is a trick
for getting an additional bit of precision for free.
</p>
</div>
</div>
<div id="outline-container-orgc1c9166" class="outline-5">
<h5 id="orgc1c9166"><span class="section-number-5">1.2.2.4</span> Denormalized Values</h5>
<div class="outline-text-5" id="text-1-2-2-4">
<p>
Condition: exp is all zeros
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">s</td>
<td class="org-left">all 0</td>
<td class="org-left">frac</td>
</tr>
</tbody>
</table>
<p>
Serve two purposes:
</p>
<ul class="org-ul">
<li>represent 0 (all bits are zero)</li>
<li>represent numbers that are very close to 0.0</li>
</ul>
</div>
</div>

<div id="outline-container-orgaf568e0" class="outline-5">
<h5 id="orgaf568e0"><span class="section-number-5">1.2.2.5</span> Spacial Values</h5>
<div class="outline-text-5" id="text-1-2-2-5">
<p>
Condition: exp is all ones
</p>
<ul class="org-ul">
<li><p>
infinity
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">s</td>
<td class="org-left">all 1</td>
<td class="org-right">0</td>
</tr>
</tbody>
</table></li>
<li><p>
NaN
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">s</td>
<td class="org-left">all 1</td>
<td class="org-left">\(\ne 0\)</td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</div>

<div id="outline-container-org3249a5e" class="outline-5">
<h5 id="org3249a5e"><span class="section-number-5">1.2.2.6</span> Examples</h5>
<div class="outline-text-5" id="text-1-2-2-6">
<p>
8-bit floating-point format
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">bits</th>
<th scope="col" class="org-right">e</th>
<th scope="col" class="org-right">E</th>
<th scope="col" class="org-left">\(2^E\)</th>
<th scope="col" class="org-left">f</th>
<th scope="col" class="org-left">M</th>
<th scope="col" class="org-left">\(2^E\times{M}\)</th>
<th scope="col" class="org-left">V</th>
<th scope="col" class="org-right">Decimal</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Zero</td>
<td class="org-left">0 0000 000</td>
<td class="org-right">0</td>
<td class="org-right">-6</td>
<td class="org-left">\(\frac{1}{64}\)</td>
<td class="org-left">\(\frac{0}{8}\)</td>
<td class="org-left">\(\frac{0}{8}\)</td>
<td class="org-left">\(\frac{0}{512}\)</td>
<td class="org-left">0</td>
<td class="org-right">0.0</td>
</tr>

<tr>
<td class="org-left">Smallest pos.</td>
<td class="org-left">0 0000 001</td>
<td class="org-right">0</td>
<td class="org-right">-6</td>
<td class="org-left">\(\frac{1}{64}\)</td>
<td class="org-left">\(\frac{1}{8}\)</td>
<td class="org-left">\(\frac{1}{8}\)</td>
<td class="org-left">\(\frac{1}{512}\)</td>
<td class="org-left">\(\frac{1}{512}\)</td>
<td class="org-right">0.001953</td>
</tr>

<tr>
<td class="org-left">Largest denorm.</td>
<td class="org-left">0 0000 111</td>
<td class="org-right">0</td>
<td class="org-right">-6</td>
<td class="org-left">\(\frac{1}{64}\)</td>
<td class="org-left">\(\frac{7}{8}\)</td>
<td class="org-left">\(\frac{7}{8}\)</td>
<td class="org-left">\(\frac{7}{512}\)</td>
<td class="org-left">\(\frac{7}{512}\)</td>
<td class="org-right">0.005859</td>
</tr>

<tr>
<td class="org-left">Smallest norm.</td>
<td class="org-left">0 0001 000</td>
<td class="org-right">1</td>
<td class="org-right">-6</td>
<td class="org-left">\(\frac{1}{64}\)</td>
<td class="org-left">\(\frac{0}{8}\)</td>
<td class="org-left">\(\frac{8}{8}\)</td>
<td class="org-left">\(\frac{8}{512}\)</td>
<td class="org-left">\(\frac{1}{64}\)</td>
<td class="org-right">0.013672</td>
</tr>

<tr>
<td class="org-left">One</td>
<td class="org-left">0 0111 000</td>
<td class="org-right">7</td>
<td class="org-right">0</td>
<td class="org-left">1</td>
<td class="org-left">\(\frac{0}{8}\)</td>
<td class="org-left">\(\frac{8}{8}\)</td>
<td class="org-left">\(\frac{8}{8}\)</td>
<td class="org-left">1</td>
<td class="org-right">1.0</td>
</tr>

<tr>
<td class="org-left">Largest norm.</td>
<td class="org-left">0 1110 111</td>
<td class="org-right">14</td>
<td class="org-right">7</td>
<td class="org-left">128</td>
<td class="org-left">\(\frac{7}{8}\)</td>
<td class="org-left">\(\frac{15}{8}\)</td>
<td class="org-left">\(\frac{1920}{8}\)</td>
<td class="org-left">240</td>
<td class="org-right">240.0</td>
</tr>

<tr>
<td class="org-left">Infinity</td>
<td class="org-left">0 1111 000</td>
<td class="org-right">-</td>
<td class="org-right">-</td>
<td class="org-left">-</td>
<td class="org-left">-</td>
<td class="org-left">-</td>
<td class="org-left">-</td>
<td class="org-left">\(\infty\)</td>
<td class="org-right">-</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orga01a9a2" class="outline-2">
<h2 id="orga01a9a2"><span class="section-number-2">2</span> Manipulating Infomation</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org6a1d497" class="outline-3">
<h3 id="org6a1d497"><span class="section-number-3">2.1</span> Integer arithmatic</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-org1eea6c1" class="outline-4">
<h4 id="org1eea6c1"><span class="section-number-4">2.1.1</span> Unsigned Addition</h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
\[ x+^u_wy= \left\{
  \begin{array}{l l}
    x+y & \quad x+y<2^w\\
    x+y-2^w & \quad 2^w\le x+y<2^{w-1}
   \end{array} \right.\]
Same as  \(x+^u_wy=(x+y) \mod 2^w\)
</p>
<p class="verse">
When overflow occured, \(sum=x+y-2^w\)<br />
Because \(y < 2^w\)<br />
We have \(sum = x +(y-2^w) < x\)<br />
sum &lt; x means it did overflow.<br />
</p>
</div>
</div>
<div id="outline-container-orgb7f12f0" class="outline-4">
<h4 id="orgb7f12f0"><span class="section-number-4">2.1.2</span> Unsigned Negation</h4>
<div class="outline-text-4" id="text-2-1-2">
<p>
\[ -^u_wx= \left\{
  \begin{array}{l l}
    x & \quad x=0\\
    2^w-x & \quad x>0
   \end{array} \right.\]
</p>
</div>
</div>
<div id="outline-container-orgd8da1f9" class="outline-4">
<h4 id="orgd8da1f9"><span class="section-number-4">2.1.3</span> Two's Complement Addition</h4>
<div class="outline-text-4" id="text-2-1-3">
<ol class="org-ol">
<li>from signed operand to unsigned</li>
<li>excute unsigned addition(truncate the overflow)</li>
</ol>
<p>
\[x+^t_wy\doteq U2T_w(T2U_w(x)+^u_wT2U_w(y))\]
\[=U2T_w[(x_{w-1}2^w+x+y_{w-1}2^w+y) \mod 2^w]\]
\[ x+^t_wy= \left\{
  \begin{array}{l l}
    x+y-2^w & \qquad x+y\ge 2^{w-1} \quad Positive \ overflow\\
    x+y & \qquad -2^{w-1}\le x+y<2^{w-1} \quad Normal\\
    x+y+2^w & \qquad x+y<-2^{w-1} \quad Negative \ overflow
   \end{array} \right.\]
Example:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">\(x\)</th>
<th scope="col" class="org-right">\(y\)</th>
<th scope="col" class="org-right">\(x+y\)</th>
<th scope="col" class="org-right">\(x+^t_4y\)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">-8(1000)</td>
<td class="org-right">-5(1011)</td>
<td class="org-right">-13(10011)</td>
<td class="org-right">3(0011)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org180f2cc" class="outline-4">
<h4 id="org180f2cc"><span class="section-number-4">2.1.4</span> Two's Complement Negation</h4>
<div class="outline-text-4" id="text-2-1-4">
<p>
\[ -^t_wx= \left\{
  \begin{array}{l l}
    -2^{w-1} & \qquad x=-2^{w-1} \\
    -x & \qquad x>-2^{w-1} \\
   \end{array} \right.\]
Two Clever Ways:
</p>
</div>
<div id="outline-container-org1879097" class="outline-5">
<h5 id="org1879097"><span class="section-number-5">2.1.4.1</span> One Way</h5>
<div class="outline-text-5" id="text-2-1-4-1">
<ol class="org-ol">
<li>complement the bits</li>
<li>increment by 1</li>
</ol>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">x</th>
<th scope="col" class="org-right">~x</th>
<th scope="col" class="org-right">incr(~x)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0101(5)</td>
<td class="org-right">1010(-6)</td>
<td class="org-right">1011(-5)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org26c7c19" class="outline-5">
<h5 id="org26c7c19"><span class="section-number-5">2.1.4.2</span> Another Way</h5>
<div class="outline-text-5" id="text-2-1-4-2">
<p>
Condition: \(x\neq 0\)
</p>
<ol class="org-ol">
<li>Split the bit vector into two parts.(the boundary is the rightmost 1)</li>
<li>Complement each bit on the left part.</li>
</ol>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">x</th>
<th scope="col" class="org-left">-x</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><i>101</i> 1 (-5)</td>
<td class="org-left"><i>010</i> 1 (5)</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-org6dc9dd5" class="outline-4">
<h4 id="org6dc9dd5"><span class="section-number-4">2.1.5</span> Unsigned Mutliplication</h4>
<div class="outline-text-4" id="text-2-1-5">
<p>
\(0\le x,y\le 2^{w}-1\) Hence,
\[0\le x\cdot y\le2^{2w}-2^{w+1}+1\]
This could require as many as 2w bits to represent.
\[ x \times ^u_wy=(x\cdot y)\ mod\ 2^w\]
</p>
</div>
</div>
<div id="outline-container-org92a1d0e" class="outline-4">
<h4 id="org92a1d0e"><span class="section-number-4">2.1.6</span> Two's Complement Multiplication</h4>
<div class="outline-text-4" id="text-2-1-6">
<p>
\(-2^{w-1}\le x,y \le 2^{w-1}-1\) Hence,
\[ -2^{2w-2}+2^{w-1} \le x\cdot y \le 2^{2w-2}\]
Also need 2w bits to represent.
\[ x \times ^t_wy = U2T_w((x\cdot y)\ mod\ 2^w) \]
</p>
</div>
</div>
<div id="outline-container-orgb43d8e0" class="outline-4">
<h4 id="orgb43d8e0"><span class="section-number-4">2.1.7</span> Reduce Mutiplication by shift and addition</h4>
<div class="outline-text-4" id="text-2-1-7">
<p>
Motivation Mutiplication requires 10 or more clock cycles. shift and addition requires 1 clock cycle.
\[ x \times ^t_w2^k  = x << k\]
</p>
</div>
<div id="outline-container-org0e7fd22" class="outline-5">
<h5 id="org0e7fd22"><span class="section-number-5">2.1.7.1</span> two forms:</h5>
<div class="outline-text-5" id="text-2-1-7-1">
<p>
\[(x << n) + (x << n-1) + \dots + (x << m)\]
\[(x << n+1) - (x << m)\]
</p>
<ul class="org-ul">
<li>eg: \(14\) can be rewrite as \((x<<4) - (x<<1)\) or \((x<<3) + (x<<2) + (x<<1)\)</li>
</ul>

<p>
Assuming additions and subtractions have comparable cost, then we have:
</p>
<ul class="org-ul">
<li>\(n = m\) , use Form1.</li>
<li>\(n = m+1\) , use either Form1 or Form2.</li>
<li>\(n > m+1\) , use Form2.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org073e7f2" class="outline-4">
<h4 id="org073e7f2"><span class="section-number-4">2.1.8</span> Reduce Division by shift</h4>
<div class="outline-text-4" id="text-2-1-8">
<p>
Division require 30 or more clock cycles.
</p>
</div>
<div id="outline-container-org916f25e" class="outline-5">
<h5 id="org916f25e"><span class="section-number-5">2.1.8.1</span> Logical Shift</h5>
<div class="outline-text-5" id="text-2-1-8-1">
<p>
\(x \div 2^k = x>>k\) where \(0 \le{k} < w\) and \(x\ge 0\)
</p>
</div>
</div>

<div id="outline-container-org4f15b43" class="outline-5">
<h5 id="org4f15b43"><span class="section-number-5">2.1.8.2</span> Arithmatic Shift</h5>
<div class="outline-text-5" id="text-2-1-8-2">
<p>
\(x \div 2^k = x>>k\) where \(0\le{k} < w\)
Follow the above, we'll find -7/2 yield -4 not -3, corrected by 'biasing' the value before shifting.
</p>
<ul class="org-ul">
<li>\(x \div 2^k = (x+ 2^k - 1) >> k\) where \(x < 0\)</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org4afd991" class="outline-3">
<h3 id="org4afd991"><span class="section-number-3">2.2</span> Floating Operation</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-org485e8c7" class="outline-4">
<h4 id="org485e8c7"><span class="section-number-4">2.2.1</span> Round</h4>
<div class="outline-text-4" id="text-2-2-1">
<ul class="org-ul">
<li>Round-to-even eg: 1.5 approximate 2, 2.5 approximate 2 (DEFAULT) avoid statistical bias</li>
<li>Round-toward-zero eg:-1.5 approximate -1, 1.5 approximate 1</li>
<li>Round-down eg: 1.5 approximate 1</li>
<li>Round-up eg: 1.5 approximate 2</li>
</ul>
</div>
</div>
<div id="outline-container-org0146d4b" class="outline-4">
<h4 id="org0146d4b"><span class="section-number-4">2.2.2</span> Arithmatic Operation</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
\[x+^fy=Round(x+y)\]
</p>
<ul class="org-ul">
<li>Compute \(x+y\) first, then round</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd72bf4b" class="outline-2">
<h2 id="orgd72bf4b"><span class="section-number-2">3</span> Program Structure</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org67ab1e2" class="outline-3">
<h3 id="org67ab1e2"><span class="section-number-3">3.1</span> Processor State</h3>
<div class="outline-text-3" id="text-3-1">
</div>
<div id="outline-container-org39e3e41" class="outline-4">
<h4 id="org39e3e41"><span class="section-number-4">3.1.1</span> program counter(%eip)</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
Indicates the address in memory of the next instruction to be executed
</p>
</div>
</div>
<div id="outline-container-org5a1a82b" class="outline-4">
<h4 id="org5a1a82b"><span class="section-number-4">3.1.2</span> integer register</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
Contain eight named locations storing 32-bit values
</p>
</div>
</div>
<div id="outline-container-orgbb40820" class="outline-4">
<h4 id="orgbb40820"><span class="section-number-4">3.1.3</span> condition code register</h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
Hold status information about the most recently executed arithmetic or logical instruction
</p>
</div>
</div>
<div id="outline-container-orgf9113a1" class="outline-4">
<h4 id="orgf9113a1"><span class="section-number-4">3.1.4</span> floating-point register</h4>
<div class="outline-text-4" id="text-3-1-4">
<p>
Store floating-point data
</p>
</div>
</div>
</div>

<div id="outline-container-orgb133425" class="outline-3">
<h3 id="orgb133425"><span class="section-number-3">3.2</span> Asm</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-sh">gcc -Og -S xxx.c <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">c -&gt; asm</span>
objdump -d xxx.o <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">obj -&gt; asm: disassemble</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org70b1637" class="outline-3">
<h3 id="org70b1637"><span class="section-number-3">3.3</span> Data Formats</h3>
<div class="outline-text-3" id="text-3-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">C declaration</th>
<th scope="col" class="org-left">Intel</th>
<th scope="col" class="org-left">Assembly code suffix</th>
<th scope="col" class="org-right">Size(bytes)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">char</td>
<td class="org-left">Byte</td>
<td class="org-left">b</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">short</td>
<td class="org-left">Word</td>
<td class="org-left">w</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-left">int</td>
<td class="org-left">Double word</td>
<td class="org-left">l</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">long</td>
<td class="org-left">Quad word</td>
<td class="org-left">q</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-left">char *</td>
<td class="org-left">Quad word</td>
<td class="org-left">q</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-left">float</td>
<td class="org-left">Single precision</td>
<td class="org-left">s</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">double</td>
<td class="org-left">Double precision</td>
<td class="org-left">l</td>
<td class="org-right">8</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orga75b9d8" class="outline-3">
<h3 id="orga75b9d8"><span class="section-number-3">3.4</span> Interger Registers</h3>
<div class="outline-text-3" id="text-3-4">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">63-32</th>
<th scope="col" class="org-left">31-16</th>
<th scope="col" class="org-left">15&#x2014;8</th>
<th scope="col" class="org-left">7&#x2014;0</th>
<th scope="col" class="org-left">use</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">%rax</td>
<td class="org-left">%eax</td>
<td class="org-left">%ax</td>
<td class="org-left">%al</td>
<td class="org-left">return value</td>
</tr>

<tr>
<td class="org-left">%rbx</td>
<td class="org-left">%ebx</td>
<td class="org-left">%bx</td>
<td class="org-left">%bl</td>
<td class="org-left">callee reserved</td>
</tr>

<tr>
<td class="org-left">%rcx</td>
<td class="org-left">%ecx</td>
<td class="org-left">%cx</td>
<td class="org-left">%cl</td>
<td class="org-left">4th argument</td>
</tr>

<tr>
<td class="org-left">%rdx</td>
<td class="org-left">%edx</td>
<td class="org-left">%dx</td>
<td class="org-left">%dl</td>
<td class="org-left">3th argument</td>
</tr>

<tr>
<td class="org-left">%rsi</td>
<td class="org-left">%esi</td>
<td class="org-left">%si</td>
<td class="org-left">%sil</td>
<td class="org-left">2nd argument</td>
</tr>

<tr>
<td class="org-left">%rdi</td>
<td class="org-left">%edi</td>
<td class="org-left">%di</td>
<td class="org-left">%dil</td>
<td class="org-left">1st argument</td>
</tr>

<tr>
<td class="org-left">%rbp</td>
<td class="org-left">%ebp</td>
<td class="org-left">%bp</td>
<td class="org-left">%bpl</td>
<td class="org-left">callee reserved</td>
</tr>

<tr>
<td class="org-left">%rsp</td>
<td class="org-left">%esp</td>
<td class="org-left">%sp</td>
<td class="org-left">%spl</td>
<td class="org-left">stack pointer</td>
</tr>

<tr>
<td class="org-left">%r8</td>
<td class="org-left">%r8d</td>
<td class="org-left">%r8w</td>
<td class="org-left">%r8b</td>
<td class="org-left">5th argument</td>
</tr>

<tr>
<td class="org-left">%r9</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">6th argument</td>
</tr>

<tr>
<td class="org-left">%r10</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">caller reserved</td>
</tr>

<tr>
<td class="org-left">%r11</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">caller reserved</td>
</tr>

<tr>
<td class="org-left">%r12</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">callee reserved</td>
</tr>

<tr>
<td class="org-left">%r13</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">callee reserved</td>
</tr>

<tr>
<td class="org-left">%r14</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">callee reserved</td>
</tr>

<tr>
<td class="org-left">%r15</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">callee reserved</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org01750a6" class="outline-3">
<h3 id="org01750a6"><span class="section-number-3">3.5</span> Operand Specifiers</h3>
<div class="outline-text-3" id="text-3-5">
</div>
<div id="outline-container-orgc0e4f42" class="outline-4">
<h4 id="orgc0e4f42"><span class="section-number-4">3.5.1</span> Access from three sources</h4>
<div class="outline-text-4" id="text-3-5-1">
<ol class="org-ol">
<li>immediate: for constant values</li>
<li>register: denotes the contents of one of the registers. \(R[E_a]\)</li>
<li>memory: memory location. \(M[Addr]\)</li>
</ol>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Form</th>
<th scope="col" class="org-left">Operand Value</th>
<th scope="col" class="org-left">Access way</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">\(\$Imm\)</td>
<td class="org-left">\(Imm\)</td>
<td class="org-left">Immediate</td>
</tr>

<tr>
<td class="org-left">\(r_a\)</td>
<td class="org-left">\(R[r_a]\)</td>
<td class="org-left">Register</td>
</tr>

<tr>
<td class="org-left">\(Imm\)</td>
<td class="org-left">\(M[Imm]\)</td>
<td class="org-left">Absolute</td>
</tr>

<tr>
<td class="org-left">\((r_a)\)</td>
<td class="org-left">\(M[R[r_a]]\)</td>
<td class="org-left">Indirect</td>
</tr>

<tr>
<td class="org-left">\(Imm(r_b)\)</td>
<td class="org-left">\(M[Imm+R[r_b]]\)</td>
<td class="org-left">Base + displacement</td>
</tr>

<tr>
<td class="org-left">\((r_b,r_i)\)</td>
<td class="org-left">\(M[R[r_b]+R[r_i]]\)</td>
<td class="org-left">Indexed</td>
</tr>

<tr>
<td class="org-left">\(Imm(r_b,r_i)\)</td>
<td class="org-left">\(M[Imm+R[r_b]+R[r_i]]\)</td>
<td class="org-left">Indexed</td>
</tr>

<tr>
<td class="org-left">\((,r_i,s)\)</td>
<td class="org-left">\(M[R[r_i]\cdot s]\)</td>
<td class="org-left">Scaled Indexed</td>
</tr>

<tr>
<td class="org-left">\(Imm(,r_i,s)\)</td>
<td class="org-left">\(M[Imm+R[r_i]\cdot s]\)</td>
<td class="org-left">Scaled Indexed</td>
</tr>

<tr>
<td class="org-left">\((r_b, r_i, s)\)</td>
<td class="org-left">\(M[R[r_b]+R[r_i]\cdot s]\)</td>
<td class="org-left">Scaled Indexed</td>
</tr>

<tr>
<td class="org-left">\(Imm(r_b, r_i, s)\)</td>
<td class="org-left">\(M[Imm+R[r_b]+R[r_i]\cdot s]\)</td>
<td class="org-left">Scaled Indexed</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-org7c8011a" class="outline-3">
<h3 id="org7c8011a"><span class="section-number-3">3.6</span> Basic Operations</h3>
<div class="outline-text-3" id="text-3-6">
</div>
<div id="outline-container-org2440be9" class="outline-4">
<h4 id="org2440be9"><span class="section-number-4">3.6.1</span> Data Movement</h4>
<div class="outline-text-4" id="text-3-6-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left"><b>MOV</b>  S,D</th>
<th scope="col" class="org-left">D &larr; S</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">movb</td>
<td class="org-left">byte</td>
</tr>

<tr>
<td class="org-left">movw</td>
<td class="org-left">word</td>
</tr>

<tr>
<td class="org-left">movl</td>
<td class="org-left">double word</td>
</tr>

<tr>
<td class="org-left">movq</td>
<td class="org-left">quad word</td>
</tr>

<tr>
<td class="org-left">movabsq</td>
<td class="org-left">abs quad word</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-org82b2d6d" class="outline-5">
<h5 id="org82b2d6d"><span class="section-number-5">3.6.1.1</span> small src \(\to\) large dest</h5>
<div class="outline-text-5" id="text-3-6-1-1">
<ul class="org-ul">
<li><p>
ZeroExtend
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><b>MOVZ</b>  S, R</td>
<td class="org-left">R&larr; ZeroExtend(S)</td>
</tr>
</tbody>
</table>
<p>
eg: movzbl, movzbw, movzwl, movzbq, movzwq
</p></li>
<li><p>
SignExtend
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><b>MOVS</b>  S, R</td>
<td class="org-left">R&larr; SignExtend(S)</td>
</tr>
</tbody>
</table>
<p>
eg: movsbw, movsbl, movswl, movsbq, movswq, movslq, cltq
</p>
<ul class="org-ul">
<li>cltq: %rax \(\leftarrow\) SignExtend(%eax)</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org18cd5fe" class="outline-5">
<h5 id="org18cd5fe"><span class="section-number-5">3.6.1.2</span> push onto the program stack</h5>
<div class="outline-text-5" id="text-3-6-1-2">
<p>
<b>pushq S</b>
</p>
<ol class="org-ol">
<li>R[%rsp] \(\leftarrow\) R[%rsp] - 8</li>
<li>M[R[%rsp]] \(\leftarrow\) S</li>
</ol>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #6c3163; font-weight: bold;">subq</span> <span style="color: #3a81c3; font-weight: bold;">$8</span>,<span style="color: #715ab1;">%rsp</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Decrement stack pointer</span>
<span style="color: #6c3163; font-weight: bold;">movq</span> <span style="color: #3a81c3; font-weight: bold;">%rbp</span>,<span style="color: #3a81c3;">(</span><span style="color: #715ab1;">%rsp</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">//</span><span style="color: #2aa1ae; background-color: #ecf3ec;">Store %rbp on stack</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc629355" class="outline-5">
<h5 id="orgc629355"><span class="section-number-5">3.6.1.3</span> pop from the program stack</h5>
<div class="outline-text-5" id="text-3-6-1-3">
<p>
<b>popq D</b>
</p>
<ol class="org-ol">
<li>D \(\leftarrow\) M[R[%rsp]]</li>
<li>R[%rsp] \(\leftarrow\) R[%rsp + 8]</li>
</ol>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #6c3163; font-weight: bold;">movq</span> <span style="color: #3a81c3;">(</span><span style="color: #715ab1;">%rsp</span><span style="color: #3a81c3;">)</span>,<span style="color: #715ab1;">%rax</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">//</span><span style="color: #2aa1ae; background-color: #ecf3ec;">Read %rax from stack</span>
<span style="color: #6c3163; font-weight: bold;">addl</span> <span style="color: #3a81c3; font-weight: bold;">$4</span>,<span style="color: #715ab1;">%esp</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;">//</span><span style="color: #2aa1ae; background-color: #ecf3ec;">Increment stack pointer</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8ea3e6e" class="outline-4">
<h4 id="org8ea3e6e"><span class="section-number-4">3.6.2</span> Arithmetic &amp; Logical Operations</h4>
<div class="outline-text-4" id="text-3-6-2">
</div>
<div id="outline-container-orgf3e3b95" class="outline-5">
<h5 id="orgf3e3b95"><span class="section-number-5">3.6.2.1</span> unary operations</h5>
<div class="outline-text-5" id="text-3-6-2-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">leaq  S,D</td>
<td class="org-left">D &lt;- &amp;S</td>
</tr>

<tr>
<td class="org-left">inc D</td>
<td class="org-left">D &lt;- D+1</td>
</tr>

<tr>
<td class="org-left">dec D</td>
<td class="org-left">D &lt;- D-1</td>
</tr>

<tr>
<td class="org-left">neg D</td>
<td class="org-left">D &lt;- -D</td>
</tr>

<tr>
<td class="org-left">not D</td>
<td class="org-left">D &lt;- ~D(complement)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org02c8288" class="outline-5">
<h5 id="org02c8288"><span class="section-number-5">3.6.2.2</span> binary operations</h5>
<div class="outline-text-5" id="text-3-6-2-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">binary op</td>
<td class="org-left">second operand: src &amp; dest</td>
</tr>

<tr>
<td class="org-left">add S,D</td>
<td class="org-left">D &lt;- D+S</td>
</tr>

<tr>
<td class="org-left">sub S,D</td>
<td class="org-left">D &lt;- D-S</td>
</tr>

<tr>
<td class="org-left">imul S,D</td>
<td class="org-left">D &lt;- D*S</td>
</tr>

<tr>
<td class="org-left">xor S,D</td>
<td class="org-left">D &lt;- D^S</td>
</tr>

<tr>
<td class="org-left">or S,D</td>
<td class="org-left">D &lt;- D&vert;S</td>
</tr>

<tr>
<td class="org-left">and S,D</td>
<td class="org-left">D &lt;- D&amp;S</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org6c4673a" class="outline-5">
<h5 id="org6c4673a"><span class="section-number-5">3.6.2.3</span> shift operations</h5>
<div class="outline-text-5" id="text-3-6-2-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">sal k,D</td>
<td class="org-left">D &lt;- D&lt;&lt;k</td>
</tr>

<tr>
<td class="org-left">shl k,D</td>
<td class="org-left">D &lt;- D&lt;&lt;k(same as sal)</td>
</tr>

<tr>
<td class="org-left">sar k,D</td>
<td class="org-left">D &lt;- D&gt;&gt;k(arithmetic shift)</td>
</tr>

<tr>
<td class="org-left">shr k,D</td>
<td class="org-left">D &lt;- D&gt;&gt;k(logical shift)</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-org9e32f26" class="outline-4">
<h4 id="org9e32f26"><span class="section-number-4">3.6.3</span> Special Arithmetic Operations</h4>
<div class="outline-text-4" id="text-3-6-3">
<p>
imul also support one-operand operaion.
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">imulq S</td>
<td class="org-left">R[%edx]:R[%eax] &lt;- S*R[%eax] (Signed)</td>
</tr>

<tr>
<td class="org-left">mulq S</td>
<td class="org-left">R[%edx]:R[%eax] &lt;- S*R[%eax] (Unsigned)</td>
</tr>

<tr>
<td class="org-left">clto</td>
<td class="org-left">R[%edx]:R[%eax] &lt;- SignExtend(R[%eax]) (-&gt; 16 bytes)</td>
</tr>

<tr>
<td class="org-left">idivq S</td>
<td class="org-left">R[%edx] &lt;- R[%edx]:R[%eax] mod S;(Signed)</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">R[%eax] &lt;- R[%edx]:R[%eax] / S;(Signed)</td>
</tr>

<tr>
<td class="org-left">divq S</td>
<td class="org-left">like idivq S (Unsigned)</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-org466c8ac" class="outline-3">
<h3 id="org466c8ac"><span class="section-number-3">3.7</span> Control</h3>
<div class="outline-text-3" id="text-3-7">
</div>
<div id="outline-container-org13451b3" class="outline-4">
<h4 id="org13451b3"><span class="section-number-4">3.7.1</span> Condiction Register</h4>
<div class="outline-text-4" id="text-3-7-1">
</div>
<div id="outline-container-org83665eb" class="outline-5">
<h5 id="org83665eb"><span class="section-number-5">3.7.1.1</span> condiction flags</h5>
<div class="outline-text-5" id="text-3-7-1-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">CF</td>
<td class="org-left">carry flag</td>
</tr>

<tr>
<td class="org-left">ZF</td>
<td class="org-left">zero flag</td>
</tr>

<tr>
<td class="org-left">SF</td>
<td class="org-left">sign flag(neg number)</td>
</tr>

<tr>
<td class="org-left">OF</td>
<td class="org-left">overflow flag</td>
</tr>
</tbody>
</table>
<ul class="org-ul">
<li><p>
Example: For t=a+b,
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">CF</td>
<td class="org-left">(unsigned)t &lt; (unsigned)a</td>
<td class="org-left">Unsigned Overflow</td>
</tr>

<tr>
<td class="org-left">ZF</td>
<td class="org-left">(t == 0)</td>
<td class="org-left">Zero</td>
</tr>

<tr>
<td class="org-left">SF</td>
<td class="org-left">(t &lt; 0)</td>
<td class="org-left">Negative</td>
</tr>

<tr>
<td class="org-left">OF</td>
<td class="org-left">(a&lt;0 <code>= b&lt;0)&amp;&amp;(t&lt;0 !</code> a&lt;0)</td>
<td class="org-left">Signed Overflow</td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</div>
<div id="outline-container-org3f18ed9" class="outline-5">
<h5 id="org3f18ed9"><span class="section-number-5">3.7.1.2</span> CMP &amp; TEST instructions</h5>
<div class="outline-text-5" id="text-3-7-1-2">
<p>
These two instructions that set the condiction code without updating their destination.
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">cmp \(S_1,S_2\)</td>
<td class="org-left">\(S_2-S_1\)</td>
<td class="org-left">cmpb, cmpw, cmpl, cmpq</td>
</tr>

<tr>
<td class="org-left">test \(S_1,S_2\)</td>
<td class="org-left">\(S_1\) &amp; \(S_2\)</td>
<td class="org-left">testb, testw, testl, testq</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-orgdb51cc4" class="outline-4">
<h4 id="orgdb51cc4"><span class="section-number-4">3.7.2</span> Accessing the Condition Codes</h4>
<div class="outline-text-4" id="text-3-7-2">
<p>
There are three common ways of using the condition codes.
</p>
</div>
<div id="outline-container-org336471c" class="outline-5">
<h5 id="org336471c"><span class="section-number-5">3.7.2.1</span> SET Instruntions</h5>
<div class="outline-text-5" id="text-3-7-2-1">
<ul class="org-ul">
<li><p>
set directly
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Instruction</th>
<th scope="col" class="org-left">Synonym</th>
<th scope="col" class="org-left">Effect</th>
<th scope="col" class="org-left">Set condition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">sete D</td>
<td class="org-left">setz</td>
<td class="org-left">D &lt;- ZF</td>
<td class="org-left">Equal/zero</td>
</tr>

<tr>
<td class="org-left">setne D</td>
<td class="org-left">setnz</td>
<td class="org-left">D &lt;- ~ZF</td>
<td class="org-left">Not Equal/not zero</td>
</tr>

<tr>
<td class="org-left">sets D</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">D &lt;- SF</td>
<td class="org-left">Negative</td>
</tr>

<tr>
<td class="org-left">setns D</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">D &lt;- ~SF</td>
<td class="org-left">Nonnegative</td>
</tr>
</tbody>
</table></li>
<li><p>
signed group
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">setg D</td>
<td class="org-left">setnle</td>
<td class="org-left">D &lt;- ~(SF^OF) &amp; ~ZF</td>
<td class="org-left">&gt;</td>
</tr>

<tr>
<td class="org-left">setge D</td>
<td class="org-left">setnl</td>
<td class="org-left">D &lt;- ~(SF^OF)</td>
<td class="org-left">&gt;=</td>
</tr>

<tr>
<td class="org-left">setl D</td>
<td class="org-left">setnge</td>
<td class="org-left">D &lt;- SF^OF</td>
<td class="org-left">&lt;</td>
</tr>

<tr>
<td class="org-left">setle D</td>
<td class="org-left">setnge</td>
<td class="org-left">D &lt;- (SF^OF) &vert; ZF</td>
<td class="org-left">&lt;=</td>
</tr>
</tbody>
</table></li>
<li><p>
unsigned group
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">seta D</td>
<td class="org-left">setnbe</td>
<td class="org-left">D &lt;- ~CF &amp; ~ZF</td>
<td class="org-left">&gt;</td>
</tr>

<tr>
<td class="org-left">setae D</td>
<td class="org-left">setnb</td>
<td class="org-left">D &lt;- ~CF</td>
<td class="org-left">&gt;=</td>
</tr>

<tr>
<td class="org-left">setb D</td>
<td class="org-left">setnae</td>
<td class="org-left">D &lt;- CF</td>
<td class="org-left">&lt;</td>
</tr>

<tr>
<td class="org-left">setbe D</td>
<td class="org-left">setna</td>
<td class="org-left">D &lt;- CF &vert;  ZF</td>
<td class="org-left">&lt;=</td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</div>
<div id="outline-container-orgfea7f38" class="outline-5">
<h5 id="orgfea7f38"><span class="section-number-5">3.7.2.2</span> JUMP instructions</h5>
<div class="outline-text-5" id="text-3-7-2-2">
<ul class="org-ul">
<li><p>
jump
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Instruction</th>
<th scope="col" class="org-left">Synonym</th>
<th scope="col" class="org-left">Condition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">jmp Label</td>
<td class="org-left">direct jump</td>
<td class="org-left">1</td>
</tr>

<tr>
<td class="org-left">jmp *Operand</td>
<td class="org-left">indirect jump</td>
<td class="org-left">1</td>
</tr>

<tr>
<td class="org-left">je L</td>
<td class="org-left">jz</td>
<td class="org-left">ZF</td>
</tr>

<tr>
<td class="org-left">jne L</td>
<td class="org-left">jnz</td>
<td class="org-left">~ZF</td>
</tr>

<tr>
<td class="org-left">js L</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">SF</td>
</tr>

<tr>
<td class="org-left">jns L</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">~SF</td>
</tr>
</tbody>
</table></li>
<li><p>
signed group
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">jg L</td>
<td class="org-left">jnle</td>
<td class="org-left">~(SF^OF)&amp;~ZF</td>
<td class="org-left">&gt;</td>
</tr>

<tr>
<td class="org-left">jge L</td>
<td class="org-left">jnl</td>
<td class="org-left">~(SF^OF)</td>
<td class="org-left">&gt;=</td>
</tr>

<tr>
<td class="org-left">jl L</td>
<td class="org-left">jnge</td>
<td class="org-left">SF^OF</td>
<td class="org-left">&lt;</td>
</tr>

<tr>
<td class="org-left">jle L</td>
<td class="org-left">jng</td>
<td class="org-left">(SF^OF)&vert;ZF</td>
<td class="org-left">&lt;=</td>
</tr>
</tbody>
</table></li>
<li><p>
unsigned group
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">ja L</td>
<td class="org-left">jnbe</td>
<td class="org-left">~CF &amp; ~ZF</td>
<td class="org-left">&gt;</td>
</tr>

<tr>
<td class="org-left">jae L</td>
<td class="org-left">jnb</td>
<td class="org-left">~CF</td>
<td class="org-left">&gt;=</td>
</tr>

<tr>
<td class="org-left">jb L</td>
<td class="org-left">jnae</td>
<td class="org-left">CF</td>
<td class="org-left">&lt;</td>
</tr>

<tr>
<td class="org-left">jbe L</td>
<td class="org-left">jna</td>
<td class="org-left">CF&vert;ZF</td>
<td class="org-left">&lt;=</td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</div>
<div id="outline-container-org9226c86" class="outline-5">
<h5 id="org9226c86"><span class="section-number-5">3.7.2.3</span> conditional MOVE instructions</h5>
<div class="outline-text-5" id="text-3-7-2-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Instruction</th>
<th scope="col" class="org-left">Synonym</th>
<th scope="col" class="org-left">Condition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">cmove S, R</td>
<td class="org-left">cmovz</td>
<td class="org-left">ZF</td>
</tr>

<tr>
<td class="org-left">cmovne</td>
<td class="org-left">cmovnz</td>
<td class="org-left">~ZF</td>
</tr>

<tr>
<td class="org-left">cmovs</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">SF</td>
</tr>

<tr>
<td class="org-left">cmovns</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">~SF</td>
</tr>

<tr>
<td class="org-left">cmovg</td>
<td class="org-left">cmovnle</td>
<td class="org-left">~(SF^OF)&amp;~ZF</td>
</tr>

<tr>
<td class="org-left">cmovge</td>
<td class="org-left">cmovnl</td>
<td class="org-left">~(SF^OF)</td>
</tr>

<tr>
<td class="org-left">cmovl</td>
<td class="org-left">cmovnge</td>
<td class="org-left">SF^OF</td>
</tr>

<tr>
<td class="org-left">cmovle</td>
<td class="org-left">cmovng</td>
<td class="org-left">(SF^OF)&vert;ZF</td>
</tr>

<tr>
<td class="org-left">cmova</td>
<td class="org-left">cmovnbe</td>
<td class="org-left">~CF&amp;~ZF</td>
</tr>

<tr>
<td class="org-left">cmovae</td>
<td class="org-left">cmovnb</td>
<td class="org-left">~CF</td>
</tr>

<tr>
<td class="org-left">cmovb</td>
<td class="org-left">cmovnae</td>
<td class="org-left">CF</td>
</tr>

<tr>
<td class="org-left">cmovbe</td>
<td class="org-left">cmovna</td>
<td class="org-left">CF&vert;ZF</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-orgb28fbc2" class="outline-4">
<h4 id="orgb28fbc2"><span class="section-number-4">3.7.3</span> Statements in C</h4>
<div class="outline-text-4" id="text-3-7-3">
</div>
<div id="outline-container-org8ec8c1c" class="outline-5">
<h5 id="org8ec8c1c"><span class="section-number-5">3.7.3.1</span> if</h5>
<div class="outline-text-5" id="text-3-7-3-1">
<ul class="org-ul">
<li><p>
General in C
</p>
<div class="org-src-container">
<pre class="src src-text">if (test-expr)
   then-statement
else
   else-statement
</pre>
</div></li>
<li><p>
normal form with goto statement
</p>
<div class="org-src-container">
<pre class="src src-text">    t = test-expr;
    if (t)
       goto true;
    else-statement
    goto done;
true:
    then-statement
done:
</pre>
</div></li>
<li><p>
assembly form
</p>
<div class="org-src-container">
<pre class="src src-text">    t = test-expr;
    if (!t)
       goto false-label;
    then-statement
    goto done;
false-label:
    else-statement
done:
</pre>
</div></li>
<li><p>
when there is no else-statement.
</p>
<div class="org-src-container">
<pre class="src src-text">    t = test-expr;
    if (!t)
       goto done;
    then-statement
done:
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org4e95634" class="outline-5">
<h5 id="org4e95634"><span class="section-number-5">3.7.3.2</span> ? condtion</h5>
<div class="outline-text-5" id="text-3-7-3-2">
<div class="org-src-container">
<pre class="src src-text">v = test-expr ? then-expr : else-expr;
</pre>
</div>
<ul class="org-ul">
<li><p>
standard form
</p>
<div class="org-src-container">
<pre class="src src-text">    if (!test-expr)
	goto false;
    v = then-expr;
    goto done;
false:
    v = else-expr;
done:
</pre>
</div></li>
</ul>
<ul class="org-ul">
<li><p>
more abstract form
</p>
<div class="org-src-container">
<pre class="src src-text">vt = then-expr;
v = else-expr;
t = test-expr;
if (t) v = vt;
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgfdfba59" class="outline-5">
<h5 id="orgfdfba59"><span class="section-number-5">3.7.3.3</span> do&#x2026;while</h5>
<div class="outline-text-5" id="text-3-7-3-3">
<div class="org-src-container">
<pre class="src src-text">do
    body-statement
while (test-expr)
</pre>
</div>
<ul class="org-ul">
<li><p>
goto version
</p>
<div class="org-src-container">
<pre class="src src-text">loop:
    body-statement
    t = test-expr;
    if (t)
       goto loop;
done:
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org6d4eacc" class="outline-5">
<h5 id="org6d4eacc"><span class="section-number-5">3.7.3.4</span> while</h5>
<div class="outline-text-5" id="text-3-7-3-4">
<div class="org-src-container">
<pre class="src src-text">while (test-expr)
    body-statement
</pre>
</div>
<ul class="org-ul">
<li><p>
goto version
</p>
<div class="org-src-container">
<pre class="src src-text">t = test-expr
if (!t)
   goto done;
loop:
   body-statement
   if (t)
      goto loop;
done:
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org90b6d9d" class="outline-5">
<h5 id="org90b6d9d"><span class="section-number-5">3.7.3.5</span> for</h5>
<div class="outline-text-5" id="text-3-7-3-5">
<div class="org-src-container">
<pre class="src src-text">for (init-expr; test-expr; update-expr)
    body-statement
</pre>
</div>
<ul class="org-ul">
<li><p>
Equivalent to while loop
</p>
<div class="org-src-container">
<pre class="src src-text">init-expr;
while (test-expr)
    body-statement
    update-expr;
</pre>
</div></li>
<li><p>
goto vesion:
</p>
<div class="org-src-container">
<pre class="src src-text">init-expr;
t = test-expr;
if (!t)
   goto done;

loop:
   body-statement
   update-expr;
   if (t)
      goto loop;
done:
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org58ac350" class="outline-5">
<h5 id="org58ac350"><span class="section-number-5">3.7.3.6</span> switch</h5>
<div class="outline-text-5" id="text-3-7-3-6">
<p>
Compilers uses the <b>jump table</b> to achieve conditional jumping. Think of jump table as an array of function pointers.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #3a81c3; font-weight: bold;">switch</span> <span style="color: #3a81c3;">(</span>n<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">case</span> 100:
    ...;
    <span style="color: #3a81c3; font-weight: bold;">break</span>;
  <span style="color: #3a81c3; font-weight: bold;">case</span> 102:
    ...;
    <span style="color: #3a81c3; font-weight: bold;">break</span>;
  <span style="color: #3a81c3; font-weight: bold;">case</span> 103:
    ...;
    <span style="color: #3a81c3; font-weight: bold;">break</span>;
  <span style="color: #3a81c3; font-weight: bold;">case</span> 105:
    ...;
    <span style="color: #3a81c3; font-weight: bold;">break</span>;
  <span style="color: #3a81c3; font-weight: bold;">default</span>:
    <span style="color: #3a81c3; font-weight: bold;">break</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
impl
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4e3163;">loc_A</span>:
  ...
loc_B:
  ...
...

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> *jt<span style="color: #3a81c3;">[</span>5<span style="color: #3a81c3;">]</span> = <span style="color: #3a81c3;">{</span>
  &amp;&amp;loc_A, &amp;&amp;Loc_B, &amp;&amp;loc_C, &amp;&amp;loc_def, &amp;&amp;loc_D
<span style="color: #3a81c3;">}</span>;
<span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">index</span> = n-100;
<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">(</span>index &gt; 4<span style="color: #3a81c3;">)</span>
  <span style="color: #3a81c3; font-weight: bold;">goto</span> <span style="color: #4e3163;">loc_def</span>;
<span style="color: #3a81c3; font-weight: bold;">goto</span> *it<span style="color: #3a81c3;">[</span>index<span style="color: #3a81c3;">]</span>;

</pre>
</div></li>

<li><p>
jump table in asm
</p>
<div class="org-src-container">
<pre class="src src-asm">  <span style="color: #3a81c3; font-weight: bold;">.section</span> .rodata
  <span style="color: #3a81c3; font-weight: bold;">.align</span> 8 <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Align address to multiple of 8</span>
<span style="color: #6c3163; font-weight: bold;">.L4</span>:
  <span style="color: #3a81c3; font-weight: bold;">.quad</span> .L3 <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">case 100: loc_A</span>
  <span style="color: #3a81c3; font-weight: bold;">.quad</span> .L8 <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">case 101: default</span>
  <span style="color: #3a81c3; font-weight: bold;">.quad</span> .L5 <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">case 102: loc_B</span>
  <span style="color: #3a81c3; font-weight: bold;">.quda</span> .L6 <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">case 103: loc_C</span>
  <span style="color: #3a81c3; font-weight: bold;">.quda</span> .L7 <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">case 105: loc_D</span>
  <span style="color: #3a81c3; font-weight: bold;">.quda</span> .L8 <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">default</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf2f1daa" class="outline-3">
<h3 id="orgf2f1daa"><span class="section-number-3">3.8</span> Procedure</h3>
<div class="outline-text-3" id="text-3-8">
<p>
Suppose procedure P(the caller) calls procedure Q(the callee).
</p>
</div>
<div id="outline-container-org00f5a4c" class="outline-4">
<h4 id="org00f5a4c"><span class="section-number-4">3.8.1</span> Stack Frame</h4>
<div class="outline-text-4" id="text-3-8-1">
<ul class="org-ul">
<li><p>
caller's frame:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">arg n</td>
</tr>

<tr>
<td class="org-left">&#x2026;</td>
</tr>

<tr>
<td class="org-left">arg 1</td>
</tr>

<tr>
<td class="org-left">return address(push callee's return address to stack)</td>
</tr>

<tr>
<td class="org-left">callee's frame</td>
</tr>
</tbody>
</table></li>

<li><p>
callee's frame:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Saved %rbp</td>
</tr>

<tr>
<td class="org-left">Saved registers, local var, temporaries</td>
</tr>

<tr>
<td class="org-left">Argument build area (%rsp stack pointer)</td>
</tr>

<tr>
<td class="org-left"><b>-stack top-</b></td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</div>
<div id="outline-container-org3796d0e" class="outline-4">
<h4 id="org3796d0e"><span class="section-number-4">3.8.2</span> Procedure Call</h4>
<div class="outline-text-4" id="text-3-8-2">
<p>
Instructions:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">call Label</td>
<td class="org-left">procedure call</td>
</tr>

<tr>
<td class="org-left">call *Operand</td>
<td class="org-left">procedure call</td>
</tr>

<tr>
<td class="org-left">ret</td>
<td class="org-left">return from call</td>
</tr>
</tbody>
</table>

<p>
Example:
</p>
<div class="org-src-container">
<pre class="src src-text">400540 &lt;multstore&gt;:
  400540: 53        push %rbx
  400541: 48 89 d3  mov  %rdx,%rbx
  ...
  40054d: c3        retq

.caller:
  400563: e8 d8 ff ff ff      callq   400540 &lt;multstore&gt;
  400568: 48 8b 54 24 08      mov     0x8(%rsp),%rdx
</pre>
</div>
</div>

<div id="outline-container-orgf89d9d9" class="outline-5">
<h5 id="orgf89d9d9"><span class="section-number-5">3.8.2.1</span> call</h5>
<div class="outline-text-5" id="text-3-8-2-1">
<p>
&lt;before&gt;%rip(PC counter): 0x400563, %rsp: 0x7fffffffe840
</p>
<ol class="org-ol">
<li>push a return address on the P's stack</li>
<li>set %rip to the start of Q</li>
</ol>

<p>
&lt;after&gt;%rip: 0x400540, %rsp: 0x7fffffffe838(-8bytes)
</p>
</div>
</div>

<div id="outline-container-orgff01cd5" class="outline-5">
<h5 id="orgff01cd5"><span class="section-number-5">3.8.2.2</span> ret</h5>
<div class="outline-text-5" id="text-3-8-2-2">
<ol class="org-ol">
<li>pop value from return address</li>
</ol>

<p>
&lt;after&gt;%rip: 0x400568, %rsp: 0x7fffffffe840
</p>

<ul class="org-ul">
<li>use 0x8(%rsp) to access return value from callee.</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org2971fde" class="outline-3">
<h3 id="org2971fde"><span class="section-number-3">3.9</span> Array Allocation</h3>
<div class="outline-text-3" id="text-3-9">
</div>
<div id="outline-container-org58ebabd" class="outline-4">
<h4 id="org58ebabd"><span class="section-number-4">3.9.1</span> 1d-array</h4>
<div class="outline-text-4" id="text-3-9-1">
<p>
\[\&A[i] = \&A[0] + i\cdot sizeof(type)\]
</p>
</div>
</div>
<div id="outline-container-org5d53e2d" class="outline-4">
<h4 id="org5d53e2d"><span class="section-number-4">3.9.2</span> 2d-array</h4>
<div class="outline-text-4" id="text-3-9-2">
<p>
for an array declare as D[R][C],
\[\&D[i][j] = \&D[0] + sizeof(type)\cdot (C\cdot i + j)\]
</p>
<ul class="org-ul">
<li><p>
Example
s: start address  t: type size  declaration: A[R][C]
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">A[0][0]</td>
<td class="org-left">s</td>
</tr>

<tr>
<td class="org-left">A[0][1]</td>
<td class="org-left">s+t</td>
</tr>

<tr>
<td class="org-left">A[1][0]</td>
<td class="org-left">s+Ct</td>
</tr>

<tr>
<td class="org-left">A[1][2]</td>
<td class="org-left">s+(C+2)t</td>
</tr>

<tr>
<td class="org-left">A[3][4]</td>
<td class="org-left">s+(3C+4)t</td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</div>
<div id="outline-container-orgcb71150" class="outline-4">
<h4 id="orgcb71150"><span class="section-number-4">3.9.3</span> variable-size array</h4>
<div class="outline-text-4" id="text-3-9-3">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">var_ele</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">n</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">A</span><span style="color: #6c3163;">[</span>n<span style="color: #6c3163;">][</span>n<span style="color: #6c3163;">]</span>, <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">i</span>, <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">j</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> A<span style="color: #6c3163;">[</span>i<span style="color: #6c3163;">][</span>j<span style="color: #6c3163;">]</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #2aa1ae; background-color: #ecf3ec;">//</span><span style="color: #2aa1ae; background-color: #ecf3ec;">n in %rdi, A in %rsi, i in %rdx, j in %rcx</span>
<span style="color: #6c3163; font-weight: bold;">var_ele</span>:
  <span style="color: #3a81c3; font-weight: bold;">imulq</span> <span style="color: #715ab1;">%rdx</span>, <span style="color: #715ab1;">%rdi</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Compute n*i -&gt; %rdi</span>
  <span style="color: #3a81c3; font-weight: bold;">leaq</span>  <span style="color: #3a81c3;">(</span><span style="color: #715ab1;">%rsi</span>,<span style="color: #715ab1;">%rdi</span>,4<span style="color: #3a81c3;">)</span>, <span style="color: #715ab1;">%rax</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Compute &amp;A[0]+4(n*i) -&gt; %rax</span>
  <span style="color: #3a81c3; font-weight: bold;">movl</span>  <span style="color: #3a81c3;">(</span><span style="color: #715ab1;">%rax</span>,<span style="color: #715ab1;">%rcx</span>,4<span style="color: #3a81c3;">)</span>, <span style="color: #715ab1;">%eax</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Read from M[&amp;A[0]+4(n*i)+4j] -&gt; %eax</span>
  <span style="color: #3a81c3; font-weight: bold;">ret</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcdab825" class="outline-3">
<h3 id="orgcdab825"><span class="section-number-3">3.10</span> Float Operations</h3>
<div class="outline-text-3" id="text-3-10">
</div>
<div id="outline-container-org3f255fd" class="outline-4">
<h4 id="org3f255fd"><span class="section-number-4">3.10.1</span> Move</h4>
<div class="outline-text-4" id="text-3-10-1">
<p>
vmovss, vmovsd
</p>
</div>
</div>

<div id="outline-container-orgde39dd6" class="outline-4">
<h4 id="orgde39dd6"><span class="section-number-4">3.10.2</span> Conversion</h4>
<div class="outline-text-4" id="text-3-10-2">
<ul class="org-ul">
<li>vcvtsi2ss, vcvtsi2sd</li>
<li>vcvtsi2ssq(64bit int to single), vcvsi2sdq(64bit int to double)</li>
</ul>
</div>
</div>

<div id="outline-container-orgb07c741" class="outline-4">
<h4 id="orgb07c741"><span class="section-number-4">3.10.3</span> In Procedure</h4>
<div class="outline-text-4" id="text-3-10-3">
<ul class="org-ul">
<li>%xmm0~%xmm7: store float args</li>
<li>%xmm0: return float</li>
</ul>
</div>
</div>

<div id="outline-container-org28a6a1d" class="outline-4">
<h4 id="org28a6a1d"><span class="section-number-4">3.10.4</span> Operand</h4>
<div class="outline-text-4" id="text-3-10-4">
<ul class="org-ul">
<li>vaddss, vsubss, vmulss, vdivss, vmaxss, vminss, sqrtss</li>
<li>XOR&amp;AND: vxorps, vandps, vorpd(double), andpd(double)</li>
<li>Comparation: ucomiss, ucomisd(double)</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org65f5243" class="outline-2">
<h2 id="org65f5243"><span class="section-number-2">4</span> Optimizing Program Performance</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org97b9b0d" class="outline-3">
<h3 id="org97b9b0d"><span class="section-number-3">4.1</span> Limits of Optimizing Compilers</h3>
<div class="outline-text-3" id="text-4-1">
</div>
<div id="outline-container-org3b10899" class="outline-4">
<h4 id="org3b10899"><span class="section-number-4">4.1.1</span> memory aliasing</h4>
<div class="outline-text-4" id="text-4-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">twiddle1</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">xp</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">yp</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  *xp += *yp;
  *xp += *yp;
<span style="color: #3a81c3;">}</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">twiddle2</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">xp</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">yp</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span> *xp += 2 * *yp; <span style="color: #3a81c3;">}</span>
</pre>
</div>
<p>
The results will be different when xp == yp. Compilers can't optimize <b>twiddle1</b>
</p>
</div>
</div>
<div id="outline-container-org7dde77a" class="outline-4">
<h4 id="org7dde77a"><span class="section-number-4">4.1.2</span> function calls</h4>
<div class="outline-text-4" id="text-4-1-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #6c3163; font-weight: bold;">f</span><span style="color: #3a81c3;">()</span>;
<span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #6c3163; font-weight: bold;">func1</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span> <span style="color: #3a81c3; font-weight: bold;">return</span> f<span style="color: #6c3163;">()</span> + f<span style="color: #6c3163;">()</span> + f<span style="color: #6c3163;">()</span> + f<span style="color: #6c3163;">()</span>; <span style="color: #3a81c3;">}</span>
<span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #6c3163; font-weight: bold;">func2</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span> <span style="color: #3a81c3; font-weight: bold;">return</span> 4 * f<span style="color: #6c3163;">()</span>; <span style="color: #3a81c3;">}</span>
</pre>
</div>
<p>
Compilers don't know if f() has a <i>side effect</i>.
</p>
</div>
</div>
</div>

<div id="outline-container-org35166e6" class="outline-3">
<h3 id="org35166e6"><span class="section-number-3">4.2</span> Expressing Program Performance</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<div id="outline-container-orgb525a9a" class="outline-4">
<h4 id="orgb525a9a"><span class="section-number-4">4.2.1</span> CPE(Cycles Per Element)</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
4GHz means \(4.0\times 10^9\) cycles per second.
The period of a 4GHz clock is 0.25 nanoseconds.
</p>
</div>
</div>
</div>

<div id="outline-container-orgdb3e66b" class="outline-3">
<h3 id="orgdb3e66b"><span class="section-number-3">4.3</span> Optimizing Performance</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-org841b600" class="outline-4">
<h4 id="org841b600"><span class="section-number-4">4.3.1</span> Eliminating Loop Inefficiencies</h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
e.g.: invoke unnecessary <b>strlen</b> in the loop
</p>
</div>
</div>

<div id="outline-container-org07e2061" class="outline-4">
<h4 id="org07e2061"><span class="section-number-4">4.3.2</span> Reducing Procedure Calls</h4>
</div>
<div id="outline-container-orgdf9fe19" class="outline-4">
<h4 id="orgdf9fe19"><span class="section-number-4">4.3.3</span> Eliminating Unneeded Memory References</h4>
<div class="outline-text-4" id="text-4-3-3">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">i</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">result</span> = 0;
<span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #3a81c3;">(</span>i = 0; i &lt; MAXIMUM; ++i<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  *result = *result + i; <span style="color: #2aa1ae; background-color: #ecf3ec;">//</span><span style="color: #2aa1ae; background-color: #ecf3ec;">just use int instead of int*</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5d0214a" class="outline-3">
<h3 id="org5d0214a"><span class="section-number-3">4.4</span> CPU related Optimization</h3>
<div class="outline-text-3" id="text-4-4">
</div>
<div id="outline-container-org7f3fc75" class="outline-4">
<h4 id="org7f3fc75"><span class="section-number-4">4.4.1</span> Two Lower Bounds Characterize the Max Performance</h4>
<div class="outline-text-4" id="text-4-4-1">
<ul class="org-ul">
<li>latency bound: is encountered when a series of operations</li>
</ul>
<p>
must be performed in strict sequence, because the result of one operation is
required before the next one can begin.
</p>

<ul class="org-ul">
<li>throughput bound: characterizes the raw computing capacity of the processor’s functional units.</li>
</ul>
</div>
</div>
<div id="outline-container-org659741b" class="outline-4">
<h4 id="org659741b"><span class="section-number-4">4.4.2</span> modern CPU</h4>
<div class="outline-text-4" id="text-4-4-2">

<div id="org8af7ac3" class="figure">
<p><img src="../resources/os/CpuBlockDiagram.png" alt="CpuBlockDiagram.png" />
</p>
</div>
</div>
<div id="outline-container-orgcef705e" class="outline-5">
<h5 id="orgcef705e"><span class="section-number-5">4.4.2.1</span> Branch Prediction &amp; Speculative Execution</h5>
<div class="outline-text-5" id="text-4-4-2-1">
<p>
Misprediction incurs a significant cost in performance
</p>
</div>
</div>
<div id="outline-container-org48fafe2" class="outline-5">
<h5 id="org48fafe2"><span class="section-number-5">4.4.2.2</span> Instruction Decoding</h5>
<div class="outline-text-5" id="text-4-4-2-2">
<p>
<b>Instruction decoding</b> logic takes the actual program instructions and converts
them into a set of primitive operations
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #6c3163; font-weight: bold;">addq</span> <span style="color: #3a81c3; font-weight: bold;">%rax</span>, 8<span style="color: #3a81c3;">(</span><span style="color: #715ab1;">%rdx</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<p>
yields multiple operations, separating the memory references from the arithmetic
operations.
</p>
</div>
</div>

<div id="outline-container-org31366b4" class="outline-5">
<h5 id="org31366b4"><span class="section-number-5">4.4.2.3</span> EU</h5>
<div class="outline-text-5" id="text-4-4-2-3">
<p>
The EU receives operations from the instruction fetch unit. Operations are dispatched to
a set of functional units that perform the actual operations.
</p>
</div>
</div>

<div id="outline-container-orgc81bc82" class="outline-5">
<h5 id="orgc81bc82"><span class="section-number-5">4.4.2.4</span> Retirement Unit</h5>
<div class="outline-text-5" id="text-4-4-2-4">
<p>
The retirement unit keeps track of the ongoing processing and
makes sure that it obeys the sequential semantics of the machine-level program.
</p>
<ul class="org-ul">
<li>once the operations for the instruction have completed and any branch points</li>
</ul>
<p>
leading to this instruction are confirmed as having been correctly predicted,
the instruction can be <b>retired</b>
</p>
<ul class="org-ul">
<li>If some branch point leading to this instruction was mispredicted, the instruction</li>
</ul>
<p>
will be <b>flushed</b>, discarding any results that may have been computed.
</p>
</div>
</div>

<div id="outline-container-org90c8b12" class="outline-5">
<h5 id="org90c8b12"><span class="section-number-5">4.4.2.5</span> Operation Results</h5>
<div class="outline-text-5" id="text-4-4-2-5">
<p>
the <b>execution units</b> can send results directly to each other.
</p>
<ul class="org-ul">
<li>The most common mechanism for controlling the communication of operands</li>
</ul>
<p>
among the execution units is called <b>register renaming</b>
</p>
</div>
</div>

<div id="outline-container-org95e623d" class="outline-5">
<h5 id="org95e623d"><span class="section-number-5">4.4.2.6</span> Functional Unit Performance</h5>
<div class="outline-text-5" id="text-4-4-2-6">
<ul class="org-ul">
<li>Latency: the total time required to perform the operation</li>
<li>Issue time: the minimum number of clock cycles between two successive operations of the same type</li>
</ul>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Operation</td>
<td class="org-right">Latency</td>
<td class="org-right">Issue</td>
</tr>

<tr>
<td class="org-left">Add(Int)</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">Mul(Int)</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">Div(Int)</td>
<td class="org-right">3~30</td>
<td class="org-right">3~30</td>
</tr>

<tr>
<td class="org-left">Add(Float)</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">Mul(Float)</td>
<td class="org-right">5</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">Div(Float)</td>
<td class="org-right">3~15</td>
<td class="org-right">3~15</td>
</tr>
</tbody>
</table>
<ul class="org-ul">
<li>Functional units with issue times of 1 cycle are said to be fully pipelined</li>
<li>Thoughput: \(\frac{number\ of\ function\ unit}{issue\ time}\) cycles per operation</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org1465695" class="outline-4">
<h4 id="org1465695"><span class="section-number-4">4.4.3</span> <b>Data Flow Analysis</b></h4>
<div class="outline-text-4" id="text-4-4-3">
<p>
Keypoint is finding <b>critical path</b>
</p>
</div>
</div>

<div id="outline-container-orgac6ad2a" class="outline-4">
<h4 id="orgac6ad2a"><span class="section-number-4">4.4.4</span> Loop Unrolling</h4>
<div class="outline-text-4" id="text-4-4-4">
<p>
Loop unrolling is a program transformation that reduces the number of iterations
for a loop by increasing the number of elements computed on each iteration.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #3a81c3;">(</span>i = 0; i &lt; n; i++<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  acc = acc * data<span style="color: #6c3163;">[</span>i<span style="color: #6c3163;">]</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">--&gt; 2 * 1 loop unrolling</span>
<span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #3a81c3;">(</span>i = 0; i &lt; n-1; i+=2<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">reassociation transformation: better than (acc * data[i]) * data[i+1]</span>
  acc = acc * <span style="color: #6c3163;">(</span>data<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span> * data<span style="color: #2d9574;">[</span>i+1<span style="color: #2d9574;">]</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
<span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #3a81c3;">(</span>; i &lt; n; i++<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">finish any remaining elements</span>
  acc = acc * data<span style="color: #6c3163;">[</span>i<span style="color: #6c3163;">]</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<ul class="org-ul">
<li>GCC -O3 will perform loop unrolling and reassociations of int operations.</li>
</ul>
</div>
</div>

<div id="outline-container-orgdb9f5b9" class="outline-4">
<h4 id="orgdb9f5b9"><span class="section-number-4">4.4.5</span> Parallelism</h4>
<div class="outline-text-4" id="text-4-4-5">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #3a81c3;">(</span>i = 0; i &lt; n-1; i+=2<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  acc0 = acc0 * data<span style="color: #6c3163;">[</span>i<span style="color: #6c3163;">]</span>;
  acc1 = acc1 * data<span style="color: #6c3163;">[</span>i+1<span style="color: #6c3163;">]</span>;
<span style="color: #3a81c3;">}</span>
<span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #3a81c3;">(</span>; i &lt; n ; ++<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  acc0 = acc0 * data<span style="color: #6c3163;">[</span>i<span style="color: #6c3163;">]</span>;
<span style="color: #3a81c3;">}</span>
result = acc0 * acc1
</pre>
</div>
<ul class="org-ul">
<li>parallelize <code>map</code> op in <code>mapreduce</code> mechanism</li>
</ul>
</div>
</div>
<div id="outline-container-orge79cd89" class="outline-4">
<h4 id="orge79cd89"><span class="section-number-4">4.4.6</span> Limiting Factors</h4>
<div class="outline-text-4" id="text-4-4-6">
</div>
<div id="outline-container-orgc6a59b4" class="outline-5">
<h5 id="orgc6a59b4"><span class="section-number-5">4.4.6.1</span> Register Spilling</h5>
</div>
<div id="outline-container-orgc167d0b" class="outline-5">
<h5 id="orgc167d0b"><span class="section-number-5">4.4.6.2</span> Branch Prediction and Misprediction Penalties</h5>
<div class="outline-text-5" id="text-4-4-6-2">
<p>
Branch prediction is only reliable for regular patterns.
</p>

<p>
Principles to avoid branch misprediction penalties
</p>
<ul class="org-ul">
<li>Do not be overly concerned about predictable branches</li>
<li><p>
Write code <b>suitable</b> for implementation with <b>conditional moves</b> (depends on compiler, write and check <b>asm</b>)
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #3a81c3;">(</span>i = 0; i &lt; N; ++i<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>a &lt; b<span style="color: #6c3163;">)</span>
    min = b; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">not predictable, cost of misprediction penalties is high</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #3a81c3;">(</span>i = 0; i &lt; N; ++i<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  min = a &lt; b ? a : b; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">CPE is steady</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgf5de919" class="outline-4">
<h4 id="orgf5de919"><span class="section-number-4">4.4.7</span> CPU caches</h4>
<div class="outline-text-4" id="text-4-4-7">
<p>
Modern processors have dedicated functional units to perform load and store operations,
and these units have internal buffers to hold sets of outstanding requests for
memory operations.
</p>
</div>
<div id="outline-container-orgf26b394" class="outline-5">
<h5 id="orgf26b394"><span class="section-number-5">4.4.7.1</span> Load Performance</h5>
<div class="outline-text-5" id="text-4-4-7-1">
<p>
Depends on the pipelining capability and the latency of the load unit.
</p>
</div>
</div>
<div id="outline-container-orgbad246e" class="outline-5">
<h5 id="orgbad246e"><span class="section-number-5">4.4.7.2</span> Store Performance</h5>
<div class="outline-text-5" id="text-4-4-7-2">
<p>
The store operation can operate in a fully pipelined mode, beginning a new store on every cycle.
Because the store operation does not affect any register values.
</p>

<ul class="org-ul">
<li>interaction with load operation</li>
</ul>

<p>
The load operation will check the entries in the store buffer for matching addresses.
If it finds a match, it retrieves the corresponding data entry as the result
of the load operation.
</p>

<p>
<b>When the load and store addresses match, these two operations can't be parallelized.</b>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb7fe54e" class="outline-3">
<h3 id="orgb7fe54e"><span class="section-number-3">4.5</span> Basic strategies for Optimization in the Real World</h3>
<div class="outline-text-3" id="text-4-5">
</div>
<div id="outline-container-org13d666f" class="outline-4">
<h4 id="org13d666f"><span class="section-number-4">4.5.1</span> High-level Design</h4>
<div class="outline-text-4" id="text-4-5-1">
<p>
Choose appropriate algorithms and data structures
</p>
</div>
</div>
<div id="outline-container-org396a978" class="outline-4">
<h4 id="org396a978"><span class="section-number-4">4.5.2</span> Basic Coding Principles</h4>
<div class="outline-text-4" id="text-4-5-2">
<p>
Avoid optimization blockers so that a compiler can generate efficient code.
</p>
<ul class="org-ul">
<li>Eliminate excessive function calls</li>
<li>Eliminate unnecessary memory references</li>
</ul>
</div>
</div>
<div id="outline-container-orge84476a" class="outline-4">
<h4 id="orge84476a"><span class="section-number-4">4.5.3</span> Low-level Optimizations</h4>
<div class="outline-text-4" id="text-4-5-3">
<ul class="org-ul">
<li>Unroll loops</li>
<li>Find ways to increase instruction-level parallelism by techniques such as</li>
</ul>
<p>
multiple accumulators and reassociation
</p>
<ul class="org-ul">
<li>Rewrite conditional operations in a functional style to enable compilation</li>
</ul>
<p>
via conditional data transfers
</p>
</div>
</div>
</div>
<div id="outline-container-org2be8020" class="outline-3">
<h3 id="org2be8020"><span class="section-number-3">4.6</span> Profiling</h3>
<div class="outline-text-3" id="text-4-6">
</div>
<div id="outline-container-org92af83e" class="outline-4">
<h4 id="org92af83e"><span class="section-number-4">4.6.1</span> Limitation of GPROF</h4>
<div class="outline-text-4" id="text-4-6-1">
<ul class="org-ul">
<li>For programs that run for less than around 1 second, the timing is not very precise</li>
<li>Not work for inline function</li>
<li>By default, the timings for library functions are not shown.</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org4fed4cb" class="outline-2">
<h2 id="org4fed4cb"><span class="section-number-2">5</span> Storage</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org2954e06" class="outline-3">
<h3 id="org2954e06"><span class="section-number-3">5.1</span> Storage Hierarchy</h3>
<div class="outline-text-3" id="text-5-1">

<div id="orgbc799da" class="figure">
<p><img src="../resources/os/MemoryHierarchy.png" alt="MemoryHierarchy.png" />
</p>
</div>
</div>
<div id="outline-container-orgf21d8b7" class="outline-4">
<h4 id="orgf21d8b7"><span class="section-number-4">5.1.1</span> Static RAM</h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
CPU cache
</p>
</div>
</div>
<div id="outline-container-orgb5c7955" class="outline-4">
<h4 id="orgb5c7955"><span class="section-number-4">5.1.2</span> Dynamic RAM</h4>
<div class="outline-text-4" id="text-5-1-2">
<p>
Main memory
</p>
</div>
</div>
<div id="outline-container-org5fccbf4" class="outline-4">
<h4 id="org5fccbf4"><span class="section-number-4">5.1.3</span> Conventional DRAMs</h4>
<div class="outline-text-4" id="text-5-1-3">
</div>
<div id="outline-container-org4ee94d4" class="outline-5">
<h5 id="org4ee94d4"><span class="section-number-5">5.1.3.1</span> memory controller</h5>
</div>
<div id="outline-container-org61894ca" class="outline-5">
<h5 id="org61894ca"><span class="section-number-5">5.1.3.2</span> memory modules</h5>
</div>
<div id="outline-container-org5969e59" class="outline-5">
<h5 id="org5969e59"><span class="section-number-5">5.1.3.3</span> DRAM supercell</h5>
<div class="outline-text-5" id="text-5-1-3-3">
<ul class="org-ul">
<li><i>d</i> supercells</li>
<li><i>w</i> DRAM cells in each supercell</li>
<li>A \(d\times w\) DRAM stores <i>dw</i> bits of information</li>
</ul>
</div>
</div>

<div id="outline-container-org730f46e" class="outline-5">
<h5 id="org730f46e"><span class="section-number-5">5.1.3.4</span> DRAM cells</h5>
<div class="outline-text-5" id="text-5-1-3-4">
<ul class="org-ul">
<li>RAS: Row Access Strobe</li>
<li>CAS: Column Access Strobe</li>
<li>Use internal row buffer to cache</li>
</ul>
</div>
</div>

<div id="outline-container-org39c2fb4" class="outline-5">
<h5 id="org39c2fb4"><span class="section-number-5">5.1.3.5</span> Data Flow</h5>
<div class="outline-text-5" id="text-5-1-3-5">
<p>
To retrieve a 64-bit doubleword at memory address A, the memory controller
converts A to a supercell address (i, j ) and sends it to the memory module, which
then broadcasts i and j to each DRAM. In response, each DRAM outputs the 8-
bit contents of its (i, j ) supercell. Circuitry in the module collects these outputs and
forms them into a 64-bit doubleword, which it returns to the memory controller.
</p>
</div>
</div>
</div>
<div id="outline-container-orgf781a5f" class="outline-4">
<h4 id="orgf781a5f"><span class="section-number-4">5.1.4</span> Enhanced DRAMs</h4>
<div class="outline-text-4" id="text-5-1-4">
</div>
<div id="outline-container-orgfe58b2d" class="outline-5">
<h5 id="orgfe58b2d"><span class="section-number-5">5.1.4.1</span> FPM DRAM</h5>
<div class="outline-text-5" id="text-5-1-4-1">
<p>
Fast page mode DRAM, allowing consecutive accesses to the same row to be served
directly from the row buffer
</p>
</div>
</div>
<div id="outline-container-org9d49d64" class="outline-5">
<h5 id="org9d49d64"><span class="section-number-5">5.1.4.2</span> EDO DRAM</h5>
<div class="outline-text-5" id="text-5-1-4-2">
<p>
Extended data out DRAM, allows the individual CAS signals to be spaced closer together in time.
</p>
</div>
</div>
<div id="outline-container-org29d33b7" class="outline-5">
<h5 id="org29d33b7"><span class="section-number-5">5.1.4.3</span> SDRAM</h5>
<div class="outline-text-5" id="text-5-1-4-3">
<p>
Synchronous DRAM, SDRAM can output the contents of its supercells at a faster rate than its asynchronous counterparts(FPM DRAM &amp; EDO DRAM).
</p>
</div>
</div>
<div id="outline-container-orgb11eb3d" class="outline-5">
<h5 id="orgb11eb3d"><span class="section-number-5">5.1.4.4</span> DDR SDRAM</h5>
<div class="outline-text-5" id="text-5-1-4-4">
<p>
An enhancement of SDRAM that doubles the speed of the DRAM by using both clock edges as control signals. Different types of DDR SDRAMs are
characterized by the size of a small prefetch buffer that increases the effective
bandwidth: DDR (2 bits), DDR2 (4 bits), and DDR3 (8 bits).
</p>
</div>
</div>
<div id="outline-container-orgc6dc9be" class="outline-5">
<h5 id="orgc6dc9be"><span class="section-number-5">5.1.4.5</span> VRAM</h5>
<div class="outline-text-5" id="text-5-1-4-5">
<p>
Used in the frame buffers of graphics systems. VRAM is similar in spirit to FPM DRAM.
Differences are: 1) VRAM output is produced by shifting the entire contents of the
internal buffer in sequence 2) VRAM allows concurrent reads and writes to the memory.
</p>
</div>
</div>
</div>
<div id="outline-container-orga29bdd1" class="outline-4">
<h4 id="orga29bdd1"><span class="section-number-4">5.1.5</span> Nonvolatile Memory</h4>
<div class="outline-text-4" id="text-5-1-5">
<ul class="org-ul">
<li>programmable ROM (PROM)</li>
<li>erasable programmable ROM (EPROM)</li>
<li>Flash memory</li>
</ul>

<ul class="org-ul">
<li>Programs stored in ROM devices are called <i>firmware</i>. e.g. BIOS</li>
</ul>
</div>
</div>

<div id="outline-container-org11f7561" class="outline-4">
<h4 id="org11f7561"><span class="section-number-4">5.1.6</span> Disk</h4>
<div class="outline-text-4" id="text-5-1-6">

<div id="orgee912a8" class="figure">
<p><img src="../resources/os/DiskStructure.png" alt="DiskStructure.png" />
</p>
</div>
<ul class="org-ul">
<li>terms: platter, surface, track, cylinder(vertical), sector(horizontal)</li>
<li>reading information from disk is a 100,000 times longer than from DRAM and 1,000,000 times longer than from SRAM</li>
</ul>
</div>
<div id="outline-container-org896c3f0" class="outline-5">
<h5 id="org896c3f0"><span class="section-number-5">5.1.6.1</span> Capacity</h5>
<div class="outline-text-5" id="text-5-1-6-1">
<ul class="org-ul">
<li>recording density: bits/inch</li>
<li>track density: tracks/inch</li>
<li>areal density: \(recording\times track\)</li>
</ul>

<p>
\[Capacity=\frac{\#\ bytes}{sector}\times\frac{average\ \#\ sectors}{track}\times\frac{\#\ track}{surface}\times\frac{\#\ surfaces}{platter}\times\frac{\#\ platters}{disk}\]
</p>
</div>
</div>

<div id="outline-container-org4fc7a01" class="outline-5">
<h5 id="org4fc7a01"><span class="section-number-5">5.1.6.2</span> Access time</h5>
<div class="outline-text-5" id="text-5-1-6-2">
<p>
The access time for a sector has three main components
</p>
<ul class="org-ul">
<li>seek time avg 3~9ms (seek track)</li>
<li>rotational latency (seek sector)</li>
</ul>
<p>
\[T_{max}=\frac{1}{RPM}\ minutes\]
\[T_{avg}=\frac{T_{max}}{2}\ minutes\]
</p>
<ul class="org-ul">
<li>transfer time</li>
</ul>
<p>
\[T{avg}=\frac{1}{RPM}\times\frac{1}{avg\ \#\ sectors/track}\ minutes\]
</p>
</div>
</div>
<div id="outline-container-org6882d88" class="outline-5">
<h5 id="org6882d88"><span class="section-number-5">5.1.6.3</span> Logical Disk Blocks</h5>
<div class="outline-text-5" id="text-5-1-6-3">
<ul class="org-ul">
<li>number of blocks is equal to number of sectors, numbered 0, 1, &#x2026;, B-1</li>
<li>A firmware device in the disk, called the <i>disk controller</i>,</li>
</ul>
<p>
maintains the mapping between logical block numbers and actual (physical) disk sectors.
</p>
</div>
</div>

<div id="outline-container-org2cdadf4" class="outline-5">
<h5 id="org2cdadf4"><span class="section-number-5">5.1.6.4</span> Accessing Disks</h5>
<div class="outline-text-5" id="text-5-1-6-4">
<p>
Uses a technique called <b>memory-mapped I/O</b>. In a system with memory-mapped I/O,
a block of addresses in the address space is reserved for communicating with I/O devices.
Each of these addresses is known as an I/O port. Each device is mapped to one or more
<b>I/O ports</b> when it is attached to the bus.
</p>

<p>
e.g. Reading from disk. Suppose that the <i>disk controller</i> is mapped to port 0xa0
</p>
<ol class="org-ol">
<li>sends a command word that tells the disk to initiate a read</li>
<li>indicates the logical block number that should be read</li>
<li>indicates the main memory address where the contents of the disk sector should be stored.</li>
</ol>

<p>
<i>Disk controller</i> finishes the <b>direct memory access(DMA)</b> transfer, then notify CPU the I/O is done.
</p>
</div>
</div>

<div id="outline-container-orga68995e" class="outline-5">
<h5 id="orga68995e"><span class="section-number-5">5.1.6.5</span> SSD</h5>
<div class="outline-text-5" id="text-5-1-6-5">
<p>
Based on flash memory
</p>

<div id="org960775b" class="figure">
<p><img src="../resources/os/SSDStructure.png" alt="SSDStructure.png" />
</p>
</div>
<ul class="org-ul">
<li><i>flash translation layer</i>: plays the same role as a <i>disk controller</i> (translating blocks)</li>
<li>B blocks</li>
<li>Each block consists of P pages</li>
<li>Data is read and written in units of pages</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org00db2bc" class="outline-3">
<h3 id="org00db2bc"><span class="section-number-3">5.2</span> BUS</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>system bus</li>
<li>memory bus</li>
<li>I/O bus: independent of the CPU, PCIe(Peripheral Component Interconnect express)</li>
<li>I/O bus connects USB devices, graphics adapter, host bus adapter(SATA, SCSI), network adapter, etc.</li>
</ul>
</div>
</div>

<div id="outline-container-org8664f8c" class="outline-3">
<h3 id="org8664f8c"><span class="section-number-3">5.3</span> Locality</h3>
<div class="outline-text-3" id="text-5-3">
</div>
<div id="outline-container-orgb31a851" class="outline-4">
<h4 id="orgb31a851"><span class="section-number-4">5.3.1</span> Principle of Locality</h4>
<div class="outline-text-4" id="text-5-3-1">
<dl class="org-dl">
<dt>Good temporal locality</dt><dd></dd>
</dl>
<p>
A memory location that is referenced once is likely to be referenced again multiple times in the near future
</p>

<dl class="org-dl">
<dt>Good Spatial Locality</dt><dd></dd>
</dl>
<p>
If a memory location is referenced once, then the program is likely to reference a nearby memory location in the near future.
</p>
</div>
</div>

<div id="outline-container-org5390909" class="outline-4">
<h4 id="org5390909"><span class="section-number-4">5.3.2</span> Reference Patterns</h4>
<div class="outline-text-4" id="text-5-3-2">
<ul class="org-ul">
<li>sequential(stride-1) reference pattern enjoys good <i>spatial locality</i></li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">a[M][N]</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">sum</span> = 0;
<span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #3a81c3;">(</span>i = 0; i &lt; N; i++<span style="color: #3a81c3;">)</span>
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #3a81c3;">(</span>j = 0; j &lt; M; j++<span style="color: #3a81c3;">)</span>
    sum += a<span style="color: #3a81c3;">[</span>j<span style="color: #3a81c3;">][</span>i<span style="color: #3a81c3;">]</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">bad, stride-N</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc3438e9" class="outline-4">
<h4 id="orgc3438e9"><span class="section-number-4">5.3.3</span> Locality of Instruction Fetches</h4>
<div class="outline-text-4" id="text-5-3-3">
<p>
Loops have good temporal and spatial locality with respect to instruction fetches.
The smaller the loop body and the greater the number of loop iterations, the better the locality.
</p>
</div>
</div>

<div id="outline-container-org9164ecd" class="outline-4">
<h4 id="org9164ecd"><span class="section-number-4">5.3.4</span> Cache Hit</h4>
</div>
<div id="outline-container-org2b9f5da" class="outline-4">
<h4 id="org2b9f5da"><span class="section-number-4">5.3.5</span> Cache Miss</h4>
<div class="outline-text-4" id="text-5-3-5">
</div>
<div id="outline-container-orgfe549df" class="outline-5">
<h5 id="orgfe549df"><span class="section-number-5">5.3.5.1</span> Placement Policy</h5>
<div class="outline-text-5" id="text-5-3-5-1">
<p>
Randomly placed blocks are expensive to locate. Restricts a particular block at level k+1
to a small subset of the blocks at level k.
</p>
</div>
</div>

<div id="outline-container-orgda6cfa0" class="outline-5">
<h5 id="orgda6cfa0"><span class="section-number-5">5.3.5.2</span> Replacement Policy</h5>
<div class="outline-text-5" id="text-5-3-5-2">
<ul class="org-ul">
<li>random replacement policy</li>
<li>least-recently used(LRU)</li>
</ul>
</div>
</div>

<div id="outline-container-org60207f1" class="outline-5">
<h5 id="org60207f1"><span class="section-number-5">5.3.5.3</span> Kinds of Cache Misses</h5>
<div class="outline-text-5" id="text-5-3-5-3">
<ul class="org-ul">
<li>cold miss(compulsory miss): miss on cold cache(empty cache)</li>
<li>conflict miss: placement policy lead to conflict miss</li>
<li>capacity miss: when the size of the working set exceeds the size of the cache</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org0139673" class="outline-3">
<h3 id="org0139673"><span class="section-number-3">5.4</span> Cache Memories</h3>
<div class="outline-text-3" id="text-5-4">

<div id="orgcd1c4f9" class="figure">
<p><img src="../resources/os/CacheOrganization.png" alt="CacheOrganization.png" />
</p>
</div>

<div id="org60cfc21" class="figure">
<p><img src="../resources/os/MemoryAddress.png" alt="MemoryAddress.png" />
</p>
</div>
<ul class="org-ul">
<li>i-cache: A cache that holds instructions, often read-only</li>
<li>d-cache: A cache that holds program data</li>
</ul>

<div id="org79be0ef" class="figure">
<p><img src="../resources/os/ProcessorPackage.png" alt="ProcessorPackage.png" />
</p>
</div>
</div>
<div id="outline-container-org00cc3ea" class="outline-4">
<h4 id="org00cc3ea"><span class="section-number-4">5.4.1</span> Terms</h4>
<div class="outline-text-4" id="text-5-4-1">
<dl class="org-dl">
<dt>block</dt><dd></dd>
</dl>
<p>
a fixed-sized packet of information that moves back and forth between a cache and main memory
</p>
<dl class="org-dl">
<dt>line</dt><dd></dd>
</dl>
<p>
a container in a cache that stores a block, as well as other information such as the valid bit and the tag bits
</p>
<dl class="org-dl">
<dt>set</dt><dd></dd>
</dl>
<p>
a collection of one or more lines.
</p>
</div>
</div>

<div id="outline-container-orgac17d70" class="outline-4">
<h4 id="orgac17d70"><span class="section-number-4">5.4.2</span> Parameters</h4>
<div class="outline-text-4" id="text-5-4-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">\(S=2^s\)</td>
<td class="org-left">Number of sets</td>
</tr>

<tr>
<td class="org-left">\(E\)</td>
<td class="org-left">Number of lines per set</td>
</tr>

<tr>
<td class="org-left">\(B=2^b\)</td>
<td class="org-left">Block size(bytes)</td>
</tr>

<tr>
<td class="org-left">\(m=\log_2(M)\)</td>
<td class="org-left">Number of memory address bits</td>
</tr>

<tr>
<td class="org-left">\(M=2^m\)</td>
<td class="org-left">Maximum number of unique memory addresses</td>
</tr>

<tr>
<td class="org-left">\(s=\log_2(S)\)</td>
<td class="org-left">Number of <i>set index bits</i></td>
</tr>

<tr>
<td class="org-left">\(b=\log_2(B)\)</td>
<td class="org-left">Number of <i>block offset bits</i></td>
</tr>

<tr>
<td class="org-left">\(t=m-(s-b)\)</td>
<td class="org-left">Number of <i>tag bits</i></td>
</tr>

<tr>
<td class="org-left">\(C=B\times E \times S\)</td>
<td class="org-left">Cache size exclude valid and tag bits</td>
</tr>
</tbody>
</table>
<ul class="org-ul">
<li><i>valid bit</i>: indicates whether or not the line contains meaningful information</li>
<li><i>tag bits</i>: a subset of the bits from the current block’s memory address, uniquely</li>
</ul>
<p>
identify the block stored in the cache line.
</p>
<ul class="org-ul">
<li><i>set</i> is like hash table, <i>set index bits</i> as hash code, E indicates the number of buckets.</li>
</ul>
</div>
</div>

<div id="outline-container-orga4abd52" class="outline-4">
<h4 id="orga4abd52"><span class="section-number-4">5.4.3</span> Direct-Mapped Caches(\(E=1\))</h4>
<div class="outline-text-4" id="text-5-4-3">
<ol class="org-ol">
<li>Set Selection(set index bits)</li>
<li>Line Matching: if the valid bit is set and the tag in the cache line matches the tag in the address.
<ul class="org-ul">
<li>Cache Hit: Word Selection(block offset bits)</li>
<li>Cache Miss: retrieve from memory</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-orgceb3a9e" class="outline-4">
<h4 id="orgceb3a9e"><span class="section-number-4">5.4.4</span> Set Associative Caches( \(1 < E < C/B\) )</h4>
<div class="outline-text-4" id="text-5-4-4">
<ul class="org-ul">
<li>Line Matching Key: tag bits</li>
<li>Cache Miss: use replacement policy, e.g. LFU(least-frequently-used), LRU(least-recently-used)</li>
</ul>
</div>
</div>

<div id="outline-container-org6be9db9" class="outline-4">
<h4 id="org6be9db9"><span class="section-number-4">5.4.5</span> Fully Associative Caches(\(E=C/B, S=1\))</h4>
<div class="outline-text-4" id="text-5-4-5">
<ul class="org-ul">
<li><p>
no set index bits
</p>

<div id="org85d43c3" class="figure">
<p><img src="../resources/os/FullCacheAddress.png" alt="FullCacheAddress.png" />
</p>
</div></li>
<li>Line Matching: same as Set Associative Caches</li>
<li>only appropriate for small caches, e.g. translation lookaside buffers (TLB)s</li>
</ul>
</div>
</div>
<div id="outline-container-org660e5d0" class="outline-4">
<h4 id="org660e5d0"><span class="section-number-4">5.4.6</span> Write Issues</h4>
<div class="outline-text-4" id="text-5-4-6">
</div>
<div id="outline-container-org1188c3a" class="outline-5">
<h5 id="org1188c3a"><span class="section-number-5">5.4.6.1</span> Write Hit</h5>
<div class="outline-text-5" id="text-5-4-6-1">
<ul class="org-ul">
<li>write-through: immediately write w’s cache block to the next lower level</li>
<li><b>write-back</b>: updated block to the low level when it is evicted from the cache</li>
</ul>
<p>
by the replacement algorithm. Maintains an additional dirty(modify) bit for each cache line.
</p>
</div>
</div>
<div id="outline-container-org3349836" class="outline-5">
<h5 id="org3349836"><span class="section-number-5">5.4.6.2</span> Write Miss</h5>
<div class="outline-text-5" id="text-5-4-6-2">
<ul class="org-ul">
<li><b>write-allocate</b>: loads the corresponding block from the lower level into the cache</li>
</ul>
<p>
and then updates the cache block
</p>
<ul class="org-ul">
<li>not-write-allocate</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgbb083d2" class="outline-4">
<h4 id="orgbb083d2"><span class="section-number-4">5.4.7</span> <b>Performance Impact of Cache Parameters</b></h4>
<div class="outline-text-4" id="text-5-4-7">
</div>
<div id="outline-container-org838ea54" class="outline-5">
<h5 id="org838ea54"><span class="section-number-5">5.4.7.1</span> Indicators</h5>
<div class="outline-text-5" id="text-5-4-7-1">
<ul class="org-ul">
<li>Miss rate: \(\frac{\#\ misses}{\#\ references}\)</li>
<li>Hit rate: \(1-Miss\ rate\)</li>
<li>Hit time: the time to deliver a word in the cache to the CPU</li>
<li>Miss penaly: any additional time required because of a miss</li>
</ul>
</div>
</div>
<div id="outline-container-org0eca31d" class="outline-5">
<h5 id="org0eca31d"><span class="section-number-5">5.4.7.2</span> Impacts</h5>
<div class="outline-text-5" id="text-5-4-7-2">
<ul class="org-ul">
<li>Cache size</li>
<li>Block size: The larger blocks can help increase the hit rate by exploiting any spatial locality, but expensive</li>
<li>Associativity(E): The larger E decreases the vulnerability of the cache to thrashing due to conflict misses</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org0962b2b" class="outline-4">
<h4 id="org0962b2b"><span class="section-number-4">5.4.8</span> Writing Cache-friendly Code</h4>
<div class="outline-text-4" id="text-5-4-8">
<ol class="org-ol">
<li>Make the common case go fast</li>
<li>Minimize the number of cache misses in each inner loop(step=1 is the best)</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-org585f158" class="outline-2">
<h2 id="org585f158"><span class="section-number-2">6</span> Linking</h2>
<div class="outline-text-2" id="text-6">
<ol class="org-ol">
<li>preprocesser(cpp for C -&gt; xxx.i)</li>
<li>compiler(cc1 -&gt; xxx.s, generate symbol table)</li>
<li>assembler(as -&gt; xxx.o)</li>
<li>linker(ld -&gt; executable)</li>

<li>loader(executable -&gt; memory)</li>
</ol>
</div>

<div id="outline-container-org5cc83f9" class="outline-3">
<h3 id="org5cc83f9"><span class="section-number-3">6.1</span> Object Files</h3>
<div class="outline-text-3" id="text-6-1">
</div>
<div id="outline-container-org367b378" class="outline-4">
<h4 id="org367b378"><span class="section-number-4">6.1.1</span> Relocatable object file</h4>
<div class="outline-text-4" id="text-6-1-1">
<p>
Contains binary code and data in a form that can be combined
with other relocatable object files at compile time to create an
executable object file.
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">ELF header(16bytes)</td>
</tr>

<tr>
<td class="org-left">.text</td>
</tr>

<tr>
<td class="org-left">.rodata</td>
</tr>

<tr>
<td class="org-left">.data</td>
</tr>

<tr>
<td class="org-left">.bss</td>
</tr>

<tr>
<td class="org-left">.symtab</td>
</tr>

<tr>
<td class="org-left">.rel.text</td>
</tr>

<tr>
<td class="org-left">.rel.data</td>
</tr>

<tr>
<td class="org-left">.debug</td>
</tr>

<tr>
<td class="org-left">.line</td>
</tr>

<tr>
<td class="org-left">.strtab</td>
</tr>

<tr>
<td class="org-left">Section header table</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-org2f088bb" class="outline-5">
<h5 id="org2f088bb"><span class="section-number-5">6.1.1.1</span> ELF header</h5>
<div class="outline-text-5" id="text-6-1-1-1">
<p>
Describes the word size and byte ordering of the system that generated the file
</p>
</div>
</div>

<div id="outline-container-org8c38987" class="outline-5">
<h5 id="org8c38987"><span class="section-number-5">6.1.1.2</span> .text</h5>
<div class="outline-text-5" id="text-6-1-1-2">
<p>
The machine code of the compiled program.
</p>
</div>
</div>

<div id="outline-container-org6690b93" class="outline-5">
<h5 id="org6690b93"><span class="section-number-5">6.1.1.3</span> .rodata</h5>
<div class="outline-text-5" id="text-6-1-1-3">
<p>
Read-only data such as the format strings in printf statements, and jump tables for switch statements
</p>
</div>
</div>

<div id="outline-container-org7db8385" class="outline-5">
<h5 id="org7db8385"><span class="section-number-5">6.1.1.4</span> .data</h5>
<div class="outline-text-5" id="text-6-1-1-4">
<p>
Initialized global C variables.
</p>
</div>
</div>

<div id="outline-container-org7a2491d" class="outline-5">
<h5 id="org7a2491d"><span class="section-number-5">6.1.1.5</span> .bss</h5>
<div class="outline-text-5" id="text-6-1-1-5">
<p>
Uninitialized global C variables.
</p>
</div>
</div>

<div id="outline-container-org9f8a566" class="outline-5">
<h5 id="org9f8a566"><span class="section-number-5">6.1.1.6</span> .symtab</h5>
<div class="outline-text-5" id="text-6-1-1-6">
<p>
A symbol table with information about functions and global variables
that are defined and referenced in the program.
</p>
</div>
</div>

<div id="outline-container-orga15e4eb" class="outline-5">
<h5 id="orga15e4eb"><span class="section-number-5">6.1.1.7</span> .rel.text(.rela.text)</h5>
<div class="outline-text-5" id="text-6-1-1-7">
<p>
A list of locations in the .text section that will need to be modified
when the linker combines this object file with others.
</p>
</div>
</div>

<div id="outline-container-orgbe136a3" class="outline-5">
<h5 id="orgbe136a3"><span class="section-number-5">6.1.1.8</span> .rel.data(.rela.data)</h5>
<div class="outline-text-5" id="text-6-1-1-8">
<p>
Relocation information for any global variables that are referenced or defined by the module.
</p>
</div>
</div>

<div id="outline-container-org7ac55ff" class="outline-5">
<h5 id="org7ac55ff"><span class="section-number-5">6.1.1.9</span> .debug</h5>
<div class="outline-text-5" id="text-6-1-1-9">
<p>
A debugging symbol table with entries for <b>local variables</b> and <b>typedefs</b>
defined in the program.
</p>
</div>
</div>

<div id="outline-container-orgece1955" class="outline-5">
<h5 id="orgece1955"><span class="section-number-5">6.1.1.10</span> .line</h5>
<div class="outline-text-5" id="text-6-1-1-10">
<p>
A mapping between line numbers in the original C source program
and machine code instructions in the .text section.(<code>-g</code> only)
</p>
</div>
</div>

<div id="outline-container-orgf66a0fe" class="outline-5">
<h5 id="orgf66a0fe"><span class="section-number-5">6.1.1.11</span> .strtab</h5>
<div class="outline-text-5" id="text-6-1-1-11">
<p>
A string table for the symbol tables in the .symtab and .debug
sections, and for the section names in the section headers.
</p>
</div>
</div>
</div>

<div id="outline-container-org9b06703" class="outline-4">
<h4 id="org9b06703"><span class="section-number-4">6.1.2</span> Excutable object file</h4>
<div class="outline-text-4" id="text-6-1-2">
<p>
Contains binary code and data in a form that can be copied
directly into memory and executed.
</p>
<ul class="org-ul">
<li>readonly(code segment)</li>
</ul>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">ELF header</td>
</tr>

<tr>
<td class="org-left">Segment header table</td>
</tr>

<tr>
<td class="org-left">.init</td>
</tr>

<tr>
<td class="org-left">.text</td>
</tr>

<tr>
<td class="org-left">.rodata</td>
</tr>
</tbody>
</table>
<ul class="org-ul">
<li>read/write(data segment)</li>
</ul>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">.data</td>
</tr>

<tr>
<td class="org-left">.bss</td>
</tr>
</tbody>
</table>
<ul class="org-ul">
<li>Symbol table and debug info are not loaded into memory</li>
</ul>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">.symtab</td>
</tr>

<tr>
<td class="org-left">.debug</td>
</tr>

<tr>
<td class="org-left">.line</td>
</tr>

<tr>
<td class="org-left">.strtab</td>
</tr>

<tr>
<td class="org-left">Section header table</td>
</tr>
</tbody>
</table>
</div>
<div id="outline-container-org421aef9" class="outline-5">
<h5 id="org421aef9"><span class="section-number-5">6.1.2.1</span> ELF header</h5>
<div class="outline-text-5" id="text-6-1-2-1">
<p>
The <b>ELF header</b> describes the overall format of the file.
It also includes the program’s <i>entry point</i>
</p>
</div>
</div>

<div id="outline-container-org7bda139" class="outline-5">
<h5 id="org7bda139"><span class="section-number-5">6.1.2.2</span> .init</h5>
<div class="outline-text-5" id="text-6-1-2-2">
<p>
<b>.init</b> section defines a small function, called <code>_init</code>,
that will be called by the program’s initialization code.
</p>
</div>
</div>

<div id="outline-container-orgeac4fc8" class="outline-5">
<h5 id="orgeac4fc8"><span class="section-number-5">6.1.2.3</span> Segment header table</h5>
<div class="outline-text-5" id="text-6-1-2-3">
<p>
Map contiguous chunks of the executable file to contiguous memory segments.
See <b>Program Header</b> displayed by <b>objdump</b>
</p>
<ul class="org-ul">
<li>off: file offset</li>
<li>vaddr\/paddr: vitual\/physical address</li>
<li>align: segment alignment</li>
<li>filesz: segment size in the object file</li>
<li>memsz: segment size in memory</li>
<li>flags: run-time permissions</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orga51cfec" class="outline-4">
<h4 id="orga51cfec"><span class="section-number-4">6.1.3</span> Shared object file</h4>
<div class="outline-text-4" id="text-6-1-3">
<p>
A special type of relocatable object file that can be loaded
into memory and linked dynamically, at either load time or run time.
</p>
</div>
</div>
</div>
<div id="outline-container-orgebf961c" class="outline-3">
<h3 id="orgebf961c"><span class="section-number-3">6.2</span> Symbols</h3>
<div class="outline-text-3" id="text-6-2">
</div>
<div id="outline-container-org2ac8026" class="outline-4">
<h4 id="org2ac8026"><span class="section-number-4">6.2.1</span> Symbol types</h4>
<div class="outline-text-4" id="text-6-2-1">
</div>
<div id="outline-container-org7368f55" class="outline-5">
<h5 id="org7368f55"><span class="section-number-5">6.2.1.1</span> Global symbols that are defined by current module</h5>
</div>
<div id="outline-container-org0848df4" class="outline-5">
<h5 id="org0848df4"><span class="section-number-5">6.2.1.2</span> Global symbols that are referenced by current module, aslo called <i>externals</i></h5>
</div>
<div id="outline-container-org0c7c60d" class="outline-5">
<h5 id="org0c7c60d"><span class="section-number-5">6.2.1.3</span> Local symbols that are defined and referenced exclusively by current module</h5>
<div class="outline-text-5" id="text-6-2-1-3">
<p>
Some local linker symbols correspond to C functions and global variables that are
defined with the static attribute. These symbols are visible anywhere within
module m, but cannot be referenced by other modules.
</p>
</div>
</div>
</div>

<div id="outline-container-org45fc059" class="outline-4">
<h4 id="org45fc059"><span class="section-number-4">6.2.2</span> overloaded function in C++</h4>
<div class="outline-text-4" id="text-6-2-2">
<p>
The compiler encodes each unique method and parameter list combination into a unique name for the linker.
This encoding process is called <b>mangling</b>, and the inverse process <b>demangling</b>.
</p>
</div>
</div>

<div id="outline-container-org9bba220" class="outline-4">
<h4 id="org9bba220"><span class="section-number-4">6.2.3</span> strong/weak symbols</h4>
<div class="outline-text-4" id="text-6-2-3">
<ul class="org-ul">
<li>Functions and initialized global variables get strong symbols.</li>
<li>Uninitialized global variables get weak symbols.</li>
<li>Rules:
<ol class="org-ol">
<li>Multiple strong symbols are not allowed.</li>
<li>Given a strong symbol and multiple weak symbols, choose the strong symbol.</li>
<li>Given multiple weak symbols, choose <b>any</b> of the weak symbols.</li>
</ol></li>
<li><code>-fno-common</code>: triggers an error if it encounters multiply defined global symbols.</li>
<li><code>-Werror</code>: make all warnings into errors</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org4f7f68d" class="outline-3">
<h3 id="org4f7f68d"><span class="section-number-3">6.3</span> Static Libraries</h3>
<div class="outline-text-3" id="text-6-3">
</div>
<div id="outline-container-org1837f43" class="outline-4">
<h4 id="org1837f43"><span class="section-number-4">6.3.1</span> Symbol Resolution</h4>
<div class="outline-text-4" id="text-6-3-1">
<p>
The linker maintains a set <i>E</i> of relocatable object files that will be merged to form the
executable, a set <i>U</i> of unresolved symbols (i.e., symbols referred to, but not yet
defined), and a set <i>D</i> of symbols that have been defined in previous input files.
</p>
<ul class="org-ul">
<li>place libraries at the end of the command line</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orga1a7b50" class="outline-3">
<h3 id="orga1a7b50"><span class="section-number-3">6.4</span> Shared Libraries</h3>
<div class="outline-text-3" id="text-6-4">
<ul class="org-ul">
<li><b>dynamic linker</b> program: <i>ld-linux.so</i></li>
<li><b>dynamic linking</b>: load shared libraries at an arbitrary memory address and linked with a program in memory <b>at run-time</b>.</li>
</ul>

<p>
A single copy of the .text section of a shared library in memory can
be shared by different running processes.
</p>

<div id="orge697030" class="figure">
<p><img src="../resources/os/DynamicLinking.png" alt="DynamicLinking.png" />
</p>
</div>
</div>

<div id="outline-container-orgc42ea5c" class="outline-4">
<h4 id="orgc42ea5c"><span class="section-number-4">6.4.1</span> Compilation</h4>
<div class="outline-text-4" id="text-6-4-1">
<div class="org-src-container">
<pre class="src src-sh">gcc -shared -fpic -o libxxx.so xxx.c
</pre>
</div>
</div>
</div>

<div id="outline-container-orgde751f3" class="outline-4">
<h4 id="orgde751f3"><span class="section-number-4">6.4.2</span> Linking process</h4>
<div class="outline-text-4" id="text-6-4-2">
<ol class="org-ol">
<li>Relocating the text and data of <i>libc.so</i> into some memory segment.</li>
<li>Relocating the text and data of <i>libxxx.so</i> into another memory segment.</li>
<li>Relocating any references in <b>executable</b> to symbols defined by <i>libc.so</i> and <i>libxxx.so</i></li>
<li>call main</li>
</ol>
</div>
</div>

<div id="outline-container-org7cd61dd" class="outline-4">
<h4 id="org7cd61dd"><span class="section-number-4">6.4.3</span> Linking at run-time</h4>
<div class="outline-text-4" id="text-6-4-3">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">dlfcn.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #6c3163; font-weight: bold;">dlopen</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">filename</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">flag</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">//</span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: ptr to handle if OK</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #6c3163; font-weight: bold;">dlsym</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">handle</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">symbol</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">//</span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: ptr to symbol if OK</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">dlclose</span> <span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">handle</span><span style="color: #3a81c3;">)</span>;<span style="color: #2aa1ae; background-color: #ecf3ec;">//</span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 0 if OK</span>
<span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #6c3163; font-weight: bold;">dlerror</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;<span style="color: #2aa1ae; background-color: #ecf3ec;">//</span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: error msg if previous call to dlopen, dlsym, or dlclose failed</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">gcc -rdynamic -o prog xxx.c -ldl
</pre>
</div>
<ul class="org-ul">
<li>compile with <code>-rdynamic</code> option to add all symbols to the dynamic symbol table</li>
</ul>
</div>
</div>

<div id="outline-container-org9b6ec3b" class="outline-4">
<h4 id="org9b6ec3b"><span class="section-number-4">6.4.4</span> library interpositioning</h4>
<div class="outline-text-4" id="text-6-4-4">
<p>
wrap the function in shared library
</p>
</div>
<div id="outline-container-orgea93d0c" class="outline-5">
<h5 id="orgea93d0c"><span class="section-number-5">6.4.4.1</span> compilation time</h5>
<div class="outline-text-5" id="text-6-4-4-1">
<p>
Compile with <code>-I.</code> to search current directory first
</p>
</div>
</div>

<div id="outline-container-orge4129b4" class="outline-5">
<h5 id="orge4129b4"><span class="section-number-5">6.4.4.2</span> link time</h5>
<div class="outline-text-5" id="text-6-4-4-2">
<div class="org-src-container">
<pre class="src src-sh">gcc -W1,--wrap,func1 -o prog xxx.o xxx.o
</pre>
</div>
<p>
<code>-W1,--wrap,func1</code>: gcc transform <code>--wrap malloc</code> to linker
</p>
</div>
</div>

<div id="outline-container-org23d205e" class="outline-5">
<h5 id="org23d205e"><span class="section-number-5">6.4.4.3</span> run-time</h5>
<div class="outline-text-5" id="text-6-4-4-3">
<p>
Uses <code>LD_PRELOAD</code> environment variable
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #715ab1;">LD_PRELOAD</span>=<span style="color: #2d9574;">"./wrapper.so"</span> ./prog
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-org1d46154" class="outline-3">
<h3 id="org1d46154"><span class="section-number-3">6.5</span> Relocation</h3>
<div class="outline-text-3" id="text-6-5">
<ol class="org-ol">
<li>Relocating sections and symbol definitions.</li>
<li>Relocating symbol references within sections.</li>
</ol>
</div>
<div id="outline-container-orgd42c434" class="outline-4">
<h4 id="orgd42c434"><span class="section-number-4">6.5.1</span> Relocation Entries</h4>
<div class="outline-text-4" id="text-6-5-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #3a81c3; font-weight: bold;">typedef</span> <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">offset</span>;     <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Offset of the reference to relocate</span>
  <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">type</span> : 32,  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Relocation type</span>
       <span style="color: #715ab1;">symbol</span> : 32;<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Symbol table index</span>
  <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">addend</span>;     <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Constant part of relocation expression</span>
<span style="color: #3a81c3;">}</span> <span style="color: #ba2f59; font-weight: bold;">Elf64_Rela</span>;
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">objdump -r xxx.o <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">to lookup the relocation entries</span>
readelf -r xxx.o
</pre>
</div>
</div>
<div id="outline-container-org84a339c" class="outline-5">
<h5 id="org84a339c"><span class="section-number-5">6.5.1.1</span> type</h5>
<div class="outline-text-5" id="text-6-5-1-1">
<ul class="org-ul">
<li>R_X86_64_PC32: Relocate a reference that uses a 32-bit PC-relative address</li>
<li>R_X86_64_32: Relocate a reference that uses a 32-bit absolute address</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org2c28d07" class="outline-4">
<h4 id="org2c28d07"><span class="section-number-4">6.5.2</span> Relocation Algorithm(Linker)</h4>
<div class="outline-text-4" id="text-6-5-2">
<div class="org-src-container">
<pre class="src src-c">foreach <span style="color: #ba2f59; font-weight: bold;">section</span> <span style="color: #715ab1;">s</span> <span style="color: #3a81c3;">{</span>
  foreach relocation <span style="color: #ba2f59; font-weight: bold;">entry</span> <span style="color: #715ab1;">r</span> <span style="color: #6c3163;">{</span>
    refptr = s + r.offset; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">ptr to reference to be relocated (need to fill in)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">PC-relative relocation</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>r.type == R_X86_64_PC32<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      refaddr = ADDR<span style="color: #67b11d;">(</span>s<span style="color: #67b11d;">)</span> + r.offset; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">ref's run-time address</span>
      *refptr = <span style="color: #67b11d;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>ADDR<span style="color: #b1951d;">(</span>r.symbol<span style="color: #b1951d;">)</span> - refaddr + r.addend<span style="color: #67b11d;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">runtime symbol addr - current PC-&gt;addr</span>
    <span style="color: #2d9574;">}</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">absolute addr relocation</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>r.type == R_X86_64_32<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      *refptr = <span style="color: #67b11d;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>ADDR<span style="color: #b1951d;">(</span>r.symbol<span style="color: #b1951d;">)</span> + r.addend<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<ul class="org-ul">
<li>r.addend: constant number should be added to find the correct address</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-orgb1198aa" class="outline-3">
<h3 id="orgb1198aa"><span class="section-number-3">6.6</span> Loading Executable Object Files</h3>
<div class="outline-text-3" id="text-6-6">
<ul class="org-ul">
<li><b>loader</b>: copies the code and data in the executable object file from</li>
</ul>
<p>
disk into memory, and then runs the program by jumping to its first instruction, or
<i>entry point</i>.
</p>
</div>
<div id="outline-container-orgf8849ef" class="outline-4">
<h4 id="orgf8849ef"><span class="section-number-4">6.6.1</span> run-time memory structure</h4>
<div class="outline-text-4" id="text-6-6-1">

<div id="org62b988a" class="figure">
<p><img src="../resources/os/RuntimeMemory.png" alt="RuntimeMemory.png" />
</p>
</div>
<ul class="org-ul">
<li>not considering ASLR(address-space layout randomization)</li>
</ul>
</div>
</div>

<div id="outline-container-org11a5206" class="outline-4">
<h4 id="org11a5206"><span class="section-number-4">6.6.2</span> loading process</h4>
<div class="outline-text-4" id="text-6-6-2">
<ol class="org-ol">
<li>creates the memory image</li>
<li>copies chunks of the executable into the code and data segments</li>
<li>jumps to the program's entry point, which is always the address of the <code>_start</code> symbol(defined in crt1.o)</li>
<li>call <code>__libc_start_main</code> (defined in libc.so)</li>
<li>call main</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgafedb7c" class="outline-3">
<h3 id="orgafedb7c"><span class="section-number-3">6.7</span> Position-Independent Code (PIC)</h3>
<div class="outline-text-3" id="text-6-7">
<p>
The code can be loaded and executed at any address without being
<b>modified</b> by the linker.
</p>
<ul class="org-ul">
<li>Shared libraries must be compiled with <code>-fpic</code></li>
</ul>
</div>

<div id="outline-container-org4d6d9c0" class="outline-4">
<h4 id="org4d6d9c0"><span class="section-number-4">6.7.1</span> global offset table(GOT)</h4>
<div class="outline-text-4" id="text-6-7-1">
<p>
GOT is created by compiler at the beginning of the data segment(in <i>.so</i> file).
At load time, the dynamic linker relocates each entry in the GOT so that it
contains the appropriate absolute address.
</p>
</div>
</div>


<div id="outline-container-org91f47d6" class="outline-4">
<h4 id="org91f47d6"><span class="section-number-4">6.7.2</span> PIC Data References</h4>
<div class="outline-text-4" id="text-6-7-2">
<p>
The data segment is always allocated immediately after the code segment.
Thus, the distance between any instruction in the code segment and
any variable in the data segment is a run-time constant.
</p>
</div>
</div>

<div id="outline-container-orge2f9712" class="outline-4">
<h4 id="orge2f9712"><span class="section-number-4">6.7.3</span> PIC Function Calls</h4>
<div class="outline-text-4" id="text-6-7-3">
</div>
<div id="outline-container-orgcc50918" class="outline-5">
<h5 id="orgcc50918"><span class="section-number-5">6.7.3.1</span> lazy binding</h5>
<div class="outline-text-5" id="text-6-7-3-1">
<p>
Defers the binding of procedure addresses until the first time the procedure is called.
</p>
</div>
</div>

<div id="outline-container-orgf664e0f" class="outline-5">
<h5 id="orgf664e0f"><span class="section-number-5">6.7.3.2</span> procedure linkage table(PLT)</h5>
<div class="outline-text-5" id="text-6-7-3-2">
<p>
If an object module calls any functions that are defined in shared libraries, then it
has its own GOT and PLT. The PLT is part of the .text section
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org5588f3f" class="outline-3">
<h3 id="org5588f3f"><span class="section-number-3">6.8</span> Tools</h3>
<div class="outline-text-3" id="text-6-8">
<ul class="org-ul">
<li>ar: Creates static libraries, and inserts, deletes, lists, and extracts members.</li>
<li>strings: Lists all of the printable strings contained in an object file.</li>
<li>strip: Deletes symbol table information from an object file.</li>
<li>nm: Lists the symbols defined in the symbol table of an object file.</li>
<li>size: Lists the names and sizes of the sections in an object file.</li>
<li>readelf: Displays the complete structure of an object file, including all of the</li>
</ul>
<p>
information encoded in the ELF header; subsumes the functionality of size and nm.
</p>
<ul class="org-ul">
<li>objdump: The mother of all binary tools. Can display all of the information in an</li>
</ul>
<p>
object file. Its most useful function is disassembling the binary instructions
in the .text section. <code>objdump -dx</code>
</p>
<ul class="org-ul">
<li>ldd: Lists the shared libraries that an executable needs at run time.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgea97887" class="outline-2">
<h2 id="orgea97887"><span class="section-number-2">7</span> ECF(Exceptional Control Flow)</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-orgb7f55fa" class="outline-3">
<h3 id="orgb7f55fa"><span class="section-number-3">7.1</span> Classes of Exceptions</h3>
<div class="outline-text-3" id="text-7-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Class</th>
<th scope="col" class="org-left">Cause</th>
<th scope="col" class="org-left">Async/Sync</th>
<th scope="col" class="org-left">Return behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Interrupt</td>
<td class="org-left">Signal from IO device</td>
<td class="org-left">Async</td>
<td class="org-left">Always returns to next instruction</td>
</tr>

<tr>
<td class="org-left">Trap</td>
<td class="org-left">Intentional exception</td>
<td class="org-left">Sync</td>
<td class="org-left">Always returns to next instruction</td>
</tr>

<tr>
<td class="org-left">Fault</td>
<td class="org-left">Potentially recoverable error</td>
<td class="org-left">Sync</td>
<td class="org-left">Might return to current instruction</td>
</tr>

<tr>
<td class="org-left">Abort</td>
<td class="org-left">Nonrecoverable error</td>
<td class="org-left">Sync</td>
<td class="org-left">Never returns</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgf3165bc" class="outline-3">
<h3 id="orgf3165bc"><span class="section-number-3">7.2</span> Process</h3>
<div class="outline-text-3" id="text-7-2">
<p>
Provides:
</p>
<ul class="org-ul">
<li>An independent logical control flow that provides the illusion that our</li>
</ul>
<p>
program has exclusive use of the processor.
</p>
<ul class="org-ul">
<li>A private address space that provides the illusion that our program has</li>
</ul>
<p>
exclusive use of the memory system.
</p>
</div>

<div id="outline-container-org887f2d9" class="outline-4">
<h4 id="org887f2d9"><span class="section-number-4">7.2.1</span> Terminology</h4>
<div class="outline-text-4" id="text-7-2-1">
<ul class="org-ul">
<li>concurrent flow: A logical flow whose execution overlaps in time with another flow</li>
<li>time slice: Each time period that a process executes a portion of its flow</li>
<li>parallel flow: Two flows are running concurrently on different processor cores or computers</li>
<li>scheduling: The kernel can decide to preempt the current process and restart a previously preempted process</li>
<li>zombie process:A terminated process that has not yet been reaped, and it still consume system memory resources.</li>
</ul>
</div>
</div>

<div id="outline-container-org3771574" class="outline-4">
<h4 id="org3771574"><span class="section-number-4">7.2.2</span> Process Control</h4>
<div class="outline-text-4" id="text-7-2-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #6c3163; font-weight: bold;">getpid</span><span style="color: #3a81c3;">()</span>;  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">get current process id</span>
<span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #6c3163; font-weight: bold;">getppid</span><span style="color: #3a81c3;">()</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">get parent process id</span>
<span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #6c3163; font-weight: bold;">fork</span><span style="color: #3a81c3;">()</span>;    <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">create subprocess</span>
<span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sleep</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">secs</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">pause</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">puts the calling function to sleep until a signal is</span>
		 <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">received by the process.</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">execve</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">filename</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">envp</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>;

<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">exit</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">status</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #6c3163; font-weight: bold;">getenv</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">setenv</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">newvalue</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">overwrite</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">unsetenv</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span><span style="color: #3a81c3;">)</span>;

<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #6c3163; font-weight: bold;">waitpid</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">statusp</span>,
	      <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">options</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">waits for its children to terminate</span>
<span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #6c3163; font-weight: bold;">wait</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">statusp</span><span style="color: #3a81c3;">)</span>;   <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">same as waitpid(-1, &amp;status, 0)</span>
</pre>
</div>
</div>
<div id="outline-container-org293db21" class="outline-5">
<h5 id="org293db21"><span class="section-number-5">7.2.2.1</span> fork</h5>
<div class="outline-text-5" id="text-7-2-2-1">
<ul class="org-ul">
<li>child gets an identical (but separate) copy of the parent’s user-level virtual</li>
</ul>
<p>
address space, including the text, data, and bss segments, heap, user stack,
and identical copies of any of the parent’s open file descriptors.
</p>
<ul class="org-ul">
<li>Call once, return twice. Return child pid in parent process, return 0 in child process.</li>
</ul>
</div>
</div>

<div id="outline-container-org2917b5e" class="outline-5">
<h5 id="org2917b5e"><span class="section-number-5">7.2.2.2</span> waitpid</h5>
<div class="outline-text-5" id="text-7-2-2-2">
<p>
suspends execution of the calling process until a child
process in its wait set terminates.(default)
</p>

<p>
Arguments:
</p>
<ul class="org-ul">
<li>pid=-1: the wait set consists of all of the parent’s child processes.</li>
</ul>
</div>
<ul class="org-ul">
<li><a id="orgf3be9e5"></a>options<br />
<div class="outline-text-6" id="text-orgf3be9e5">
<p>
Combinations of the WNOHANG, WUNTRACED and WCONTINUED constants.
</p>
<ul class="org-ul">
<li>WNOHANG: Return immediately if none of the child processes in the wait set has terminated yet</li>
<li>WUNTRACED: Suspend execution of the calling process until a process in</li>
</ul>
<p>
the wait set becomes either terminated or stopped
</p>
<ul class="org-ul">
<li>WCONTINUED</li>
</ul>
</div>
</li>

<li><a id="org8ff6093"></a>statusp<br />
<div class="outline-text-6" id="text-org8ff6093">
<p>
If the status argument is non-NULL, then waitpid encodes status information
about the child that caused the return in the status argument.
</p>

<p>
Status Macro: WIFEXITED, WEXITSTATUS, WIFSIGNALED, WTERMSIG, WIFSTOPPED, WSTOPSIG, WIFCONTINUED
</p>
</div>
</li>

<li><a id="orgf331cdb"></a>Return Value<br />
<div class="outline-text-6" id="text-orgf331cdb">
<ul class="org-ul">
<li>If the calling process has no children, then waitpid returns −1 and sets errno to ECHILD.</li>
<li>If the waitpid function was interrupted by a signal, then it returns −1 and sets errno to EINTR.</li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-org1cc2fd4" class="outline-5">
<h5 id="org1cc2fd4"><span class="section-number-5">7.2.2.3</span> execve</h5>
<div class="outline-text-5" id="text-7-2-2-3">
<p>
The execve function loads and runs a new program in the context of the current process.
It overwrites the address space of the current process, it does not create a new process.
The new program still has the same PID, and it inherits all of the file descriptors that
were open at the time of the call to the execve function.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org21221e7" class="outline-3">
<h3 id="org21221e7"><span class="section-number-3">7.3</span> Signals</h3>
<div class="outline-text-3" id="text-7-3">
<div class="org-src-container">
<pre class="src src-sh">man 7 signal
</pre>
</div>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #6c3163; font-weight: bold;">getpgrp</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">returns the process group ID of the current process.</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">setpgid</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>,
	    <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pgid</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">changes the process group of process pid to pgid.</span>

<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">kill</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">sig</span><span style="color: #3a81c3;">)</span>;          <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">sends signal to process pid</span>
<span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">alarm</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">secs</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">arranges for the kernel to send a</span>
				       <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">SIGALRM signal to the calling process</span>
				       <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">in secs seconds</span>
</pre>
</div>
</div>
<div id="outline-container-orgbfb9e2f" class="outline-4">
<h4 id="orgbfb9e2f"><span class="section-number-4">7.3.1</span> Receiving Signals</h4>
<div class="outline-text-4" id="text-7-3-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #3a81c3; font-weight: bold;">typedef</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #3a81c3;">(</span>*<span style="color: #ba2f59; font-weight: bold;">sighandler_t</span><span style="color: #3a81c3;">)(</span><span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">sighandler_t</span> <span style="color: #6c3163; font-weight: bold;">signal</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signum</span>, <span style="color: #ba2f59; font-weight: bold;">sighandler_t</span> <span style="color: #715ab1;">handler</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org9c60bb8" class="outline-4">
<h4 id="org9c60bb8"><span class="section-number-4">7.3.2</span> Blocking Signals</h4>
<div class="outline-text-4" id="text-7-3-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigprocmask</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">how</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">set</span>, <span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">oldset</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigemptyset</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">set</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigfillset</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">set</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigaddset</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">set</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signum</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigdelset</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">set</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signum</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigismember</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">set</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signum</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
</div>
<div id="outline-container-orgbbc2b49" class="outline-5">
<h5 id="orgbbc2b49"><span class="section-number-5">7.3.2.1</span> sigsuspend</h5>
<div class="outline-text-5" id="text-7-3-2-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigsuspend</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">mask</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">is equivalent to(atomic)</span>
<span style="color: #6c3163; font-weight: bold;">sigprocmask</span><span style="color: #3a81c3;">(</span>SIG_SETMASK, &amp;mask, &amp;prev<span style="color: #3a81c3;">)</span>;
<span style="color: #6c3163; font-weight: bold;">pause</span><span style="color: #3a81c3;">()</span>;
<span style="color: #6c3163; font-weight: bold;">sigprocmask</span><span style="color: #3a81c3;">(</span>SIG_SETMASK, &amp;prev, <span style="color: #4e3163;">NULL</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf52d7ca" class="outline-4">
<h4 id="orgf52d7ca"><span class="section-number-4">7.3.3</span> Nonlocal Jumps</h4>
<div class="outline-text-4" id="text-7-3-3">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">setjmp</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">jmp_buf</span> <span style="color: #715ab1;">env</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigsetjmp</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigjmp_buf</span> <span style="color: #715ab1;">env</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">savesigs</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">longjmp</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">jmp_buf</span> <span style="color: #715ab1;">env</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">retval</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">longjmp</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigjmp_buf</span> <span style="color: #715ab1;">env</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">retval</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
</div>
<div id="outline-container-orgf2a7c16" class="outline-5">
<h5 id="orgf2a7c16"><span class="section-number-5">7.3.3.1</span> setjmp</h5>
<div class="outline-text-5" id="text-7-3-3-1">
<p>
The <code>setjmp</code> function saves the current calling environment in the env buffer,
for later use by longjmp, and returns a 0.
</p>
</div>
</div>

<div id="outline-container-org1aa5fb3" class="outline-5">
<h5 id="org1aa5fb3"><span class="section-number-5">7.3.3.2</span> longjmp</h5>
<div class="outline-text-5" id="text-7-3-3-2">
<p>
The <code>longjmp</code> function restores the calling environment from the env buffer
and then triggers a return from the most recent setjmp call that initialized env.
The <code>setjmp</code> then returns with the nonzero return value retval.
</p>
</div>
</div>

<div id="outline-container-org9372597" class="outline-5">
<h5 id="org9372597"><span class="section-number-5">7.3.3.3</span> extension: <b>try-catch</b></h5>
</div>
</div>
</div>
<div id="outline-container-org94869fd" class="outline-3">
<h3 id="org94869fd"><span class="section-number-3">7.4</span> Tools</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li>strace: Prints a trace of each system call invoked by a running program and its children.</li>
</ul>
<p>
Compile your program with -static to get a cleaner trace.
</p>
<ul class="org-ul">
<li>ps</li>
<li>top</li>
<li>pmap: Displays the memory map of a process.</li>
<li>/proc: A virtual filesystem that exports the contents of numerous kernel data structures.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgbb617e5" class="outline-2">
<h2 id="orgbb617e5"><span class="section-number-2">8</span> Unix I/O</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-org270e3f9" class="outline-3">
<h3 id="org270e3f9"><span class="section-number-3">8.1</span> File operations</h3>
<div class="outline-text-3" id="text-8-1">
</div>
<div id="outline-container-orge38772d" class="outline-4">
<h4 id="orge38772d"><span class="section-number-4">8.1.1</span> Basic</h4>
<div class="outline-text-4" id="text-8-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/types.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">open</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">filename</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">flags</span>, <span style="color: #ba2f59; font-weight: bold;">mode_t</span> <span style="color: #715ab1;">mode</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">returns file descriptor or -1</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">close</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">0 if OK, -1 on error</span>

<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">ssize_t</span> <span style="color: #6c3163; font-weight: bold;">read</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>, <span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">buf</span>, <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">n</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">returns number of bytes read if OK, 0 on EOF, &#8722;1 on error</span>
<span style="color: #ba2f59; font-weight: bold;">ssize_t</span> <span style="color: #6c3163; font-weight: bold;">write</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">buf</span>, <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">n</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">returns number of bytes written if OK, &#8722;1 on error</span>
<span style="color: #ba2f59; font-weight: bold;">off_t</span> <span style="color: #6c3163; font-weight: bold;">lseek</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>, <span style="color: #ba2f59; font-weight: bold;">off_t</span> <span style="color: #715ab1;">offset</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">whence</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org9a3fa65" class="outline-4">
<h4 id="org9a3fa65"><span class="section-number-4">8.1.2</span> Application-level Buffering</h4>
<div class="outline-text-4" id="text-8-1-2">
<p>
Efficiently read text lines  and binary data from a file whose
contents are cached in a slightly larger application-level buffer.
</p>
</div>
</div>

<div id="outline-container-orge5eabb4" class="outline-4">
<h4 id="orge5eabb4"><span class="section-number-4">8.1.3</span> Metadata</h4>
<div class="outline-text-4" id="text-8-1-3">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">stat</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">filename</span>, <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">stat</span> *<span style="color: #715ab1;">buf</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">fstat</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>, <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">stat</span> *<span style="color: #715ab1;">buf</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org9ac5923" class="outline-4">
<h4 id="org9ac5923"><span class="section-number-4">8.1.4</span> File Status</h4>
<div class="outline-text-4" id="text-8-1-4">
<p>
Data structures to describe file status
</p>
<ul class="org-ul">
<li>Descriptor table: Each process has its own separate descriptor table.</li>
<li>File table: The set of open files is represented by a file table that is shared by all processes.</li>
</ul>
<p>
Each file table entry consists of (for our purposes) the current file position, a reference
count of the number of descriptor entries that currently point to it, and a pointer to an
entry in the <i>v-node</i> table.
</p>
<ul class="org-ul">
<li><i>v-node</i> table: The <i>v-node</i> table is shared by all processes.</li>
</ul>
<p>
Each entry contains most of the information in the <i>stat</i> structure.
</p>
</div>
</div>
</div>

<div id="outline-container-org7ab6d0d" class="outline-3">
<h3 id="org7ab6d0d"><span class="section-number-3">8.2</span> Directory</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/types.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">dirent.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">DIR</span> *<span style="color: #6c3163; font-weight: bold;">opendir</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span><span style="color: #3a81c3;">)</span>;
<span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">dirent</span> *<span style="color: #6c3163; font-weight: bold;">readdir</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">DIR</span> *<span style="color: #715ab1;">dirp</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">closedir</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">DIR</span> *<span style="color: #715ab1;">dirp</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf28d030" class="outline-3">
<h3 id="orgf28d030"><span class="section-number-3">8.3</span> I/O Redirection</h3>
<div class="outline-text-3" id="text-8-3">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">dup2</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">oldfd</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">newfd</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
<p>
The <code>dup2</code> function copies descriptor table entry oldfd to descriptor table entry
newfd, overwriting the previous contents of descriptor table entry newfd.
</p>
</div>
</div>
</div>
<div id="outline-container-org9c7a6f0" class="outline-2">
<h2 id="org9c7a6f0"><span class="section-number-2">9</span> Socket</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-orga34c1a4" class="outline-3">
<h3 id="orga34c1a4"><span class="section-number-3">9.1</span> Network Byte Order</h3>
<div class="outline-text-3" id="text-9-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">arpa/inet.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">host -&gt; network</span>
<span style="color: #ba2f59; font-weight: bold;">uint32_t</span> <span style="color: #6c3163; font-weight: bold;">htonl</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">uint32_t</span> <span style="color: #715ab1;">hostlong</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">uint16_t</span> <span style="color: #6c3163; font-weight: bold;">htons</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">uint32_t</span> <span style="color: #715ab1;">hostshort</span><span style="color: #3a81c3;">)</span>;

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">network -&gt; host</span>
<span style="color: #ba2f59; font-weight: bold;">uint32_t</span> <span style="color: #6c3163; font-weight: bold;">ntohl</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">uint32_t</span> <span style="color: #715ab1;">netlong</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">uint32_t</span> <span style="color: #6c3163; font-weight: bold;">htonl</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">uint32_t</span> <span style="color: #715ab1;">netshort</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfe45bf9" class="outline-3">
<h3 id="orgfe45bf9"><span class="section-number-3">9.2</span> IP Address</h3>
<div class="outline-text-3" id="text-9-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">arpa/inet.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">in_addr</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">uint32_t</span> <span style="color: #715ab1;">s_addr</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">network byte order</span>
<span style="color: #3a81c3;">}</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">inet_pton</span><span style="color: #3a81c3;">(</span>AF_INET, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">src</span>, <span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">dst</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">//</span><span style="color: #2aa1ae; background-color: #ecf3ec;">"x.x.x.x" -&gt; &amp;in_addr</span>
<span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #6c3163; font-weight: bold;">inet_ntop</span><span style="color: #3a81c3;">(</span>AF_INET, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">src</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">dst</span>, <span style="color: #ba2f59; font-weight: bold;">socklen_t</span> <span style="color: #715ab1;">size</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">//</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&amp;in_addr -&gt; "x.x.x.x"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd1ef969" class="outline-3">
<h3 id="orgd1ef969"><span class="section-number-3">9.3</span> Connection</h3>
<div class="outline-text-3" id="text-9-3">
<p>
uniquely identified by <code>(cliaddr:cliport, servaddr:servport)</code>
</p>
</div>
</div>

<div id="outline-container-org0cbccac" class="outline-3">
<h3 id="org0cbccac"><span class="section-number-3">9.4</span> Socket Address</h3>
<div class="outline-text-3" id="text-9-4">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">IP socket address</span>
<span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr_in</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">uint16_t</span> <span style="color: #715ab1;">sin_family</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">protocol famliy (AF_INET)</span>
  <span style="color: #ba2f59; font-weight: bold;">uint16_t</span> <span style="color: #715ab1;">sin_port</span>;   <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">port number in network byte order</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">in_addr</span> <span style="color: #715ab1;">sin_addr</span>;
  <span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">sin_zero</span><span style="color: #6c3163;">[</span>8<span style="color: #6c3163;">]</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">pad to sizeof(struct sockaddr)</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Generic socket address</span>
<span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">uint16_t</span> <span style="color: #715ab1;">sa_family</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">sa_data</span><span style="color: #6c3163;">[</span>14<span style="color: #6c3163;">]</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge81a17f" class="outline-3">
<h3 id="orge81a17f"><span class="section-number-3">9.5</span> Interface</h3>
<div class="outline-text-3" id="text-9-5">

<div id="org248b5f3" class="figure">
<p><img src="../resources/os/SocketAPI.png" alt="SocketAPI.png" />
</p>
</div>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/types.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">socket</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">domain</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">type</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">protocol</span><span style="color: #3a81c3;">)</span>;

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">client-side</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">connect</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">clientifd</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr</span> *<span style="color: #715ab1;">addr</span>, <span style="color: #ba2f59; font-weight: bold;">socklen_t</span> <span style="color: #715ab1;">addrlen</span><span style="color: #3a81c3;">)</span>;

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">server-side</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">bind</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">sockfd</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr</span> *<span style="color: #715ab1;">addr</span>, <span style="color: #ba2f59; font-weight: bold;">socklen_t</span> <span style="color: #715ab1;">addrlen</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">listen</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">sockfd</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">backlog</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">accept</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">listenfd</span>, <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr</span> *<span style="color: #715ab1;">addr</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">addrlen</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
<ul class="org-ul">
<li>listen: The <code>listen</code> function converts sockfd from an active socket to a <i>listening socket</i></li>
</ul>
<p>
that can accept connection requests from clients.
</p>
<ul class="org-ul">
<li>accept: The <code>accept</code> function waits for a connection request from a client to arrive on</li>
</ul>
<p>
the listening descriptor <code>listenfd</code>, then fills in the client’s socket address in <code>addr</code>,
and returns a <i>connected descriptor</i>.
</p>
</div>

<div id="outline-container-org178b2df" class="outline-4">
<h4 id="org178b2df"><span class="section-number-4">9.5.1</span> <code>getaddrinfo</code></h4>
<div class="outline-text-4" id="text-9-5-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">netdb.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/types.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">getaddrinfo</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">host</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">service</span>,
		<span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">addrinfo</span> *<span style="color: #715ab1;">hints</span>, <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">addrinfo</span> **<span style="color: #715ab1;">result</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">freeaddrinfo</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">addrinfo</span> *<span style="color: #715ab1;">result</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">getnameinfo</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr</span> *<span style="color: #715ab1;">sa</span>, <span style="color: #ba2f59; font-weight: bold;">socklen_t</span> <span style="color: #715ab1;">salen</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">host</span>,
		<span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">hostlen</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">service</span>, <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">servlen</span>,
		<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">flags</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">reverse fn of getaddrinfo</span>

<span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #6c3163; font-weight: bold;">gai_strerror</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">errcode</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
<ul class="org-ul">
<li>service: service name(http, &#x2026;) or port no(decimal)</li>
<li>hints: see <code>man getaddrinfo</code>, use <code>memset</code> to initialize <i>hints</i></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-orgfa3b49f" class="outline-2">
<h2 id="orgfa3b49f"><span class="section-number-2">10</span> Concurrency</h2>
<div class="outline-text-2" id="text-10">
</div>
<div id="outline-container-org12b5df2" class="outline-3">
<h3 id="org12b5df2"><span class="section-number-3">10.1</span> Process</h3>
<div class="outline-text-3" id="text-10-1">
<ul class="org-ul">
<li>Scheduled and maintained by the kernel.</li>
<li>Have separate virtual address spaces.</li>
</ul>
</div>
</div>

<div id="outline-container-orgb5f2fa6" class="outline-3">
<h3 id="orgb5f2fa6"><span class="section-number-3">10.2</span> I/O Multiplexing</h3>
<div class="outline-text-3" id="text-10-2">
<ul class="org-ul">
<li>Scheduled by application itself.</li>
<li>Single process</li>
<li>All flows share the same address space.</li>
</ul>
</div>

<div id="outline-container-org9e0c039" class="outline-4">
<h4 id="org9e0c039"><span class="section-number-4">10.2.1</span> select</h4>
<div class="outline-text-4" id="text-10-2-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/select.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">select</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">n</span>, <span style="color: #ba2f59; font-weight: bold;">fd_set</span> *<span style="color: #715ab1;">fdset</span>, <span style="color: #4e3163;">NULL</span>, <span style="color: #4e3163;">NULL</span>, <span style="color: #4e3163;">NULL</span><span style="color: #3a81c3;">)</span>;

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">macros for manipulating descriptor sets</span>
<span style="color: #6c3163; font-weight: bold;">FD_ZERO</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">fd_set</span> *<span style="color: #715ab1;">fdset</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">clear all fds in fdset</span>
<span style="color: #6c3163; font-weight: bold;">FD_CLR</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>, <span style="color: #ba2f59; font-weight: bold;">fd_set</span> *<span style="color: #715ab1;">fdset</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">remove fd from fdset</span>
<span style="color: #6c3163; font-weight: bold;">FD_SET</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>, <span style="color: #ba2f59; font-weight: bold;">fd_set</span> *<span style="color: #715ab1;">fdset</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">add fd to fdset</span>
<span style="color: #6c3163; font-weight: bold;">FD_ISSET</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>, <span style="color: #ba2f59; font-weight: bold;">fd_set</span> *<span style="color: #715ab1;">fdset</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">is fd in fdset</span>
</pre>
</div>
<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/select.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> **<span style="color: #715ab1;">argv</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">fd_set</span> <span style="color: #715ab1;">read_set</span>, <span style="color: #715ab1;">ready_set</span>;
  FD_ZERO<span style="color: #6c3163;">(</span>&amp;read_set<span style="color: #6c3163;">)</span>;
  FD_SET<span style="color: #6c3163;">(</span>fd1, &amp;read_set<span style="color: #6c3163;">)</span>;
  FD_SET<span style="color: #6c3163;">(</span>fd2, &amp;read_set<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>True<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    ready_set = read_set;
    select<span style="color: #2d9574;">(</span>fd2 + 1, &amp;ready_set, <span style="color: #4e3163;">NULL</span>, <span style="color: #4e3163;">NULL</span>, <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>FD_ISSET<span style="color: #67b11d;">(</span>fd1, &amp;ready_set<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">...</span>
    <span style="color: #2d9574;">}</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>FD_ISSET<span style="color: #67b11d;">(</span>fd2, &amp;ready_set<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">//</span><span style="color: #2aa1ae; background-color: #ecf3ec;">...</span>
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org2b27348" class="outline-3">
<h3 id="org2b27348"><span class="section-number-3">10.3</span> Thread</h3>
<div class="outline-text-3" id="text-10-3">
<ul class="org-ul">
<li>Scheduled and maintained by the kernel.</li>
<li>All flows share the same address space.</li>
</ul>
</div>
<div id="outline-container-org18faff6" class="outline-4">
<h4 id="org18faff6"><span class="section-number-4">10.3.1</span> Thread Context</h4>
<div class="outline-text-4" id="text-10-3-1">
<p>
Includes a unique integer thread ID (TID), stack, stack pointer, program counter,
general-purpose registers, and condition codes.
</p>
<ul class="org-ul">
<li>much smaller than a process context</li>
</ul>
</div>
</div>

<div id="outline-container-org178e4eb" class="outline-4">
<h4 id="org178e4eb"><span class="section-number-4">10.3.2</span> Posix Interface(pthread)</h4>
<div class="outline-text-4" id="text-10-3-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #3a81c3; font-weight: bold;">typedef</span> <span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">func</span><span style="color: #3a81c3;">)(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">pthread_create</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pthread_t</span> *<span style="color: #715ab1;">tid</span>, <span style="color: #ba2f59; font-weight: bold;">pthread_attr_t</span> *<span style="color: #715ab1;">attr</span>, <span style="color: #ba2f59; font-weight: bold;">func</span> *<span style="color: #715ab1;">f</span>, <span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">arg</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">pthread_t</span> <span style="color: #6c3163; font-weight: bold;">pthread_self</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">returns the ID of the calling thread</span>

<span style="color: #ba2f59; font-weight: bold;">pthread_once_t</span> <span style="color: #715ab1;">once_control</span> = PTHREAD_ONCE_INIT;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">pthread_once</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pthread_once_t</span> *<span style="color: #715ab1;">once_control</span>,
		 <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163;">(</span>*<span style="color: #6c3163; font-weight: bold;">init_routine</span><span style="color: #6c3163;">)(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">pthread_exit</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">thread_return</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">pthread_cancel</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pthread_t</span> <span style="color: #715ab1;">tid</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">pthread_join</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pthread_t</span> <span style="color: #715ab1;">tid</span>, <span style="color: #ba2f59; font-weight: bold;">void</span> **<span style="color: #715ab1;">thread_return</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">pthread_detach</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pthread_t</span> <span style="color: #715ab1;">tid</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
</div>

<div id="outline-container-orgab8b268" class="outline-5">
<h5 id="orgab8b268"><span class="section-number-5">10.3.2.1</span> Initializing</h5>
<div class="outline-text-5" id="text-10-3-2-1">
<p>
The <code>pthread_once</code> function is useful whenever you need to dynamically
initialize global variables that are shared by multiple threads.
</p>
<ul class="org-ul">
<li>Only the first call to <code>pthread_once</code> invokes <code>init_routine</code></li>
</ul>
</div>
</div>

<div id="outline-container-org132547a" class="outline-5">
<h5 id="org132547a"><span class="section-number-5">10.3.2.2</span> Terminating</h5>
<div class="outline-text-5" id="text-10-3-2-2">
<ul class="org-ul">
<li>implicitly terminates when its top-level thread routine returns</li>
<li>call <code>pthread_exit</code> function</li>
<li>calls the Unix <code>exit</code> function, which terminates the process</li>
</ul>
<p>
and all threads associated with the process.
</p>
<ul class="org-ul">
<li>another thread calls <code>pthread_cancel</code> to terminate current thread</li>
</ul>
</div>
</div>

<div id="outline-container-org12b67f5" class="outline-5">
<h5 id="org12b67f5"><span class="section-number-5">10.3.2.3</span> Joining</h5>
<div class="outline-text-5" id="text-10-3-2-3">
<p>
Threads wait for other threads to terminate by calling the <code>pthread_join</code> function.
The <code>once_control</code> variable is a global or static variable that is always
initialized to <code>PTHREAD_ONCE_INIT</code>.
</p>
</div>
</div>

<div id="outline-container-org1137f23" class="outline-5">
<h5 id="org1137f23"><span class="section-number-5">10.3.2.4</span> Detaching</h5>
<div class="outline-text-5" id="text-10-3-2-4">
<p>
At any point in time, a thread is <i>joinable</i> or <i>detached</i>.
A <i>detached</i> thread cannot be reaped or killed by other threads.
A <i>joinable</i> thread's memory resources are not freed until it is reaped by another thread
or detached by a call to the <code>pthread_detach</code> function
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc9c6e91" class="outline-3">
<h3 id="orgc9c6e91"><span class="section-number-3">10.4</span> Synchronization</h3>
<div class="outline-text-3" id="text-10-4">
<p>
<code>count++</code> for asm code
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #6c3163; font-weight: bold;">movq</span> <span style="color: #3a81c3; font-weight: bold;">count</span><span style="color: #3a81c3;">(</span><span style="color: #715ab1;">%rip</span><span style="color: #3a81c3;">)</span>, <span style="color: #715ab1;">%rdx</span>
<span style="color: #6c3163; font-weight: bold;">addq</span> <span style="color: #3a81c3; font-weight: bold;">%eax</span>
<span style="color: #6c3163; font-weight: bold;">movq</span> <span style="color: #3a81c3; font-weight: bold;">%eax</span>, cnt<span style="color: #3a81c3;">(</span><span style="color: #715ab1;">%rip</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
<div id="outline-container-org347aa84" class="outline-4">
<h4 id="org347aa84"><span class="section-number-4">10.4.1</span> Semaphore</h4>
<div class="outline-text-4" id="text-10-4-1">
<p>
A semaphore <b>s</b> is a global variable with nonnegative integer value that can only
be manipulated by two special operations, called <code>P</code> and <code>V</code>
</p>
</div>

<div id="outline-container-org2ae7f26" class="outline-5">
<h5 id="org2ae7f26"><span class="section-number-5">10.4.1.1</span> P(s)</h5>
<div class="outline-text-5" id="text-10-4-1-1">
<p>
If <b>s</b> is nonzero, then <code>P</code> decrements <b>s</b> and returns immediately(atomic). If <b>s</b> is zero,
then suspend the thread until <b>s</b> becomes nonzero and the process is restarted
by a <code>V</code> operation. After restarting, the <code>P</code> operation decrements <b>s</b> and returns
control to the caller.
</p>
</div>
</div>

<div id="outline-container-orga9dc574" class="outline-5">
<h5 id="orga9dc574"><span class="section-number-5">10.4.1.2</span> V(s)</h5>
<div class="outline-text-5" id="text-10-4-1-2">
<p>
The <code>V</code> operation increments <b>s</b> by 1(atomic). If there are any threads blocked
at a <code>P</code> operation waiting for <b>s</b> to become nonzero, then the <code>V</code> operation
restarts exactly one of these threads, which then completes its <code>P</code> operation
by decrementing s.
</p>
</div>
</div>

<div id="outline-container-org43707fd" class="outline-5">
<h5 id="org43707fd"><span class="section-number-5">10.4.1.3</span> API</h5>
<div class="outline-text-5" id="text-10-4-1-3">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">semaphore.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sem_init</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sem_t</span> *<span style="color: #715ab1;">sem</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">pshared</span>, <span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">value</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sem_wait</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sem_t</span> *<span style="color: #715ab1;">s</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">P(s)</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sem_post</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sem_t</span> *<span style="color: #715ab1;">s</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">V(s)</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
</pre>
</div>
<ul class="org-ul">
<li>pshared: be shared between the threads, or between processes</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org6eb18a2" class="outline-4">
<h4 id="org6eb18a2"><span class="section-number-4">10.4.2</span> mutex</h4>
<div class="outline-text-4" id="text-10-4-2">
<p>
binary semaphore, value is 1 or 0
</p>
<ul class="org-ul">
<li>P(s): lock the mutex</li>
<li>V(s): unlock the mutex</li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">semaphore.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">sem_t</span> <span style="color: #715ab1;">mutex</span>;

sem_init<span style="color: #3a81c3;">(</span>&amp;mutex, 0, 1<span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">initialized by 1</span>

sem_wait<span style="color: #3a81c3;">(</span>&amp;mutex<span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">lock</span>
cnt++;
sem_post<span style="color: #3a81c3;">(</span>&amp;mutex<span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">unlock</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5283c8f" class="outline-4">
<h4 id="org5283c8f"><span class="section-number-4">10.4.3</span> Producer-Consumer Problem</h4>
<div class="outline-text-4" id="text-10-4-3">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">atomic</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">deque</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">iostream</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">semaphore.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">thread</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">vector</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">sem_t</span> <span style="color: #715ab1;">mutex</span>, <span style="color: #715ab1;">items</span>, <span style="color: #715ab1;">slots</span>;
<span style="color: #3a81c3; font-weight: bold;">constexpr</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">MAX_SLOTS</span> = 10;
<span style="color: #3a81c3; font-weight: bold;">constexpr</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">THREAD_COUNT</span> = 4;
<span style="color: #3a81c3; font-weight: bold;">constexpr</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">PRODUCER_LOOPS</span> = 10000;
<span style="color: #3a81c3; font-weight: bold;">constexpr</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">EXPECTED_SUM</span> = THREAD_COUNT * 49995000;
<span style="color: #4e3163;">std</span>::<span style="color: #ba2f59; font-weight: bold;">deque</span><span style="color: #3a81c3;">&lt;</span><span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">&gt;</span> <span style="color: #715ab1;">buf</span><span style="color: #3a81c3;">(</span>0, MAX_SLOTS<span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">produce</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">auto</span> <span style="color: #715ab1;">i</span> = 0; i &lt; PRODUCER_LOOPS; ++i<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    sem_wait<span style="color: #2d9574;">(</span>&amp;slots<span style="color: #2d9574;">)</span>;
    sem_wait<span style="color: #2d9574;">(</span>&amp;mutex<span style="color: #2d9574;">)</span>;
    buf.emplace_back<span style="color: #2d9574;">(</span>i<span style="color: #2d9574;">)</span>;
    sem_post<span style="color: #2d9574;">(</span>&amp;mutex<span style="color: #2d9574;">)</span>;
    sem_post<span style="color: #2d9574;">(</span>&amp;items<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">consume</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #4e3163;">std</span>::<span style="color: #ba2f59; font-weight: bold;">atomic</span><span style="color: #6c3163;">&lt;</span><span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #6c3163;">&gt;</span> <span style="color: #715ab1;">sum</span><span style="color: #6c3163;">{</span>0<span style="color: #6c3163;">}</span>;
  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span><span style="color: #4e3163;">true</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    sem_wait<span style="color: #2d9574;">(</span>&amp;items<span style="color: #2d9574;">)</span>;
    sem_wait<span style="color: #2d9574;">(</span>&amp;mutex<span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">auto</span> <span style="color: #715ab1;">i</span> = 0; i &lt; buf.size<span style="color: #67b11d;">()</span>; ++i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      sum += buf.front<span style="color: #67b11d;">()</span>;
      buf.pop_front<span style="color: #67b11d;">()</span>;
      sem_post<span style="color: #67b11d;">(</span>&amp;slots<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    sem_post<span style="color: #2d9574;">(</span>&amp;mutex<span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sum == EXPECTED_SUM<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #4e3163;">std</span>::cout &lt;&lt; sum &lt;&lt; <span style="color: #2d9574;">"\n"</span>;
      exit<span style="color: #67b11d;">(</span>EXIT_SUCCESS<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  sem_init<span style="color: #6c3163;">(</span>&amp;mutex, 0, 1<span style="color: #6c3163;">)</span>;
  sem_init<span style="color: #6c3163;">(</span>&amp;items, 0, 0<span style="color: #6c3163;">)</span>;
  sem_init<span style="color: #6c3163;">(</span>&amp;slots, 0, MAX_SLOTS<span style="color: #6c3163;">)</span>;

  <span style="color: #4e3163;">std</span>::<span style="color: #ba2f59; font-weight: bold;">vector</span><span style="color: #6c3163;">&lt;</span><span style="color: #4e3163;">std</span>::thread<span style="color: #6c3163;">&gt;</span> <span style="color: #715ab1;">producers</span>;
  <span style="color: #4e3163;">std</span>::<span style="color: #ba2f59; font-weight: bold;">vector</span><span style="color: #6c3163;">&lt;</span><span style="color: #4e3163;">std</span>::thread<span style="color: #6c3163;">&gt;</span> <span style="color: #715ab1;">consumers</span>;
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">auto</span> <span style="color: #715ab1;">i</span> = 0; i &lt; THREAD_COUNT; ++i<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    producers.emplace_back<span style="color: #2d9574;">(</span>produce<span style="color: #2d9574;">)</span>;
    consumers.emplace_back<span style="color: #2d9574;">(</span>consume<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">auto</span> &amp;<span style="color: #715ab1;">th</span> : producers<span style="color: #6c3163;">)</span>
    th.join<span style="color: #6c3163;">()</span>;
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">auto</span> &amp;<span style="color: #715ab1;">th</span> : consumers<span style="color: #6c3163;">)</span>
    th.join<span style="color: #6c3163;">()</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> 0;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3c76852" class="outline-4">
<h4 id="org3c76852"><span class="section-number-4">10.4.4</span> Readers-Writers Problem</h4>
<div class="outline-text-4" id="text-10-4-4">
</div>
<div id="outline-container-org9e25289" class="outline-5">
<h5 id="org9e25289"><span class="section-number-5">10.4.4.1</span> Reader favored</h5>
<div class="outline-text-5" id="text-10-4-4-1">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">atomic</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">chrono</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">iostream</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">semaphore.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">thread</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">vector</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #3a81c3; font-weight: bold;">using</span> <span style="color: #3a81c3; font-weight: bold;">namespace</span> <span style="color: #4e3163;">std</span>::<span style="color: #4e3163;">chrono_literals</span>;

<span style="color: #ba2f59; font-weight: bold;">sem_t</span> <span style="color: #715ab1;">mutex</span>, <span style="color: #715ab1;">readcnt_mu</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">readcnt</span> = 0;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">resource</span> = 0;
<span style="color: #3a81c3; font-weight: bold;">constexpr</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">THREAD_COUNT</span> = 4;
<span style="color: #3a81c3; font-weight: bold;">constexpr</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">WRITE_COUNT</span> = 1000;

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">read</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">out</span> = 0;
  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span><span style="color: #4e3163;">true</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    sem_wait<span style="color: #2d9574;">(</span>&amp;readcnt_mu<span style="color: #2d9574;">)</span>;
    readcnt++;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>readcnt == 1<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">first reader in</span>
      sem_wait<span style="color: #67b11d;">(</span>&amp;mutex<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    sem_post<span style="color: #2d9574;">(</span>&amp;readcnt_mu<span style="color: #2d9574;">)</span>;
    out = resource; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">read operation</span>
    sem_wait<span style="color: #2d9574;">(</span>&amp;readcnt_mu<span style="color: #2d9574;">)</span>;
    readcnt--;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>readcnt == 0<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      sem_post<span style="color: #67b11d;">(</span>&amp;mutex<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    sem_post<span style="color: #2d9574;">(</span>&amp;readcnt_mu<span style="color: #2d9574;">)</span>;
    <span style="color: #4e3163;">std</span>::<span style="color: #4e3163;">this_thread</span>::sleep_for<span style="color: #2d9574;">(</span>500ms<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">write</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">auto</span> <span style="color: #715ab1;">i</span> = 0; i &lt; WRITE_COUNT; ++i<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    sem_wait<span style="color: #2d9574;">(</span>&amp;mutex<span style="color: #2d9574;">)</span>;
    resource = i; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">write operation</span>
    sem_post<span style="color: #2d9574;">(</span>&amp;mutex<span style="color: #2d9574;">)</span>;
    <span style="color: #4e3163;">std</span>::<span style="color: #4e3163;">this_thread</span>::sleep_for<span style="color: #2d9574;">(</span>1s<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  sem_init<span style="color: #6c3163;">(</span>&amp;mutex, 0, 1<span style="color: #6c3163;">)</span>;
  sem_init<span style="color: #6c3163;">(</span>&amp;readcnt_mu, 0, 1<span style="color: #6c3163;">)</span>;

  <span style="color: #4e3163;">std</span>::<span style="color: #ba2f59; font-weight: bold;">vector</span><span style="color: #6c3163;">&lt;</span><span style="color: #4e3163;">std</span>::thread<span style="color: #6c3163;">&gt;</span> <span style="color: #715ab1;">readers</span>;
  <span style="color: #4e3163;">std</span>::<span style="color: #ba2f59; font-weight: bold;">vector</span><span style="color: #6c3163;">&lt;</span><span style="color: #4e3163;">std</span>::thread<span style="color: #6c3163;">&gt;</span> <span style="color: #715ab1;">writers</span>;
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">auto</span> <span style="color: #715ab1;">i</span> = 0; i &lt; THREAD_COUNT; ++i<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    readers.emplace_back<span style="color: #2d9574;">(</span>read<span style="color: #2d9574;">)</span>;
    writers.emplace_back<span style="color: #2d9574;">(</span>write<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">auto</span> &amp;<span style="color: #715ab1;">th</span> : readers<span style="color: #6c3163;">)</span>
    th.join<span style="color: #6c3163;">()</span>;
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">auto</span> &amp;<span style="color: #715ab1;">th</span> : writers<span style="color: #6c3163;">)</span>
    th.join<span style="color: #6c3163;">()</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> 0;
<span style="color: #3a81c3;">}</span>

</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
