<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-09-23 Thu 10:12 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pairs Trading</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="ChrisChen" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
	     margin-bottom: .2em; }
  .subtitle { text-align: center;
	      font-size: medium;
	      font-weight: bold;
	      margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
	    padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css">
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
	displayAlign: "left",
	displayIndent: "2em",

	"HTML-CSS": { scale: 100,
			linebreaks: { automatic: "false" },
			webFont: "TeX"
		       },
	SVG: {scale: 100,
	      linebreaks: { automatic: "false" },
	      font: "TeX"},
	NativeMML: {scale: 100},
	TeX: { equationNumbers: {autoNumber: "AMS"},
	       MultLineWidth: "85%",
	       TagSide: "left",
	       TagIndent: ".8em"
	     }
});
</script>
<script type="text/javascript"
	src="https://cdn.bootcdn.net/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Pairs Trading</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1bf9d00">1. Overview</a></li>
<li><a href="#orgcd5706a">2. Finding Pairs</a></li>
<li><a href="#orga77eb26">3. Mean Reversion</a>
<ul>
<li><a href="#orgf776ed2">3.1. Drift and Volatility</a></li>
</ul>
</li>
<li><a href="#org34339e3">4. Hedge Ratio</a></li>
<li><a href="#org8caf83a">5. Spread</a></li>
<li><a href="#orgca6a99f">6. Cointegration</a>
<ul>
<li><a href="#orgd10f70f">6.1. Cointegration \(\ne\) Correlation</a></li>
<li><a href="#org021a36b">6.2. Test for Checking Cointegration</a></li>
<li><a href="#orgf90a3b5">6.3. How to Find Cointegration Pairs</a></li>
</ul>
</li>
<li><a href="#orga3d5fd3">7. Signals</a>
<ul>
<li><a href="#org045054e">7.1. Defining Thresholds</a></li>
</ul>
</li>
<li><a href="#orgea03b36">8. Variations</a>
<ul>
<li><a href="#org8b9aa26">8.1. Group Pairs Trading</a></li>
</ul>
</li>
<li><a href="#org8659e0c">9. References</a></li>
<li><a href="#orgea59f49">10. To Learn</a></li>
</ul>
</div>
</div>

<div id="outline-container-org1bf9d00" class="outline-2">
<h2 id="org1bf9d00"><span class="section-number-2">1</span> Overview</h2>
<div class="outline-text-2" id="text-1">
<ol class="org-ol">
<li>Finding Pairs</li>
<li>Calculating Hedge Ratio</li>
<li>Calculating Spread</li>
<li>Is Spread Stationary?</li>
<li>If Yes, candidate for <b>Mean Reversion Trading</b>.</li>
<li>Choosing Thresholds for Spread</li>
<li>If Spread widens/narrows, short/long the spread.</li>
<li>Backtesting</li>
</ol>
</div>
</div>

<div id="outline-container-orgcd5706a" class="outline-2">
<h2 id="orgcd5706a"><span class="section-number-2">2</span> Finding Pairs</h2>
<div class="outline-text-2" id="text-2">
<p>
Finding the economic links
</p>
<ul class="org-ul">
<li>Government Policies</li>
<li>Customers and suppliers with in the same supply chain</li>
<li>Timezone Lag</li>
</ul>

<p>
Insights
</p>
<ul class="org-ul">
<li>Looking for a time lag</li>
</ul>

<p>
Checking
</p>
<ul class="org-ul">
<li>check if spread is stationary</li>
</ul>
</div>
</div>

<div id="outline-container-orga77eb26" class="outline-2">
<h2 id="orga77eb26"><span class="section-number-2">3</span> Mean Reversion</h2>
<div class="outline-text-2" id="text-3">
<p>
A mean reverting time series is one that tends to move back and forth around some constant value.
</p>
</div>
<div id="outline-container-orgf776ed2" class="outline-3">
<h3 id="orgf776ed2"><span class="section-number-3">3.1</span> Drift and Volatility</h3>
<div class="outline-text-3" id="text-3-1">
<p>
To describe a mean reverting process
</p>
<dl class="org-dl">
<dt>Drift Term</dt><dd>Long Term Average</dd>
<dt>Volatility Term</dt><dd>Randomness</dd>
</dl>

<p>
Formula:
\[dp_t=p_t\mu dt + p_t\sigma\epsilon\sqrt{dt}\]
</p>

<ul class="org-ul">
<li>\(dp_t\) represents the change in price over the time t</li>
<li>drift term \(p_t\mu dt\)
<ul class="org-ul">
<li>\(p_t\): current price</li>
<li>\(\mu\): a constant average mu</li>
<li>\(dt\): change in time</li>
</ul></li>
<li>volatility term \(p_t\sigma\epsilon\sqrt{dt}\)
<ul class="org-ul">
<li>\(p_t\): current price</li>
<li>\(\sigma\): a standard deviation sigma</li>
<li>\(\epsilon\): a random noise factor</li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org34339e3" class="outline-2">
<h2 id="org34339e3"><span class="section-number-2">4</span> Hedge Ratio</h2>
<div class="outline-text-2" id="text-4">
<p>
Two ways to calculate the hedge ratio
</p>
<ol class="org-ol">
<li>The Price Ratio \(\frac{B}{A}\): the price of stock B divided by the price of stock A</li>
<li>Run a Linear Regression \(B=\beta A + \alpha\)
<ul class="org-ul">
<li>Stock A is the independent variable.</li>
<li>Stock B is the dependent variable.</li>
<li>the coefficient \(\beta\) is the hedge ratio.</li>
</ul></li>
</ol>

<p>
The difference is that the regression accounts for a series of previous prices.
</p>
</div>
</div>

<div id="outline-container-org8caf83a" class="outline-2">
<h2 id="org8caf83a"><span class="section-number-2">5</span> Spread</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>B and A are prices of two assets.</li>
</ul>
<p>
\[Spread = B_{actual} - B_{estimate}\]
\[B_{estimate}=\beta A_{actual} + \alpha\]
</p>
<ul class="org-ul">
<li>\(\beta\) is the hedge ratio</li>
</ul>
</div>
</div>

<div id="outline-container-orgca6a99f" class="outline-2">
<h2 id="orgca6a99f"><span class="section-number-2">6</span> Cointegration</h2>
<div class="outline-text-2" id="text-6">
<p>
Two stocks \(y_t\sim I(1)\), \(x_t\sim I(1)\)
Try linear regression:
\[y_t\approx\beta x_t + \alpha\]
\[Spread = y_t - \beta x_t\]
\[Spread(with\_intercept) = y_t - (\alpha + \beta x_t)\]
</p>
<ul class="org-ul">
<li>If spread is stationary, then Spread is I(0) and x, y are cointegrated.</li>
<li>Hedge Ratio \(\beta\) is coefficient of cointegrated.</li>
</ul>
</div>

<div id="outline-container-orgd10f70f" class="outline-3">
<h3 id="orgd10f70f"><span class="section-number-3">6.1</span> Cointegration \(\ne\) Correlation</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>Cointegration means that, over a range of days, the <b>relative increase</b> in A is matched by a <b>relative increase</b> in B.</li>
<li>A strong positive correlation means when stock A moves up stock B moves up <b>at the same time</b> and vice versa. (not measure the <b>relative increase</b>)</li>
</ul>


<div id="orgbe48b15" class="figure">
<p><img src="../../resources/MOOC/Trading/correlation_vs_cointegration.png" alt="correlation_vs_cointegration.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org021a36b" class="outline-3">
<h3 id="org021a36b"><span class="section-number-3">6.2</span> Test for Checking Cointegration</h3>
<div class="outline-text-3" id="text-6-2">
</div>
<div id="outline-container-org452d47e" class="outline-4">
<h4 id="org452d47e">Two-Step Engle-Granger Test</h4>
<div class="outline-text-4" id="text-org452d47e">
<ol class="org-ol">
<li>Get hedge ratio from a linear regression
<ul class="org-ul">
<li>run a regression on one series against the other \(y_t=\beta x_t\)</li>
</ul></li>
<li>Create a new spread series \(z_t=y_t-\beta x_t\)</li>
<li>Check if spread \(z_t\) is stationary
<ul class="org-ul">
<li>if spread is stationary, the two series are cointegrated</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-orgb14ff03" class="outline-4">
<h4 id="orgb14ff03">Check If Spread is Stationary</h4>
<div class="outline-text-4" id="text-orgb14ff03">
<p>
Augmented Dickey-Fuller Test
</p>
<ul class="org-ul">
<li>\(pvalue\le 0.05\): spread is stationary</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Augmented Dickey Fuller Test</span>
<span style="color: #3a81c3; font-weight: bold;">from</span> statsmodels.tsa.stattools <span style="color: #3a81c3; font-weight: bold;">import</span> adfuller

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">adfuller(x, maxlag=None, regression='c', autolag='AIC', store=False, regresults=False)[source]</span>
<span style="color: #715ab1;">adf_result</span> = adfuller<span style="color: #3a81c3;">(</span>spread_series<span style="color: #3a81c3;">)</span>

<span style="color: #715ab1;">adf</span> = adf_result<span style="color: #3a81c3;">[</span>0<span style="color: #3a81c3;">]</span>
<span style="color: #715ab1;">pvalue</span> = adf_result<span style="color: #3a81c3;">[</span>1<span style="color: #3a81c3;">]</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf90a3b5" class="outline-3">
<h3 id="orgf90a3b5"><span class="section-number-3">6.3</span> How to Find Cointegration Pairs</h3>
<div class="outline-text-3" id="text-6-3">
<ul class="org-ul">
<li>Compare every pair of stocks in the universe: \(n\times n\) comparisons. (May use GPU)</li>
<li>Group stocks by sector, industry&#x2026;</li>
<li>Use <b>Clustering</b>, a class of unsupervised machine learning algorithms.
<ul class="org-ul">
<li>Inputs are time series.</li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orga3d5fd3" class="outline-2">
<h2 id="orga3d5fd3"><span class="section-number-2">7</span> Signals</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li><b>Principle: Buy Low Sell High</b>: Buy when it's on sale, and sell when it's overpriced.</li>
</ul>

<div id="orgce1d3a3" class="figure">
<p><img src="../../resources/MOOC/Trading/trade_pairs.png" alt="trade_pairs.png" />
</p>
</div>
<dl class="org-dl">
<dt>Short the Spread</dt><dd>Short the asset that has increased, long the asset that has decreased. (relatively).</dd>
<dt>Long the Spread</dt><dd>Short the asset that has increased, long the asset that has decreased.</dd>
</dl>
</div>

<div id="outline-container-org045054e" class="outline-3">
<h3 id="org045054e"><span class="section-number-3">7.1</span> Defining Thresholds</h3>
<div class="outline-text-3" id="text-7-1">
<p>
One way is to use the <b>Z-score</b> of the spread.
</p>
</div>
</div>
</div>

<div id="outline-container-orgea03b36" class="outline-2">
<h2 id="orgea03b36"><span class="section-number-2">8</span> Variations</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-org8b9aa26" class="outline-3">
<h3 id="org8b9aa26"><span class="section-number-3">8.1</span> Group Pairs Trading</h3>
<div class="outline-text-3" id="text-8-1">
<p>
If we grouped the stocks within the same industry into a virtual portfolio and calculated the return of that industry,
this portfolio return would represent the general expected movement of all stocks within the industry. Then, for each
individual stock series, we can calculate the spread between its return and the portfolio return. So when the spread
between the single stock and the industry changes significantly, we can use that as a signal to buy or sell.
</p>
</div>

<div id="outline-container-org03418a3" class="outline-4">
<h4 id="org03418a3"><b>Johansen Test</b></h4>
<div class="outline-text-4" id="text-org03418a3">
<p>
The <b>Johansen test</b> gives us coefficients that we can multiply to each of the stock series, so that a linear
combination produces a number.
\[w_1\times stock_1 + w_2\times stock_2 + w_3\times stock_3=spread\]
</p>

<p>
We get the historical average of the spread. Then we check if the spread deviates significantly from that average.
We check whether each of the three individual series moved up or down significantly to result in the change in spread.
We short the series that are relatively high, and long the series that are relatively low. To determine how much to
long or short, we again use the weights that are given by the Johansen test \((w_1, w_2, w_3)\)
</p>

<ul class="org-ul">
<li>Note that for the purpose of cointegration trading we use the original price series, and do not convert them to log returns.</li>
</ul>
</div>
</div>

<div id="outline-container-org755495c" class="outline-4">
<h4 id="org755495c">Example</h4>
<div class="outline-text-4" id="text-org755495c">
<p>
Let's say the spread has gotten larger. \(w_1=0.5\), \(w_2=0.3\), \(w_3=-0.1\)
</p>
<ul class="org-ul">
<li>proportions: 5 shares for \(stock_1\), 3 shares for \(stock_2\), 1 share for \(stock_3\)</li>
<li>If stock_1 stock is higher than usual (<b>relative to the others</b>), we short 5 shares of \(stock_1\)
because we expect it should revert by decreasing relative to the others.</li>
</ul>
</div>
</div>

<div id="outline-container-org2de0914" class="outline-4">
<h4 id="org2de0914">Details of Johansen Test</h4>
<div class="outline-text-4" id="text-org2de0914">
<ul class="org-ul">
<li>Lesson 15
<ul class="org-ul">
<li>13. Details of Johansen Test</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org8659e0c" class="outline-2">
<h2 id="org8659e0c"><span class="section-number-2">9</span> References</h2>
<div class="outline-text-2" id="text-9">
<ul class="org-ul">
<li>Lesson 15
<ul class="org-ul">
<li><a href="https://youtu.be/7lEm_tFXcBk">3. Pairs Trading</a></li>
<li><a href="https://youtu.be/N4ZI5SyFMOc">6. Cointegration</a></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgea59f49" class="outline-2">
<h2 id="orgea59f49"><span class="section-number-2">10</span> To Learn</h2>
<div class="outline-text-2" id="text-10">
<ul class="org-ul">
<li>Lesson 15
<ul class="org-ul">
<li>7. <b>ADF</b> and roots</li>
</ul></li>
</ul>
</div>
</div>
</div>
</body>
</html>
